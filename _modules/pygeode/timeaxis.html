
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>pygeode.timeaxis &#8212; PyGeode 1.4.1rc1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/pygtheme.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-binder.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-dataframe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-rendered-html.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../../_static/pygeode_icon.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
<link href="http://fonts.googleapis.com/css?family=Ubuntu:300,300italic,regular,italic,500,500italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='http://fonts.googleapis.com/css?family=Ubuntu+Mono:400,700' rel='stylesheet' type='text/css'>

  </head><body>
      <div class="header" role="banner"><img class="logo" src="../../_static/pygeode_logo.png" width=79px alt="Logo"/>
        <h1 class="heading"><a href="../../index.html">
          <span>PyGeode 1.4.1rc1 documentation</span></a></h1>
        <h2 class="heading"><span>pygeode.timeaxis</span></h2>
      </div>
      <div class="topnav" role="navigation" aria-label="top navigation">
      
        <p>
        <a class="uplink" href="../../reference.html">Reference</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../../tutorial.html">Tutorial</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../../gallery/index.html">Gallery</a>
        </p>

      </div>
      <div class="content">
        
        
  <h1>Source code for pygeode.timeaxis</h1><div class="highlight"><pre>
<span></span><span class="c1"># Time axis</span>

<span class="c1"># contains a relative time &#39;startdate&#39;, &#39;units&#39;, and &#39;values&#39; (units since xxx)</span>
<span class="c1"># also contains an absolute time, defined by certain auxiliary arrays</span>
<span class="c1"># (usually &#39;year&#39;, &#39;month&#39;, &#39;day&#39;, &#39;hour&#39;, &#39;minute&#39;, &#39;second&#39;)</span>
<span class="c1">#    NOTE: not all auxiliary fields are necessarily included, depending on the context of the time axis</span>

<span class="c1">#TODO: add &#39;weights&#39; array in &#39;uniquify&#39;, so the values for things such as monthly means</span>
<span class="c1">#      will be properly represented.  I.e.,if we then do an annual mean, we&#39;ll get the</span>
<span class="c1">#      same values as if we went directly from the instantaneous to annual mean.</span>


<span class="c1"># helper C extension (for things that numpy can&#39;t do easily)</span>
<span class="kn">from</span> <span class="nn">pygeode</span> <span class="kn">import</span> <span class="n">timeaxiscore</span> <span class="k">as</span> <span class="n">lib</span>

<span class="n">months</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Smarch&#39;</span><span class="p">,</span> <span class="s1">&#39;Jan&#39;</span><span class="p">,</span> <span class="s1">&#39;Feb&#39;</span><span class="p">,</span> <span class="s1">&#39;Mar&#39;</span><span class="p">,</span> <span class="s1">&#39;Apr&#39;</span><span class="p">,</span> <span class="s1">&#39;May&#39;</span><span class="p">,</span> <span class="s1">&#39;Jun&#39;</span><span class="p">,</span>
             <span class="s1">&#39;Jul&#39;</span><span class="p">,</span> <span class="s1">&#39;Aug&#39;</span><span class="p">,</span> <span class="s1">&#39;Sep&#39;</span><span class="p">,</span> <span class="s1">&#39;Oct&#39;</span><span class="p">,</span> <span class="s1">&#39;Nov&#39;</span><span class="p">,</span> <span class="s1">&#39;Dec&#39;</span><span class="p">]</span>
<span class="n">months_full</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Smarch&#39;</span><span class="p">,</span> <span class="s1">&#39;January&#39;</span><span class="p">,</span> <span class="s1">&#39;February&#39;</span><span class="p">,</span> <span class="s1">&#39;March&#39;</span><span class="p">,</span> <span class="s1">&#39;April&#39;</span><span class="p">,</span> <span class="s1">&#39;May&#39;</span><span class="p">,</span> <span class="s1">&#39;June&#39;</span><span class="p">,</span>
             <span class="s1">&#39;July&#39;</span><span class="p">,</span> <span class="s1">&#39;August&#39;</span><span class="p">,</span> <span class="s1">&#39;September&#39;</span><span class="p">,</span> <span class="s1">&#39;October&#39;</span><span class="p">,</span> <span class="s1">&#39;November&#39;</span><span class="p">,</span> <span class="s1">&#39;December&#39;</span><span class="p">]</span>



<span class="c1"># Given a list of fields,</span>
<span class="c1"># return the order of indices that will sort the fields chronologically.</span>
<span class="c1"># Assume the fields are ordered from slowest varying to fastest varying.</span>
<span class="k">def</span> <span class="nf">_argsort</span> <span class="p">(</span><span class="n">fields</span><span class="p">):</span>
  <span class="sd">&#39;&#39;&#39;return a list of indices that would sort the axis&#39;&#39;&#39;</span>
  <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
  <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;nothing to sort!&#39;</span>
  <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span> <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">),</span> <span class="s2">&quot;bad field&quot;</span>
  <span class="c1"># (lexsort uses the *last* column as the slowest varying key?)</span>
  <span class="n">fields</span> <span class="o">=</span> <span class="n">fields</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
  <span class="n">S</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">lexsort</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">S</span>


<span class="c1"># Take a list of fields (year, month, day, etc.) and return the fields with duplicates removed.</span>
<span class="c1"># NOTE: the fields are assumed to be pre-sorted</span>
<span class="k">def</span> <span class="nf">_uniquify</span> <span class="p">(</span><span class="n">fields</span><span class="p">):</span>
  <span class="kn">from</span> <span class="nn">pygeode</span> <span class="kn">import</span> <span class="n">timeutils</span>
  <span class="kn">from</span> <span class="nn">warnings</span> <span class="kn">import</span> <span class="n">warn</span>
  <span class="n">warn</span> <span class="p">(</span><span class="s2">&quot;Deprecated.  Use timeutils module.&quot;</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">timeutils</span><span class="o">.</span><span class="n">_uniquify</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span>



<span class="c1"># time axis</span>
<span class="c1">#</span>
<span class="c1"># Optional properties:</span>
<span class="c1">#   year, month, day, hour, minute, second, ms  (numpy arrays)</span>
<span class="c1">#     (note: any of these can be ommitted, if they&#39;re not applicable)</span>
<span class="c1">#     (i.e., a monthly mean time axis would not have day, hour, etc.)</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># (superclass; use one of the subclasses defined below)</span>
<span class="kn">from</span> <span class="nn">pygeode.axis</span> <span class="kn">import</span> <span class="n">TAxis</span>
<div class="viewcode-block" id="Time"><a class="viewcode-back" href="../../timeaxes.html#pygeode.timeaxis.Time">[docs]</a><span class="k">class</span> <span class="nc">Time</span> <span class="p">(</span><span class="n">TAxis</span><span class="p">):</span>
<span class="c1"># {{{</span>
  <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;time&#39;</span>
  <span class="n">plotatts</span> <span class="o">=</span> <span class="n">TAxis</span><span class="o">.</span><span class="n">plotatts</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
  <span class="n">plotatts</span><span class="p">[</span><span class="s1">&#39;plottitle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
  <span class="n">plotatts</span><span class="p">[</span><span class="s1">&#39;plotofsfmt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

  <span class="c1"># List of valid *possible* field names for this class.</span>
  <span class="c1"># Override in subclasses.</span>
  <span class="c1"># Note: not necessarily *all* of these fields may be defined in a given instance.</span>
  <span class="n">allowed_fields</span><span class="o">=</span><span class="p">()</span>

  <span class="c1"># Allow alternate construction(s) of the model time axis</span>
  <span class="c1"># Normal construction takes the explicit list of associated arrays</span>
  <span class="c1"># Alternatively, take a start date, list of offset values, and units</span>
<div class="viewcode-block" id="Time.__init__"><a class="viewcode-back" href="../../timeaxes.html#pygeode.timeaxis.Time.__init__">[docs]</a>  <span class="k">def</span> <span class="fm">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">startdate</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
  <span class="c1"># {{{</span>
    <span class="kn">from</span> <span class="nn">pygeode.axis</span> <span class="kn">import</span> <span class="n">TAxis</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
    <span class="kn">from</span> <span class="nn">warnings</span> <span class="kn">import</span> <span class="n">warn</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">==</span> <span class="n">Time</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Can&#39;t instantiate Time class directly.  Please use StandardTime or ModelTime365, or some other calendar-specific subclass&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">units</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;child constructor did not provide units&quot;</span>

    <span class="c1"># For the ultra-lazy:</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">values</span><span class="p">,</span><span class="nb">int</span><span class="p">):</span> <span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>

    <span class="c1"># Extract any auxiliary fields passed to us (i.e. year, month, etc.)</span>
    <span class="n">auxarrays</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([</span><span class="n">k</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">v</span><span class="p">)]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allowed_fields</span><span class="p">)</span>

    <span class="c1"># Generate absolute times from relative times?</span>
    <span class="k">if</span> <span class="n">auxarrays</span> <span class="o">==</span> <span class="p">{}:</span>
      <span class="k">assert</span> <span class="n">values</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;not enough information to construct a time axis&quot;</span>

      <span class="c1"># Get the associated arrays (year, month, day, etc. fields)</span>
      <span class="k">assert</span> <span class="n">startdate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;startdate required to generate the dates&quot;</span>
      <span class="n">auxarrays</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_as_date</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">values</span><span class="p">),</span> <span class="n">startdate</span><span class="o">=</span><span class="n">startdate</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">)</span>

    <span class="c1"># Determine the start date</span>
    <span class="c1"># (Keep the initial start date if one was given)</span>
    <span class="k">if</span> <span class="n">startdate</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">startdate</span> <span class="o">=</span> <span class="p">{}</span>
      <span class="k">for</span> <span class="n">aux</span><span class="p">,</span><span class="n">arr</span> <span class="ow">in</span> <span class="n">auxarrays</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">startdate</span><span class="p">[</span><span class="n">aux</span><span class="p">]</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Generate relative times from absolute times?</span>
    <span class="c1"># (redo the &#39;values&#39; array to be consistent with the absolute date/times)</span>
    <span class="c1"># (useful for example when concatenating vars along the time axis, when</span>
    <span class="c1">#  each var has a different start date (so the &#39;values&#39; being concatenated</span>
    <span class="c1">#  together are meaningless)</span>
    <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">date_as_val</span><span class="p">(</span><span class="n">auxarrays</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span> <span class="n">startdate</span><span class="o">=</span><span class="n">startdate</span><span class="p">)</span>
<span class="c1">#    if values is None:</span>
<span class="c1">#      values = self.date_as_val(auxarrays, units=units, startdate=startdate)</span>


    <span class="c1"># Put the auxiliary fields back into the keyword args, to pass them to the parent constructor</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">auxarrays</span><span class="o">.</span><span class="n">items</span><span class="p">():</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
    <span class="k">del</span> <span class="n">auxarrays</span>

    <span class="c1"># Call more general init to finalize things, and register the auxiliary fields with Axis</span>
    <span class="c1"># Also, pass the &#39;units&#39; through this interface so it&#39;s a known auxiliary attribute</span>
    <span class="c1"># (so it&#39;s automatically handled in the Axis class for things like subsetting, merging, etc.)</span>
    <span class="n">TAxis</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span> <span class="n">startdate</span><span class="o">=</span><span class="n">startdate</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="c1">#    TAxis.__init__(self, values, units=units, **kwargs)</span>

    <span class="c1"># Add these as direct references in the time axis (not just in auxatts)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">units</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">startdate</span> <span class="o">=</span> <span class="n">startdate</span></div>
  <span class="c1"># }}}</span>

<div class="viewcode-block" id="Time.formatter"><a class="viewcode-back" href="../../timeaxes.html#pygeode.timeaxis.Time.formatter">[docs]</a>  <span class="k">def</span> <span class="nf">formatter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
  <span class="c1"># {{{</span>
    <span class="sd">&#39;&#39;&#39; formatter()</span>
<span class="sd">        Returns a matplotlib axis Formatter object; by default a FuncFormatter which calls formatvalue(). &#39;&#39;&#39;</span>
    <span class="kn">from</span> <span class="nn">.timeticker</span> <span class="kn">import</span> <span class="n">TimeFormatter</span>
    <span class="k">return</span> <span class="n">TimeFormatter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fmt</span><span class="p">)</span></div>
  <span class="c1"># }}}</span>

<div class="viewcode-block" id="Time.locator"><a class="viewcode-back" href="../../timeaxes.html#pygeode.timeaxis.Time.locator">[docs]</a>  <span class="k">def</span> <span class="nf">locator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
  <span class="c1"># {{{</span>
    <span class="sd">&#39;&#39;&#39; locator() - Returns an AutoCalendarLocator object &#39;&#39;&#39;</span>
    <span class="kn">from</span> <span class="nn">.timeticker</span> <span class="kn">import</span> <span class="n">AutoCalendarLocator</span>
    <span class="k">return</span> <span class="n">AutoCalendarLocator</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>
  <span class="c1"># }}}</span>

  <span class="c1"># Comparison</span>
  <span class="k">def</span> <span class="fm">__eq__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
  <span class="c1"># {{{</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
    <span class="k">if</span> <span class="bp">self</span> <span class="ow">is</span> <span class="n">other</span><span class="p">:</span> <span class="k">return</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">type</span><span class="p">(</span><span class="n">other</span><span class="p">):</span> <span class="k">return</span> <span class="kc">False</span>
    <span class="c1"># Different fields?</span>
    <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">auxarrays</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">!=</span> <span class="nb">set</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">auxarrays</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span> <span class="k">return</span> <span class="kc">False</span>
    <span class="c1"># Different lengths?</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">other</span><span class="p">):</span> <span class="k">return</span> <span class="kc">False</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">auxarrays</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;how is date formed?&quot;</span>
    <span class="c1"># Different field values?</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">auxarrays</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">other</span><span class="o">.</span><span class="n">auxarrays</span><span class="p">[</span><span class="n">k</span><span class="p">]):</span> <span class="k">return</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="kc">True</span>
  <span class="c1"># }}}</span>

  <span class="c1">#TODO: remove this once Axis.map_to is set up to wrap self.common_map??</span>
<div class="viewcode-block" id="Time.map_to"><a class="viewcode-back" href="../../timeaxes.html#pygeode.timeaxis.Time.map_to">[docs]</a>  <span class="k">def</span> <span class="nf">map_to</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
  <span class="c1"># {{{</span>
    <span class="sd">&#39;&#39;&#39; Define a mapping between this time axis and another one, if one exists.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    other : :class:`Axis` instance</span>
<span class="sd">      Axis instance to find map to.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    indices : An array of integer indices or None</span>
<span class="sd">      If a mapping exists, an array of integer indices which define mapping</span>
<span class="sd">      from this axis to other (i.e. self[indices] will return the elements in</span>
<span class="sd">      the appropriate ordering for the mapped axis). Otherwise None.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    A mapping from this time axis to other can exist only if they are of the</span>
<span class="sd">    same class (e.g. :class:`StandardTime`), and if the list of auxarrays defined</span>
<span class="sd">    in this class is a subset of those defined in the other (e.g. a climatology which</span>
<span class="sd">    defines only &#39;month&#39;, and &#39;day&#39; can be mapped to a time axis with &#39;year&#39;, &#39;month&#39;</span>
<span class="sd">    &#39;day&#39; and &#39;hour&#39;, but not one with only &#39;year&#39; and &#39;month&#39;.</span>

<span class="sd">    Matches are sought between the auxiliary arrays shared by the two axes</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">type</span><span class="p">(</span><span class="n">other</span><span class="p">):</span> <span class="k">return</span> <span class="kc">None</span>
    <span class="c1">#isinstance(other,Time): return None</span>

    <span class="c1"># &quot;self&quot; attributes must be a subset of &quot;other&quot; attributes</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">auxarrays</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">&lt;=</span> <span class="nb">set</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">auxarrays</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
      <span class="k">return</span> <span class="kc">None</span>


    <span class="c1"># generate search arrays</span>
    <span class="n">self_f</span><span class="p">,</span> <span class="n">other_f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">common_fields</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">self_f</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
      <span class="kn">from</span> <span class="nn">warnings</span> <span class="kn">import</span> <span class="n">warn</span>
      <span class="n">warn</span> <span class="p">(</span><span class="s2">&quot;Time axis is poorly constructed (no actual time information is available); comparing the &#39;values&#39; array instead.&quot;</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
      <span class="n">myvalues</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span>
      <span class="n">othervalues</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">values</span>
      <span class="n">nfields</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">myvalues</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">self_f</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
      <span class="n">othervalues</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">other_f</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
      <span class="n">nfields</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">self_f</span><span class="p">)</span>

    <span class="n">isrt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="c1">#iinv = np.argsort(isrt)</span>

    <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">other</span><span class="p">),</span> <span class="s1">&#39;int32&#39;</span><span class="p">)</span>
    <span class="c1">#myvalues = np.ascontiguousarray(myvalues, dtype=&#39;int32&#39;)</span>
    <span class="n">myvalues</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">myvalues</span><span class="p">[</span><span class="n">isrt</span><span class="p">,</span> <span class="p">:],</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int32&#39;</span><span class="p">)</span>
    <span class="n">othervalues</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">othervalues</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int32&#39;</span><span class="p">)</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">get_indices</span> <span class="p">(</span><span class="n">nfields</span><span class="p">,</span> <span class="n">myvalues</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">myvalues</span><span class="p">),</span>
                           <span class="n">othervalues</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">othervalues</span><span class="p">),</span>
                           <span class="n">indices</span><span class="p">)</span>

<span class="c1">#    print othervalues, &quot;map_to&quot;, myvalues, &quot;=&gt;&quot;, indices</span>
    <span class="k">assert</span> <span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="c1"># filter out mismatched values</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[</span><span class="n">indices</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">]</span>
<span class="c1">#    # We should have found a match, or something is wrong?</span>
<span class="c1">#    assert len(indices) &gt; 0, &quot;failed to map %s to %s&quot;%(self,other)</span>
    <span class="c1"># It&#39;s ok to not have a match</span>
    <span class="c1">#return indices</span>
    <span class="k">return</span> <span class="n">isrt</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span></div>
  <span class="c1"># }}}</span>

  <span class="k">def</span> <span class="nf">common_map</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
<span class="c1"># {{{</span>
    <span class="sd">&#39;&#39;&#39;return the indices that map common elements from one time axis to another&#39;&#39;&#39;</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="c1">#    print &#39;common_map:&#39;</span>
<span class="c1">#    print self</span>
<span class="c1">#    print other</span>
    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">isparentof</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="ow">or</span> <span class="n">other</span><span class="o">.</span><span class="n">isparentof</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="n">self_f</span><span class="p">,</span> <span class="n">other_f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">common_fields</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">self_f</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="n">na</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="n">nb</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
    <span class="c1"># Create the input arrays</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">self_f</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">other_f</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
    <span class="c1"># Get the sort order, with the common fields</span>
    <span class="n">a_ind</span> <span class="o">=</span> <span class="n">_argsort</span><span class="p">(</span><span class="n">self_f</span><span class="p">)</span>
    <span class="n">b_ind</span> <span class="o">=</span> <span class="n">_argsort</span><span class="p">(</span><span class="n">other_f</span><span class="p">)</span>
    <span class="c1"># Sort the arrays</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">a_ind</span><span class="p">,:],</span><span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int32&#39;</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="n">b_ind</span><span class="p">,:],</span><span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int32&#39;</span><span class="p">)</span>
    <span class="c1"># Outputs</span>
    <span class="n">nmap</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">na</span><span class="p">,</span><span class="n">nb</span><span class="p">)</span>
    <span class="n">a_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">nmap</span><span class="p">,</span> <span class="s1">&#39;int32&#39;</span><span class="p">)</span>
    <span class="n">b_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">nmap</span><span class="p">,</span> <span class="s1">&#39;int32&#39;</span><span class="p">)</span>

    <span class="c1"># Call the C routine</span>
    <span class="n">nmap</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">common_map</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">self_f</span><span class="p">),</span> <span class="n">na</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">nb</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">a_map</span><span class="p">,</span> <span class="n">b_map</span><span class="p">)</span>

    <span class="c1"># filter out unmapped indices</span>
    <span class="n">a_map</span> <span class="o">=</span> <span class="n">a_map</span><span class="p">[:</span><span class="n">nmap</span><span class="p">]</span>
    <span class="n">b_map</span> <span class="o">=</span> <span class="n">b_map</span><span class="p">[:</span><span class="n">nmap</span><span class="p">]</span>
    <span class="c1"># convert the indices from being relative to sort order to the original order</span>
    <span class="n">a_map</span> <span class="o">=</span> <span class="n">a_ind</span><span class="p">[</span><span class="n">a_map</span><span class="p">]</span>
    <span class="n">b_map</span> <span class="o">=</span> <span class="n">b_ind</span><span class="p">[</span><span class="n">b_map</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">a_map</span><span class="p">,</span> <span class="n">b_map</span>
<span class="c1"># }}}</span>

  <span class="c1"># Find common fields between two time axes.</span>
  <span class="c1"># Returns two lists - a list of arrays for the first axis, and a similar list for the second axis.</span>
  <span class="c1"># Only the fields that are common between the two axes are returned.</span>
  <span class="c1"># NOTE: does not compare the *values* of the fields, just the field names</span>
  <span class="c1"># (use &#39;common_map&#39; to compare the values)</span>
  <span class="k">def</span> <span class="nf">common_fields</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
<span class="c1"># {{{</span>
    <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="n">other</span><span class="p">),</span> <span class="s2">&quot;axes are incompatible: </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span><span class="nb">type</span><span class="p">(</span><span class="n">other</span><span class="p">))</span>
    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">allowed_fields</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">allowed_fields</span>  <span class="c1"># should be true if the above is true</span>
    <span class="n">fnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allowed_fields</span> <span class="k">if</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">auxarrays</span> <span class="ow">and</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="n">auxarrays</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">auxarrays</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fnames</span><span class="p">],</span> <span class="p">[</span><span class="n">other</span><span class="o">.</span><span class="n">auxarrays</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fnames</span><span class="p">]</span>
<span class="c1"># }}}</span>

  <span class="c1"># Mask out certain fields from a time axis</span>
  <span class="c1"># resolution: maximum resolution of the output &#39;day&#39;, &#39;hour&#39;, &#39;year&#39;, etc.)</span>
  <span class="c1"># exclude: list of fields to remove (i.e. mask out &#39;year&#39; when making a climatology axis)</span>
  <span class="c1"># include: explicit list of fields to include (everything else is excluded)</span>
  <span class="k">def</span> <span class="nf">modify</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="p">[],</span> <span class="n">include</span><span class="o">=</span><span class="p">[],</span> <span class="n">uniquify</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">pygeode</span> <span class="kn">import</span> <span class="n">timeutils</span>
    <span class="kn">from</span> <span class="nn">warnings</span> <span class="kn">import</span> <span class="n">warn</span>
    <span class="n">warn</span> <span class="p">(</span><span class="s2">&quot;Deprecated.  Use timeutils module.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">timeutils</span><span class="o">.</span><span class="n">modify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resolution</span><span class="p">,</span> <span class="n">exclude</span><span class="p">,</span> <span class="n">include</span><span class="p">,</span> <span class="n">uniquify</span><span class="p">)</span>


  <span class="c1"># Get a relative time array with the given parameters</span>
  <span class="k">def</span> <span class="nf">reltime</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">startdate</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">pygeode</span> <span class="kn">import</span> <span class="n">timeutils</span>
    <span class="kn">from</span> <span class="nn">warnings</span> <span class="kn">import</span> <span class="n">warn</span>
    <span class="n">warn</span> <span class="p">(</span><span class="s2">&quot;Deprecated.  Use timeutils module.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">timeutils</span><span class="o">.</span><span class="n">reltime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">units</span><span class="p">)</span>

  <span class="c1"># Get time increment</span>
  <span class="c1"># Units: day, hour, minute, second</span>
  <span class="k">def</span> <span class="nf">delta</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">pygeode</span> <span class="kn">import</span> <span class="n">timeutils</span>
    <span class="kn">from</span> <span class="nn">warnings</span> <span class="kn">import</span> <span class="n">warn</span>
    <span class="n">warn</span> <span class="p">(</span><span class="s2">&quot;Deprecated.  Use timeutils module.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">timeutils</span><span class="o">.</span><span class="n">delta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">units</span><span class="p">)</span>

  <span class="c1"># Helper function; normalizes date object so that all fields are within the standard range</span>
  <span class="k">def</span> <span class="nf">wrapdate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">allfields</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">pygeode</span> <span class="kn">import</span> <span class="n">timeutils</span>
    <span class="kn">from</span> <span class="nn">warnings</span> <span class="kn">import</span> <span class="n">warn</span>
    <span class="n">warn</span> <span class="p">(</span><span class="s2">&quot;Deprecated.  Use timeutils module.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">timeutils</span><span class="o">.</span><span class="n">wrapdate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">allfields</span><span class="p">)</span>

  <span class="c1"># Helper function; returns time between two dates in specified units</span>
  <span class="k">def</span> <span class="nf">date_diff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt1</span><span class="p">,</span> <span class="n">dt2</span><span class="p">,</span> <span class="n">units</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">pygeode</span> <span class="kn">import</span> <span class="n">timeutils</span>
    <span class="kn">from</span> <span class="nn">warnings</span> <span class="kn">import</span> <span class="n">warn</span>
    <span class="n">warn</span> <span class="p">(</span><span class="s2">&quot;Deprecated.  Use timeutils module.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">timeutils</span><span class="o">.</span><span class="n">date_diff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt1</span><span class="p">,</span> <span class="n">dt2</span><span class="p">,</span> <span class="n">units</span><span class="p">)</span></div>

<span class="c1"># }}}</span>
<span class="k">del</span> <span class="n">TAxis</span>


<span class="c1"># A subclass of time axis which is calendar-aware</span>
<span class="c1"># (i.e., has a notion of years, months, days, etc.)</span>
<span class="c1"># Any time axis that references years, seconds, etc. is a subclass of this.</span>
<div class="viewcode-block" id="CalendarTime"><a class="viewcode-back" href="../../timeaxes.html#pygeode.timeaxis.CalendarTime">[docs]</a><span class="k">class</span> <span class="nc">CalendarTime</span><span class="p">(</span><span class="n">Time</span><span class="p">):</span>
<span class="c1"># {{{</span>

  <span class="c1"># Format of time axis used for str/repr functions</span>
  <span class="n">formatstr</span> <span class="o">=</span> <span class="s1">&#39;$b $d, $Y $H:$M:$S&#39;</span>
  <span class="n">autofmts</span> <span class="o">=</span> <span class="p">[(</span><span class="mf">365.</span><span class="p">,</span> <span class="s1">&#39;$Y&#39;</span><span class="p">,</span>        <span class="s1">&#39;&#39;</span><span class="p">),</span>   <span class="c1"># Range larger than 1 year</span>
          <span class="p">(</span><span class="mf">30.</span> <span class="p">,</span> <span class="s1">&#39;$d $b $Y&#39;</span><span class="p">,</span>     <span class="s1">&#39;&#39;</span><span class="p">),</span>   <span class="c1"># Larger than 1 month</span>
          <span class="p">(</span><span class="mf">1.</span><span class="p">,</span> <span class="s1">&#39;$d $b&#39;</span><span class="p">,</span>     <span class="s1">&#39;$Y&#39;</span><span class="p">),</span> <span class="c1"># Larger than 1 day</span>
          <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mf">24.</span><span class="p">,</span> <span class="s1">&#39;$H:$M&#39;</span><span class="p">,</span>     <span class="s1">&#39;$d $b $Y&#39;</span><span class="p">),</span>  <span class="c1"># Larger than 1 hour</span>
          <span class="p">(</span><span class="mf">0.</span>  <span class="p">,</span> <span class="s1">&#39;$H:$M:$S&#39;</span><span class="p">,</span>  <span class="s1">&#39;$d $b $Y&#39;</span><span class="p">)]</span> <span class="c1"># Less than 1 hour</span>

  <span class="c1"># Regular expression used to parse times</span>
  <span class="n">parse_patterns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;((?P&lt;hour&gt;\d{1,2}):(?P&lt;minute&gt;\d</span><span class="si">{2}</span><span class="s1">)(\s|:(?P&lt;second&gt;\d</span><span class="si">{2}</span><span class="s1">))|^)(?P&lt;day&gt;\d{1,2}) (?P&lt;month&gt;[a-zA-Z]+) (?P&lt;year&gt;\d+)&#39;</span><span class="p">]</span>

  <span class="n">allowed_fields</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;month&#39;</span><span class="p">,</span> <span class="s1">&#39;day&#39;</span><span class="p">,</span> <span class="s1">&#39;hour&#39;</span><span class="p">,</span> <span class="s1">&#39;minute&#39;</span><span class="p">,</span> <span class="s1">&#39;second&#39;</span><span class="p">)</span>

  <span class="c1"># Conversion factor for going from one unit to another</span>
  <span class="n">unitfactor</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;seconds&#39;</span><span class="p">:</span><span class="mf">1.</span><span class="p">,</span> <span class="s1">&#39;minutes&#39;</span><span class="p">:</span><span class="mf">60.</span><span class="p">,</span> <span class="s1">&#39;hours&#39;</span><span class="p">:</span><span class="mf">3600.</span><span class="p">,</span> <span class="s1">&#39;days&#39;</span><span class="p">:</span><span class="mf">86400.</span><span class="p">}</span>

  <span class="c1"># Overrides init to allow some special construction methods</span>
<div class="viewcode-block" id="CalendarTime.__init__"><a class="viewcode-back" href="../../timeaxes.html#pygeode.timeaxis.CalendarTime.__init__">[docs]</a>  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">datefmt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">startdate</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="c1"># {{{</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">timeticker</span> <span class="k">as</span> <span class="n">tt</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
    <span class="kn">from</span> <span class="nn">warnings</span> <span class="kn">import</span> <span class="n">warn</span>

    <span class="n">tg</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="s1">&#39;year&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allowed_fields</span><span class="p">:</span>
      <span class="n">tg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tt</span><span class="o">.</span><span class="n">YearTickGen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">[</span><span class="mi">500</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]))</span>
    <span class="k">if</span> <span class="s1">&#39;year&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allowed_fields</span> <span class="ow">and</span> <span class="s1">&#39;month&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allowed_fields</span><span class="p">:</span>
      <span class="n">tg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tt</span><span class="o">.</span><span class="n">MonthTickGen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]))</span>
    <span class="k">if</span> <span class="s1">&#39;year&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allowed_fields</span> <span class="ow">and</span> <span class="s1">&#39;month&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allowed_fields</span> <span class="ow">and</span> <span class="s1">&#39;day&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allowed_fields</span><span class="p">:</span>
      <span class="n">tg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tt</span><span class="o">.</span><span class="n">DayOfMonthTickGen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">[</span><span class="mi">15</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]))</span>
    <span class="n">tg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tt</span><span class="o">.</span><span class="n">HourTickGen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">[</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]))</span>
    <span class="n">tg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tt</span><span class="o">.</span><span class="n">MinuteTickGen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">[</span><span class="mi">30</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]))</span>
    <span class="n">tg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tt</span><span class="o">.</span><span class="n">SecondTickGen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">[</span><span class="mi">30</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tick_generators</span> <span class="o">=</span> <span class="n">tg</span>

    <span class="c1"># Fill in default values for start date</span>
    <span class="k">if</span> <span class="n">startdate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">default</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">day</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">hour</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">minute</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">second</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
      <span class="c1"># Only use the allowed fields for this (sub)class</span>
      <span class="n">default</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">default</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allowed_fields</span><span class="p">)</span>
      <span class="n">startdate</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">default</span><span class="p">,</span> <span class="o">**</span><span class="n">startdate</span><span class="p">)</span>
      <span class="c1">#for k in startdate.iterkeys():</span>
        <span class="c1">#assert k in self.allowed_fields, &quot;%s is not an allowed field for %s&quot;%(k,type(self))</span>
      <span class="c1"># If any auxiliary arrays are provided, then use only those fields</span>
      <span class="k">if</span> <span class="nb">any</span> <span class="p">(</span><span class="n">a</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allowed_fields</span><span class="p">):</span>
        <span class="n">startdate</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">startdate</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="ow">and</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allowed_fields</span><span class="p">)</span>

    <span class="c1"># Construct date from encoded values?</span>
    <span class="c1">#TODO: more cases, like yyyymmdd.hh?</span>
    <span class="k">if</span> <span class="n">values</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">datefmt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">datefmt</span> <span class="o">=</span> <span class="n">datefmt</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
      <span class="n">date</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="s1">&#39;int64&#39;</span><span class="p">)</span>
      <span class="c1"># Defaults</span>
      <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">date</span><span class="p">)</span>
      <span class="n">one</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
      <span class="n">zero</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
      <span class="n">default</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="n">zero</span><span class="p">,</span><span class="n">month</span><span class="o">=</span><span class="n">one</span><span class="p">,</span><span class="n">day</span><span class="o">=</span><span class="n">one</span><span class="p">,</span><span class="n">hour</span><span class="o">=</span><span class="n">zero</span><span class="p">,</span><span class="n">minute</span><span class="o">=</span><span class="n">zero</span><span class="p">,</span><span class="n">second</span><span class="o">=</span><span class="n">zero</span><span class="p">)</span>
      <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">default</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">datefmt</span> <span class="o">==</span> <span class="s1">&#39;yyyymmddhh&#39;</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">],</span> <span class="n">date</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="mi">1000000</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;month&#39;</span><span class="p">],</span> <span class="n">date</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="mi">10000</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;day&#39;</span><span class="p">],</span> <span class="n">date</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;hour&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">date</span>
      <span class="k">elif</span> <span class="n">datefmt</span> <span class="o">==</span> <span class="s1">&#39;yyyymmdd&#39;</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">],</span> <span class="n">date</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="mi">10000</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;month&#39;</span><span class="p">],</span> <span class="n">date</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;day&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">date</span>
      <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span> <span class="p">(</span><span class="s2">&quot;unrecognized date format &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="o">%</span><span class="n">datefmt</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">values</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">units</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="c1">#      raise Exception (&quot;Don&#39;t know what units to use for the given values&quot;)</span>
      <span class="c1"># This can happen during concatenation - mismatched units may be dropped in concat(), so as a workaround, we ignore the values array and hope we have good auxarrays</span>
      <span class="n">warn</span> <span class="p">(</span><span class="s2">&quot;No units available for the given relative values.  Ignoring values array and relying on absolute date fields for initialization.&quot;</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
      <span class="n">values</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">units</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">warn</span> <span class="p">(</span><span class="s2">&quot;No units given, using default of &#39;days&#39;&quot;</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
      <span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;days&#39;</span>

    <span class="k">if</span> <span class="n">units</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">unitfactor</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;units (&quot;</span><span class="si">%s</span><span class="s1">&quot;) must be one of the following: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">units</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unitfactor</span><span class="o">.</span><span class="n">keys</span><span class="p">())))</span>

    <span class="k">return</span> <span class="n">Time</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="n">values</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span> <span class="n">startdate</span><span class="o">=</span><span class="n">startdate</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
<span class="c1"># }}}</span>

  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">_readaxisconfig</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">ax</span><span class="p">):</span>
  <span class="c1"># {{{</span>
    <span class="kn">from</span> <span class="nn">pygeode</span> <span class="kn">import</span> <span class="n">_config</span><span class="p">,</span> <span class="n">Axis</span>

    <span class="n">Time</span><span class="o">.</span><span class="n">_readaxisconfig</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_opt</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
      <span class="c1"># Return option for nearest class in inheritance hierarchy</span>
      <span class="c1"># for which it is defined</span>
      <span class="n">c</span> <span class="o">=</span> <span class="bp">cls</span>
      <span class="n">nm</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="vm">__name__</span>
      <span class="k">while</span> <span class="n">c</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">Time</span><span class="p">:</span>
        <span class="n">opt</span> <span class="o">=</span> <span class="n">nm</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">p</span>
        <span class="k">if</span> <span class="n">_config</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s1">&#39;Axes&#39;</span><span class="p">,</span>  <span class="n">opt</span><span class="p">):</span>
          <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Axes&#39;</span><span class="p">,</span> <span class="n">opt</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
          <span class="n">nm</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="vm">__name__</span>
      <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># Read in parse pattern for time strings</span>
    <span class="n">patt</span> <span class="o">=</span> <span class="n">get_opt</span><span class="p">(</span><span class="s1">&#39;parse_patterns&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">patt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">pts</span> <span class="o">=</span> <span class="n">patt</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
      <span class="n">pts</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">patt</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
      <span class="nb">setattr</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="s1">&#39;parse_patterns&#39;</span><span class="p">,</span> <span class="n">pts</span><span class="p">)</span>
  <span class="c1"># }}}</span>

  <span class="c1"># Day-of-year calculator</span>
  <span class="c1"># (for formatvalue)</span>
  <span class="k">def</span> <span class="nf">_getdoy</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date</span><span class="p">):</span>
<span class="c1"># {{{</span>
    <span class="n">startdate</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;month&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;day&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;hour&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;minute&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;second&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">}</span>
    <span class="n">date</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">date_as_val</span> <span class="p">(</span><span class="n">dates</span><span class="o">=</span><span class="n">date</span><span class="p">,</span> <span class="n">startdate</span><span class="o">=</span><span class="n">startdate</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;days&#39;</span><span class="p">)</span>
<span class="c1"># }}}</span>

  <span class="c1"># Number of days in a month</span>
  <span class="c1"># Required by timeticker</span>
<div class="viewcode-block" id="CalendarTime.days_in_month"><a class="viewcode-back" href="../../timeaxes.html#pygeode.timeaxis.CalendarTime.days_in_month">[docs]</a>  <span class="k">def</span> <span class="nf">days_in_month</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">yr</span><span class="p">,</span> <span class="n">mn</span><span class="p">):</span>
  <span class="c1"># {{{</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">date_as_val</span><span class="p">(</span><span class="n">startdate</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;year&#39;</span><span class="p">:</span><span class="n">yr</span><span class="p">,</span><span class="s1">&#39;month&#39;</span><span class="p">:</span><span class="n">mn</span><span class="p">},</span>
                            <span class="n">dates</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;year&#39;</span><span class="p">:</span><span class="n">yr</span><span class="p">,</span><span class="s1">&#39;month&#39;</span><span class="p">:</span><span class="n">mn</span><span class="o">+</span><span class="mi">1</span><span class="p">},</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;days&#39;</span><span class="p">)</span></div>
  <span class="c1"># }}}</span>

<div class="viewcode-block" id="CalendarTime.formatvalue"><a class="viewcode-back" href="../../timeaxes.html#pygeode.timeaxis.CalendarTime.formatvalue">[docs]</a>  <span class="k">def</span> <span class="nf">formatvalue</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">unitstr</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
  <span class="c1"># {{{</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Returns formatted string representation of ``value``, using a strftime-like</span>
<span class="sd">    specification.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    value : float or int</span>
<span class="sd">      Value to format, in calendar defined by this time axis.</span>
<span class="sd">    fmt : string (optional)</span>
<span class="sd">      Format specification. If the default ``None`` is specified,</span>
<span class="sd">      ``self.formatstr`` is used.</span>
<span class="sd">    units : boolean (optional)</span>
<span class="sd">      Not used;, included for consistency with :func:`Var.formatvalue`</span>
<span class="sd">    unitstr : string (optional)</span>
<span class="sd">      Not used;, included for consistency with :func:`Var.formatvalue`</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The following codes ($$ will yield the character $):</span>

<span class="sd">    * $b - short month name</span>
<span class="sd">    * $B - full month name</span>
<span class="sd">    * $d - day of the month</span>
<span class="sd">    * $D - 2-digit day of the month, zero-padded</span>
<span class="sd">    * $H - hour (24 hr clock)</span>
<span class="sd">    * $I - hour (12 hr clock)</span>
<span class="sd">    * $j - day of the year</span>
<span class="sd">    * $m - month number (Jan=1, ..., Dec=12)</span>
<span class="sd">    * $M - minute</span>
<span class="sd">    * $p - am/pm</span>
<span class="sd">    * $P - AM/PM</span>
<span class="sd">    * $S - second</span>
<span class="sd">    * $y - 2 digit year</span>
<span class="sd">    * $a - 4 digit year</span>
<span class="sd">    * $Y - full year; if less than 100, preceeded by &#39;y&#39;</span>
<span class="sd">    * $v - value formatted with %d</span>
<span class="sd">    * $V - value formatted with str()</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; from pygeode.tutorial import t2</span>
<span class="sd">    &gt;&gt;&gt; print(t2.time.formatvalue(17.25))</span>
<span class="sd">    Jan 18, 2011 06:00:00</span>
<span class="sd">    &gt;&gt;&gt; print(t2.time.formatvalue(0, &#39;$B $d&#39;))</span>
<span class="sd">    January 1</span>
<span class="sd">    &gt;&gt;&gt; print(t2.time.formatvalue(512, &#39;$d/$m/$y&#39;))</span>
<span class="sd">    28/5/12</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
    <span class="kn">from</span> <span class="nn">string</span> <span class="kn">import</span> <span class="n">Template</span>

    <span class="n">dt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_as_date</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="n">subs</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Build substitution dictionary</span>
    <span class="k">if</span> <span class="s1">&#39;year&#39;</span> <span class="ow">in</span> <span class="n">dt</span><span class="p">:</span>
      <span class="n">y</span> <span class="o">=</span> <span class="n">dt</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span>
      <span class="n">subs</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%02d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">y</span> <span class="o">%</span> <span class="mi">100</span><span class="p">)</span>
      <span class="n">subs</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">y</span>
      <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
        <span class="n">subs</span><span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;y</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">y</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">subs</span><span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">y</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">subs</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">],</span> <span class="n">subs</span><span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>

    <span class="k">if</span> <span class="s1">&#39;month&#39;</span> <span class="ow">in</span> <span class="n">dt</span><span class="p">:</span>
      <span class="n">mi</span> <span class="o">=</span> <span class="n">dt</span><span class="p">[</span><span class="s1">&#39;month&#39;</span><span class="p">]</span>
      <span class="n">subs</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">months</span><span class="p">[</span><span class="n">mi</span><span class="p">]</span>
      <span class="n">subs</span><span class="p">[</span><span class="s1">&#39;B&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">months_full</span><span class="p">[</span><span class="n">mi</span><span class="p">]</span>
      <span class="n">subs</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mi</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">mi</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="n">subs</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">],</span> <span class="n">subs</span><span class="p">[</span><span class="s1">&#39;B&#39;</span><span class="p">],</span> <span class="n">subs</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>

    <span class="k">if</span> <span class="s1">&#39;day&#39;</span> <span class="ow">in</span> <span class="n">dt</span><span class="p">:</span>
      <span class="n">d</span> <span class="o">=</span> <span class="n">dt</span><span class="p">[</span><span class="s1">&#39;day&#39;</span><span class="p">]</span>
      <span class="n">subs</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">d</span>
      <span class="n">subs</span><span class="p">[</span><span class="s1">&#39;D&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%02d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">d</span>
      <span class="k">if</span> <span class="s1">&#39;year&#39;</span> <span class="ow">in</span> <span class="n">dt</span> <span class="ow">and</span> <span class="s1">&#39;year&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allowed_fields</span><span class="p">:</span> <span class="n">subs</span><span class="p">[</span><span class="s1">&#39;j&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getdoy</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">subs</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">],</span> <span class="n">subs</span><span class="p">[</span><span class="s1">&#39;D&#39;</span><span class="p">],</span> <span class="n">subs</span><span class="p">[</span><span class="s1">&#39;j&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>

    <span class="k">if</span> <span class="s1">&#39;hour&#39;</span> <span class="ow">in</span> <span class="n">dt</span><span class="p">:</span>
      <span class="n">h</span> <span class="o">=</span> <span class="n">dt</span><span class="p">[</span><span class="s1">&#39;hour&#39;</span><span class="p">]</span>
      <span class="n">subs</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%02d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">h</span>
      <span class="n">subs</span><span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%02d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">((</span><span class="n">h</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">12</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
      <span class="n">subs</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;am&#39;</span><span class="p">,</span> <span class="s1">&#39;pm&#39;</span><span class="p">][</span><span class="n">h</span> <span class="o">//</span> <span class="mi">12</span><span class="p">]</span>
      <span class="n">subs</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;AM&#39;</span><span class="p">,</span> <span class="s1">&#39;PM&#39;</span><span class="p">][</span><span class="n">h</span> <span class="o">//</span> <span class="mi">12</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">subs</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">],</span> <span class="n">subs</span><span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">],</span> <span class="n">subs</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">],</span> <span class="n">subs</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>

    <span class="k">if</span> <span class="s1">&#39;minute&#39;</span> <span class="ow">in</span> <span class="n">dt</span><span class="p">:</span>
      <span class="n">M</span> <span class="o">=</span> <span class="n">dt</span><span class="p">[</span><span class="s1">&#39;minute&#39;</span><span class="p">]</span>
      <span class="n">subs</span><span class="p">[</span><span class="s1">&#39;M&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%02d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">M</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">subs</span><span class="p">[</span><span class="s1">&#39;M&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="k">if</span> <span class="s1">&#39;second&#39;</span> <span class="ow">in</span> <span class="n">dt</span><span class="p">:</span>
      <span class="n">s</span> <span class="o">=</span> <span class="n">dt</span><span class="p">[</span><span class="s1">&#39;second&#39;</span><span class="p">]</span>
      <span class="n">subs</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%02d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">s</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">subs</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="n">subs</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">value</span>
    <span class="n">subs</span><span class="p">[</span><span class="s1">&#39;V&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">fmt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">fmt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">formatstr</span>

    <span class="k">return</span> <span class="n">Template</span><span class="p">(</span><span class="n">fmt</span><span class="p">)</span><span class="o">.</span><span class="n">substitute</span><span class="p">(</span><span class="n">subs</span><span class="p">)</span></div>
  <span class="c1"># }}}</span>

<div class="viewcode-block" id="CalendarTime.str_as_val"><a class="viewcode-back" href="../../timeaxes.html#pygeode.timeaxis.CalendarTime.str_as_val">[docs]</a>  <span class="k">def</span> <span class="nf">str_as_val</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
<span class="c1"># {{{</span>
    <span class="sd">&#39;&#39;&#39; Converts a string representation of a date to a value according to the</span>
<span class="sd">        calendar defined by this time axis.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ==========</span>
<span class="sd">        key : string</span>
<span class="sd">            key used in select()</span>

<span class="sd">        s : string</span>
<span class="sd">            string to convert</span>

<span class="sd">        Returns</span>
<span class="sd">        =======</span>
<span class="sd">        val : value</span>
<span class="sd">            value corresponding to specified date.</span>

<span class="sd">        Notes</span>
<span class="sd">        =====</span>
<span class="sd">        The string is parsed using the regular expression pattern(s) defined in</span>
<span class="sd">        :attr:`~timeaxis.CalendarTime.parse_patterns`.  By default this assumes</span>
<span class="sd">        a string in an ISO 8601-like format, or in the form &#39;12 Dec 2008&#39; or &#39;06:00:00 1</span>
<span class="sd">        Jan 1979&#39;.  A ValueError is thrown if the regular expression does not</span>
<span class="sd">        match the string.&#39;&#39;&#39;</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">date_as_val</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">str_as_date</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">s</span><span class="p">))</span></div>
<span class="c1"># }}}</span>

  <span class="k">def</span> <span class="nf">str_as_date</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
<span class="c1"># {{{</span>
    <span class="sd">&#39;&#39;&#39; Converts a string representation of a date to a dictionary according to the</span>
<span class="sd">        calendar defined by this time axis.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ==========</span>
<span class="sd">        key : string</span>
<span class="sd">            key used in select()</span>

<span class="sd">        s : string</span>
<span class="sd">            string to convert</span>

<span class="sd">        Returns</span>
<span class="sd">        =======</span>
<span class="sd">        val : value</span>
<span class="sd">            value corresponding to specified date.</span>

<span class="sd">        Notes</span>
<span class="sd">        =====</span>
<span class="sd">        The string is parsed using the regular expression pattern(s) defined in</span>
<span class="sd">        :attr:`~timeaxis.CalendarTime.parse_patterns`.  By default this assumes</span>
<span class="sd">        a string in ISO8601 format, or in the form &#39;12 Dec 2008&#39; or &#39;06:00:00 1</span>
<span class="sd">        Jan 1979&#39;.  A ValueError is thrown if the regular expression does not</span>
<span class="sd">        match the string.&#39;&#39;&#39;</span>
    <span class="kn">import</span> <span class="nn">re</span>
    <span class="k">for</span> <span class="n">patt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_patterns</span><span class="p">:</span>
      <span class="n">res</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">patt</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="k">break</span>

    <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;String &quot;</span><span class="si">%s</span><span class="s1">&quot; not recognized as a time&#39;</span><span class="p">)</span>

    <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">groupdict</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
      <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;hour&#39;</span><span class="p">,</span> <span class="s1">&#39;minute&#39;</span><span class="p">,</span> <span class="s1">&#39;second&#39;</span><span class="p">,</span> <span class="s1">&#39;day&#39;</span><span class="p">,</span> <span class="s1">&#39;year&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
      <span class="k">elif</span> <span class="n">k</span> <span class="o">==</span> <span class="s1">&#39;month&#39;</span> <span class="ow">and</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">lmonths</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">months</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">lmonths</span><span class="p">:</span>
          <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">lmonths</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">d</span>
<span class="c1"># }}}</span>

  <span class="c1"># Convert a date dictionary to a tuple - fill in missing fields with defaults</span>
  <span class="nd">@staticmethod</span>
  <span class="k">def</span> <span class="nf">_get_dates</span> <span class="p">(</span><span class="n">dates</span><span class="p">,</span> <span class="n">use_arrays</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="c1"># {{{</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

    <span class="k">if</span> <span class="n">use_arrays</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">use_arrays</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="s1">&#39;__len__&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dates</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="k">if</span> <span class="n">use_arrays</span><span class="p">:</span>
      <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="s1">&#39;__len__&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dates</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
      <span class="n">n</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dates</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
      <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;inconsistent array lengths&#39;</span>
      <span class="n">n</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
      <span class="n">zeros</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="s1">&#39;int32&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">use_arrays</span> <span class="k">else</span> <span class="mi">0</span>
      <span class="n">ones</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="s1">&#39;int32&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">use_arrays</span> <span class="k">else</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">assert</span> <span class="nb">all</span><span class="p">([(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="s1">&#39;__len__&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> \
        <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="s1">&#39;__len__&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dates</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
      <span class="n">zeros</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="n">ones</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">year</span> <span class="o">=</span> <span class="n">dates</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="n">zeros</span><span class="p">)</span>
    <span class="n">month</span> <span class="o">=</span> <span class="n">dates</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;month&#39;</span><span class="p">,</span> <span class="n">ones</span><span class="p">)</span>
    <span class="n">day</span> <span class="o">=</span> <span class="n">dates</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;day&#39;</span><span class="p">,</span> <span class="n">ones</span><span class="p">)</span>
    <span class="n">hour</span> <span class="o">=</span> <span class="n">dates</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;hour&#39;</span><span class="p">,</span> <span class="n">zeros</span><span class="p">)</span>
    <span class="n">minute</span> <span class="o">=</span> <span class="n">dates</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;minute&#39;</span><span class="p">,</span> <span class="n">zeros</span><span class="p">)</span>
    <span class="n">second</span> <span class="o">=</span> <span class="n">dates</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;second&#39;</span><span class="p">,</span> <span class="n">zeros</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">use_arrays</span><span class="p">:</span>
      <span class="k">def</span> <span class="nf">scalar</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="s1">&#39;__len__&#39;</span><span class="p">):</span> <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

      <span class="c1"># Fuck you, numpy scalars!</span>
      <span class="n">year</span> <span class="o">=</span> <span class="n">scalar</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
      <span class="n">month</span> <span class="o">=</span> <span class="n">scalar</span><span class="p">(</span><span class="n">month</span><span class="p">)</span>
      <span class="n">day</span> <span class="o">=</span> <span class="n">scalar</span><span class="p">(</span><span class="n">day</span><span class="p">)</span>
      <span class="n">hour</span> <span class="o">=</span> <span class="n">scalar</span><span class="p">(</span><span class="n">hour</span><span class="p">)</span>
      <span class="n">minute</span> <span class="o">=</span> <span class="n">scalar</span><span class="p">(</span><span class="n">minute</span><span class="p">)</span>
      <span class="n">second</span> <span class="o">=</span> <span class="n">scalar</span><span class="p">(</span><span class="n">second</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="n">hour</span><span class="p">,</span> <span class="n">minute</span><span class="p">,</span> <span class="n">second</span>
<span class="c1"># }}}</span>


  <span class="c1"># Convert a relative time array to an absolute time</span>
  <span class="c1"># Dictionary of years, months, etc. from a relative time axis</span>
<div class="viewcode-block" id="CalendarTime.val_as_date"><a class="viewcode-back" href="../../timeaxes.html#pygeode.timeaxis.CalendarTime.val_as_date">[docs]</a>  <span class="k">def</span> <span class="nf">val_as_date</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vals</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">startdate</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">units</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">allfields</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
  <span class="c1"># {{{</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

    <span class="k">if</span> <span class="n">vals</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span>
    <span class="k">if</span> <span class="n">startdate</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">startdate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">startdate</span>
    <span class="k">if</span> <span class="n">units</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span>

    <span class="n">iyear</span><span class="p">,</span> <span class="n">imonth</span><span class="p">,</span> <span class="n">iday</span><span class="p">,</span> <span class="n">ihour</span><span class="p">,</span> <span class="n">iminute</span><span class="p">,</span> <span class="n">isecond</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_dates</span><span class="p">(</span><span class="n">startdate</span><span class="p">)</span>

    <span class="n">had_array</span> <span class="o">=</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span><span class="s1">&#39;__len__&#39;</span><span class="p">)</span>
    <span class="n">vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>
    <span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">vals</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">unitfactor</span><span class="p">[</span><span class="n">units</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int64&#39;</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
    <span class="n">year</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int32&#39;</span><span class="p">)</span>
    <span class="n">month</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int32&#39;</span><span class="p">)</span>
    <span class="n">day</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int32&#39;</span><span class="p">)</span>
    <span class="n">hour</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int32&#39;</span><span class="p">)</span>
    <span class="n">minute</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int32&#39;</span><span class="p">)</span>
    <span class="n">second</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int32&#39;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_val_as_date</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">iyear</span><span class="p">,</span> <span class="n">imonth</span><span class="p">,</span> <span class="n">iday</span><span class="p">,</span> <span class="n">ihour</span><span class="p">,</span> <span class="n">iminute</span><span class="p">,</span> <span class="n">isecond</span><span class="p">,</span>
                        <span class="n">values</span><span class="p">,</span>
                        <span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span>
                        <span class="n">hour</span><span class="p">,</span> <span class="n">minute</span><span class="p">,</span> <span class="n">second</span><span class="p">)</span>

    <span class="n">date</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;year&#39;</span><span class="p">:</span><span class="n">year</span><span class="p">,</span> <span class="s1">&#39;month&#39;</span><span class="p">:</span><span class="n">month</span><span class="p">,</span> <span class="s1">&#39;day&#39;</span><span class="p">:</span><span class="n">day</span><span class="p">,</span> <span class="s1">&#39;hour&#39;</span><span class="p">:</span><span class="n">hour</span><span class="p">,</span> <span class="s1">&#39;minute&#39;</span><span class="p">:</span><span class="n">minute</span><span class="p">,</span> <span class="s1">&#39;second&#39;</span><span class="p">:</span><span class="n">second</span><span class="p">}</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">allfields</span><span class="p">:</span>
      <span class="c1"># Remove fields that weren&#39;t explicitly provided?</span>
      <span class="n">date</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">date</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">startdate</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">had_array</span><span class="p">:</span>
      <span class="n">date</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">date</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">date</span></div>
  <span class="c1"># }}}</span>

  <span class="c1"># Convert an absolute time to a relative time</span>
<div class="viewcode-block" id="CalendarTime.date_as_val"><a class="viewcode-back" href="../../timeaxes.html#pygeode.timeaxis.CalendarTime.date_as_val">[docs]</a>  <span class="k">def</span> <span class="nf">date_as_val</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dates</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">startdate</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">units</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
  <span class="c1"># {{{</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

    <span class="k">if</span> <span class="n">dates</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">dates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auxarrays</span>
    <span class="k">if</span> <span class="n">startdate</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">startdate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">startdate</span>
    <span class="k">if</span> <span class="n">units</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span>

    <span class="n">iyear</span><span class="p">,</span> <span class="n">imonth</span><span class="p">,</span> <span class="n">iday</span><span class="p">,</span> <span class="n">ihour</span><span class="p">,</span> <span class="n">iminute</span><span class="p">,</span> <span class="n">isecond</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_dates</span><span class="p">(</span><span class="n">startdate</span><span class="p">,</span> <span class="n">use_arrays</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="n">hour</span><span class="p">,</span> <span class="n">minute</span><span class="p">,</span> <span class="n">second</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_dates</span><span class="p">(</span><span class="n">dates</span><span class="p">)</span>
    <span class="n">year</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">year</span><span class="p">,</span>   <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int32&#39;</span><span class="p">)</span>
    <span class="n">month</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">month</span><span class="p">,</span>  <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int32&#39;</span><span class="p">)</span>
    <span class="n">day</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">day</span><span class="p">,</span>    <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int32&#39;</span><span class="p">)</span>
    <span class="n">hour</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">hour</span><span class="p">,</span>   <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int32&#39;</span><span class="p">)</span>
    <span class="n">minute</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">minute</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int32&#39;</span><span class="p">)</span>
    <span class="n">second</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">second</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int32&#39;</span><span class="p">)</span>

    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
    <span class="n">vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int64&#39;</span><span class="p">)</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_date_as_val</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">iyear</span><span class="p">,</span> <span class="n">imonth</span><span class="p">,</span> <span class="n">iday</span><span class="p">,</span> <span class="n">ihour</span><span class="p">,</span> <span class="n">iminute</span><span class="p">,</span> <span class="n">isecond</span><span class="p">,</span>
                        <span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span>
                        <span class="n">hour</span><span class="p">,</span> <span class="n">minute</span><span class="p">,</span> <span class="n">second</span><span class="p">,</span>
                        <span class="n">vals</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span>

    <span class="c1"># Were we passed a single date?  If so, return a scalar</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">dates</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;__len__&#39;</span><span class="p">):</span> <span class="n">vals</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">vals</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">unitfactor</span><span class="p">[</span><span class="n">units</span><span class="p">]</span></div></div>
  <span class="c1"># }}}</span>
<span class="c1"># }}}</span>

<span class="c1">######################################################</span>
<span class="c1"># Specific calendars follow:</span>

<span class="c1">#NOTE: majority of calendar manipulation has been moved to a C interface (timeaxis.c)</span>

<span class="c1"># Standard time (with leap years)</span>
<div class="viewcode-block" id="StandardTime"><a class="viewcode-back" href="../../timeaxes.html#pygeode.timeaxis.StandardTime">[docs]</a><span class="k">class</span> <span class="nc">StandardTime</span><span class="p">(</span><span class="n">CalendarTime</span><span class="p">):</span>
<span class="c1"># {{{</span>
  <span class="sd">&#39;&#39;&#39; Time axis describing the standard Gregorian calendar. &#39;&#39;&#39;</span>

  <span class="n">_val_as_date</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">val_as_date_std</span>
  <span class="n">_date_as_val</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">date_as_val_std</span></div>

<span class="c1"># }}}</span>

<span class="c1"># Model time (365-day calendar)</span>
<div class="viewcode-block" id="ModelTime365"><a class="viewcode-back" href="../../timeaxes.html#pygeode.timeaxis.ModelTime365">[docs]</a><span class="k">class</span> <span class="nc">ModelTime365</span><span class="p">(</span><span class="n">CalendarTime</span><span class="p">):</span>
<span class="c1"># {{{</span>
  <span class="sd">&#39;&#39;&#39; Time axis describing a model 365-day calendar. &#39;&#39;&#39;</span>

  <span class="n">_date_as_val</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">date_as_val_365</span>
  <span class="n">_val_as_date</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">val_as_date_365</span></div>

<span class="c1"># }}}</span>

<span class="c1"># Model time (360-day calendar)</span>
<div class="viewcode-block" id="ModelTime360"><a class="viewcode-back" href="../../timeaxes.html#pygeode.timeaxis.ModelTime360">[docs]</a><span class="k">class</span> <span class="nc">ModelTime360</span><span class="p">(</span><span class="n">CalendarTime</span><span class="p">):</span>
<span class="c1"># {{{</span>
  <span class="sd">&#39;&#39;&#39; Time axis describing a model 360-day calendar. &#39;&#39;&#39;</span>

  <span class="n">autofmts</span> <span class="o">=</span> <span class="p">[(</span><span class="mf">360.</span><span class="p">,</span> <span class="s1">&#39;$Y&#39;</span><span class="p">,</span>        <span class="s1">&#39;&#39;</span><span class="p">),</span>   <span class="c1"># Range larger than 1 year</span>
          <span class="p">(</span><span class="mf">30.</span> <span class="p">,</span> <span class="s1">&#39;$b $Y&#39;</span><span class="p">,</span>     <span class="s1">&#39;&#39;</span><span class="p">),</span>   <span class="c1"># Larger than 1 month</span>
          <span class="p">(</span><span class="mf">1.</span><span class="p">,</span> <span class="s1">&#39;$d $b&#39;</span><span class="p">,</span>     <span class="s1">&#39;$Y&#39;</span><span class="p">),</span> <span class="c1"># Larger than 1 day</span>
          <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mf">24.</span><span class="p">,</span> <span class="s1">&#39;$H:$M&#39;</span><span class="p">,</span>     <span class="s1">&#39;$d $b $Y&#39;</span><span class="p">),</span>  <span class="c1"># Larger than 1 hour</span>
          <span class="p">(</span><span class="mf">0.</span>  <span class="p">,</span> <span class="s1">&#39;$H:$M:$S&#39;</span><span class="p">,</span>  <span class="s1">&#39;$d $b $Y&#39;</span><span class="p">)]</span> <span class="c1"># Less than 1 hour</span>

  <span class="n">_date_as_val</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">date_as_val_360</span>
  <span class="n">_val_as_date</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">val_as_date_360</span></div>
<span class="c1"># }}}</span>

<span class="c1"># Seasonal time axis</span>
<span class="c1"># (only has &#39;syear&#39; and &#39;season&#39; auxiliary arrays)</span>
<span class="c1">#TODO: add this to cfmeta package, so seasonal data can be saved/loaded</span>
<span class="k">def</span> <span class="nf">makeSeasonalAxis</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
<span class="c1"># {{{</span>
  <span class="k">class</span> <span class="nc">SeasonalTime</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
    <span class="n">allowed_fields</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;year&#39;</span><span class="p">,</span><span class="s1">&#39;season&#39;</span><span class="p">)</span>

    <span class="n">formatstr</span> <span class="o">=</span> <span class="s1">&#39;$s $y&#39;</span>
    <span class="n">autofmts</span> <span class="o">=</span> <span class="p">[(</span><span class="mf">360.</span><span class="p">,</span> <span class="s1">&#39;$Y&#39;</span><span class="p">,</span>    <span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="c1"># Range larger than 1 year</span>
                <span class="p">(</span><span class="mf">0.</span>  <span class="p">,</span> <span class="s1">&#39;$s $Y&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)]</span> <span class="c1"># Less than 1 year</span>

    <span class="c1"># For now seasonal definitions are hard coded</span>
    <span class="n">nseasons</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="n">seasons</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;DJF&#39;</span><span class="p">,</span> <span class="s1">&#39;MAM&#39;</span><span class="p">,</span> <span class="s1">&#39;JJA&#39;</span><span class="p">,</span> <span class="s1">&#39;SON&#39;</span><span class="p">]</span>
    <span class="n">season_boundaries</span> <span class="o">=</span> <span class="p">[(</span><span class="o">-</span><span class="mi">30</span><span class="p">,</span><span class="mi">60</span><span class="p">),(</span><span class="mi">60</span><span class="p">,</span><span class="mi">152</span><span class="p">),(</span><span class="mi">152</span><span class="p">,</span><span class="mi">244</span><span class="p">),(</span><span class="mi">244</span><span class="p">,</span><span class="mi">335</span><span class="p">)]</span>
    <span class="n">cdates</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;dyear&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]),</span>
              <span class="s1">&#39;month&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">10</span><span class="p">]),</span>
              <span class="s1">&#39;day&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">16</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">])}</span>
    <span class="n">plotatts</span> <span class="o">=</span> <span class="n">Base</span><span class="o">.</span><span class="n">plotatts</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># Generate year and season array</span>
    <span class="c1"># Note: year gets fudged for Decembers, to keep the seasons together</span>
    <span class="c1"># Convention: December 2006 -&gt; DJF 2007</span>
    <span class="k">def</span> <span class="nf">_get_seasons</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dates</span><span class="p">):</span>
  <span class="c1"># {{{</span>
      <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
      <span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="n">hour</span><span class="p">,</span> <span class="n">minute</span><span class="p">,</span> <span class="n">second</span> <span class="o">=</span> <span class="n">Base</span><span class="o">.</span><span class="n">_get_dates</span><span class="p">(</span><span class="n">dates</span><span class="p">)</span>
      <span class="n">doy</span> <span class="o">=</span> <span class="n">Base</span><span class="o">.</span><span class="n">_getdoy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dates</span><span class="p">)</span>         <span class="c1"># Base season on day of the year (no support for leap years(!))</span>

      <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="s1">&#39;__len__&#39;</span><span class="p">):</span>
        <span class="n">season</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">year</span><span class="p">),</span> <span class="s1">&#39;i&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">season_boundaries</span><span class="p">):</span>
          <span class="n">mplus</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">doy</span> <span class="o">-</span> <span class="mi">365</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">doy</span> <span class="o">-</span> <span class="mi">365</span> <span class="o">&lt;</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
          <span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">doy</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">doy</span> <span class="o">&lt;</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
          <span class="n">mminus</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">doy</span> <span class="o">+</span> <span class="mi">365</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">doy</span> <span class="o">+</span> <span class="mi">365</span> <span class="o">&lt;</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
          <span class="n">year</span><span class="p">[</span><span class="n">mplus</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
          <span class="n">year</span><span class="p">[</span><span class="n">mminus</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
          <span class="n">season</span><span class="p">[</span><span class="n">mplus</span> <span class="o">|</span> <span class="n">m</span> <span class="o">|</span> <span class="n">mminus</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">season_boundaries</span><span class="p">):</span>
          <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">doy</span> <span class="o">-</span> <span class="mi">365</span> <span class="o">&lt;</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="n">year</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">season</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
          <span class="k">elif</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">doy</span> <span class="o">&lt;</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="n">season</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
          <span class="k">elif</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">doy</span> <span class="o">+</span> <span class="mi">365</span> <span class="o">&lt;</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="n">year</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">season</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>

      <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;year&#39;</span><span class="p">:</span><span class="n">year</span><span class="p">,</span> <span class="s1">&#39;season&#39;</span><span class="p">:</span><span class="n">season</span><span class="p">}</span>
  <span class="c1"># }}}</span>

    <span class="k">def</span> <span class="nf">_get_cdates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dates</span><span class="p">):</span>
  <span class="c1"># {{{</span>
      <span class="sd">&#39;&#39;&#39; _get_cdates(self, dates): returns central calendar dates of the seasonal dates given in the</span>
<span class="sd">          dictionary of dates.&#39;&#39;&#39;</span>
      <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

      <span class="n">use_arrays</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="s1">&#39;__len__&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dates</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
      <span class="k">if</span> <span class="n">use_arrays</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="s1">&#39;__len__&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dates</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dates</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;inconsistent array lengths&#39;</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="n">zeros</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="s1">&#39;int32&#39;</span><span class="p">)</span>
        <span class="n">ones</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="s1">&#39;int32&#39;</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">zeros</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">ones</span> <span class="o">=</span> <span class="mi">1</span>

      <span class="n">year</span> <span class="o">=</span> <span class="n">dates</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="n">zeros</span><span class="p">)</span>
      <span class="n">season</span> <span class="o">=</span> <span class="n">dates</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;season&#39;</span><span class="p">,</span> <span class="n">ones</span><span class="p">)</span>
      <span class="n">year</span> <span class="o">+=</span> <span class="p">(</span><span class="n">season</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">nseasons</span>
      <span class="n">season</span> <span class="o">=</span> <span class="p">(</span><span class="n">season</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">nseasons</span>

      <span class="n">year</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cdates</span><span class="p">[</span><span class="s1">&#39;dyear&#39;</span><span class="p">][</span><span class="n">season</span><span class="p">]</span>
      <span class="n">month</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cdates</span><span class="p">[</span><span class="s1">&#39;month&#39;</span><span class="p">][</span><span class="n">season</span><span class="p">]</span>
      <span class="n">day</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cdates</span><span class="p">[</span><span class="s1">&#39;day&#39;</span><span class="p">][</span><span class="n">season</span><span class="p">]</span>

      <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;year&#39;</span><span class="p">:</span><span class="n">year</span><span class="p">,</span> <span class="s1">&#39;month&#39;</span><span class="p">:</span><span class="n">month</span><span class="p">,</span> <span class="s1">&#39;day&#39;</span><span class="p">:</span><span class="n">day</span><span class="p">,</span> <span class="s1">&#39;hour&#39;</span><span class="p">:</span><span class="n">zeros</span><span class="p">,</span> <span class="s1">&#39;minute&#39;</span><span class="p">:</span><span class="n">zeros</span><span class="p">,</span> <span class="s1">&#39;second&#39;</span><span class="p">:</span><span class="n">zeros</span><span class="p">}</span>
  <span class="c1"># }}}</span>

    <span class="k">def</span> <span class="fm">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">startdate</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="c1"># {{{</span>
      <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">timeticker</span> <span class="k">as</span> <span class="n">tt</span>
      <span class="n">tg</span><span class="o">=</span><span class="p">[]</span>
      <span class="k">if</span> <span class="s1">&#39;year&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allowed_fields</span><span class="p">:</span>
        <span class="n">tg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tt</span><span class="o">.</span><span class="n">YearTickGen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">[</span><span class="mi">500</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]))</span>
      <span class="n">tg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tt</span><span class="o">.</span><span class="n">SeasonTickGen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]))</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">tick_generators</span> <span class="o">=</span> <span class="n">tg</span>

      <span class="c1"># Fill in default values for start date; this works slightly differently than for CalendarTime</span>
      <span class="k">if</span> <span class="n">startdate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">default</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">day</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">hour</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">minute</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">second</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">startdate</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">default</span><span class="p">,</span> <span class="o">**</span><span class="n">startdate</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;season&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="ow">and</span> <span class="s1">&#39;year&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span> <span class="n">startdate</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

      <span class="c1"># Use days as default units</span>
      <span class="k">if</span> <span class="n">units</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;days&#39;</span>

      <span class="n">Time</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="n">values</span><span class="p">,</span> <span class="n">startdate</span><span class="o">=</span><span class="n">startdate</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

      <span class="c1"># Check for the presence of auxarrays that aren&#39;t in allowed fields</span>
      <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">auxarrays</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">assert</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allowed_fields</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> is not an allowed field for </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
    <span class="c1"># }}}</span>

    <span class="k">def</span> <span class="nf">formatvalue</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">unitstr</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># {{{</span>
      <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">      Returns formatted string representation of ``value``, using a strftime-like</span>
<span class="sd">      specification.</span>

<span class="sd">      Parameters</span>
<span class="sd">      ----------</span>
<span class="sd">      value : float or int</span>
<span class="sd">        Value to format, in calendar defined by this time axis.</span>
<span class="sd">      fmt : string (optional)</span>
<span class="sd">        Format specification. If the default ``None`` is specified,</span>
<span class="sd">        ``self.formatstr`` is used.</span>
<span class="sd">      units : boolean (optional)</span>
<span class="sd">        Not used;, included for consistency with :func:`Var.formatvalue`</span>
<span class="sd">      unitstr : string (optional)</span>
<span class="sd">        Not used;, included for consistency with :func:`Var.formatvalue`</span>

<span class="sd">      Notes</span>
<span class="sd">      -----</span>
<span class="sd">      The following codes ($$ will yield the character $):</span>
<span class="sd">        $s - season name</span>
<span class="sd">        $y - 2 digit year</span>
<span class="sd">        $Y - 4 digit year</span>
<span class="sd">        $v - value formatted with %d</span>
<span class="sd">        $V - value formatted with str()</span>
<span class="sd">      &#39;&#39;&#39;</span>
      <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
      <span class="kn">from</span> <span class="nn">string</span> <span class="kn">import</span> <span class="n">Template</span>

      <span class="n">dt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_as_date</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

      <span class="n">subs</span> <span class="o">=</span> <span class="p">{}</span>

      <span class="c1"># Build substitution dictionary</span>
      <span class="k">if</span> <span class="s1">&#39;year&#39;</span> <span class="ow">in</span> <span class="n">dt</span><span class="p">:</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">dt</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span>
        <span class="n">subs</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%02d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">y</span> <span class="o">%</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">subs</span><span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">y</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">subs</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">],</span> <span class="n">subs</span><span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>

      <span class="k">if</span> <span class="s1">&#39;season&#39;</span> <span class="ow">in</span> <span class="n">dt</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">dt</span><span class="p">[</span><span class="s1">&#39;season&#39;</span><span class="p">]</span>
        <span class="n">subs</span><span class="p">[</span><span class="s1">&#39;s&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seasons</span><span class="p">[</span><span class="n">s</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">subs</span><span class="p">[</span><span class="s1">&#39;s&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

      <span class="n">subs</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">value</span>
      <span class="n">subs</span><span class="p">[</span><span class="s1">&#39;V&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

      <span class="k">if</span> <span class="n">fmt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fmt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">formatstr</span>

      <span class="k">return</span> <span class="n">Template</span><span class="p">(</span><span class="n">fmt</span><span class="p">)</span><span class="o">.</span><span class="n">substitute</span><span class="p">(</span><span class="n">subs</span><span class="p">)</span>
    <span class="c1"># }}}</span>

    <span class="k">def</span> <span class="nf">val_as_date</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vals</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">startdate</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">units</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">allfields</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="c1"># {{{</span>
      <span class="k">if</span> <span class="n">vals</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span>
      <span class="k">if</span> <span class="n">startdate</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">startdate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">startdate</span>
      <span class="n">date</span> <span class="o">=</span> <span class="n">Base</span><span class="o">.</span><span class="n">val_as_date</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vals</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">allfields</span><span class="p">)</span>
      <span class="n">date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_seasons</span><span class="p">(</span><span class="n">date</span><span class="p">)</span>
      <span class="c1"># Remove year field if not explicitly provided</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">allfields</span> <span class="ow">and</span> <span class="s1">&#39;year&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">startdate</span><span class="p">:</span> <span class="n">date</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">date</span>
    <span class="c1"># }}}</span>

    <span class="k">def</span> <span class="nf">date_as_val</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dates</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">startdate</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">units</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="c1"># {{{</span>
      <span class="k">if</span> <span class="n">dates</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">dates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auxarrays</span>
      <span class="k">if</span> <span class="n">startdate</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">startdate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">startdate</span>

      <span class="k">if</span> <span class="s1">&#39;season&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">dates</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span> <span class="n">dates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cdates</span><span class="p">(</span><span class="n">dates</span><span class="p">)</span>

      <span class="k">return</span> <span class="n">Base</span><span class="o">.</span><span class="n">date_as_val</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dates</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">units</span><span class="p">)</span>
    <span class="c1"># }}}</span>

  <span class="n">SeasonalTime</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="s1">&#39;Seasonal&#39;</span><span class="o">+</span><span class="n">Base</span><span class="o">.</span><span class="vm">__name__</span>
  <span class="k">return</span> <span class="n">SeasonalTime</span>
  <span class="c1"># }}}</span>

<span class="n">SeasonalStandardTime</span> <span class="o">=</span> <span class="n">makeSeasonalAxis</span><span class="p">(</span><span class="n">StandardTime</span><span class="p">)</span>
<span class="n">SeasonalModelTime365</span> <span class="o">=</span> <span class="n">makeSeasonalAxis</span><span class="p">(</span><span class="n">ModelTime365</span><span class="p">)</span>

<span class="n">SeasonalTAxes</span> <span class="o">=</span> <span class="p">{</span><span class="n">StandardTime</span><span class="p">:</span><span class="n">SeasonalStandardTime</span><span class="p">,</span>
                  <span class="n">ModelTime365</span><span class="p">:</span><span class="n">SeasonalModelTime365</span><span class="p">}</span>

<span class="c1"># Yearless calendar</span>
<span class="c1"># Kludges the CalendarTime axis so it has no years or months, just a running count of days</span>
<div class="viewcode-block" id="Yearless"><a class="viewcode-back" href="../../timeaxes.html#pygeode.timeaxis.Yearless">[docs]</a><span class="k">class</span> <span class="nc">Yearless</span><span class="p">(</span><span class="n">CalendarTime</span><span class="p">):</span>
<span class="c1"># {{{</span>
  <span class="sd">&#39;&#39;&#39; Time axis describing a calendar with no months or years. &#39;&#39;&#39;</span>

  <span class="c1"># Format of time axis used for str/repr functions</span>
  <span class="n">plotatts</span> <span class="o">=</span> <span class="n">CalendarTime</span><span class="o">.</span><span class="n">plotatts</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
  <span class="n">plotatts</span><span class="p">[</span><span class="s1">&#39;plotfmt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;$d&#39;</span>
  <span class="n">formatstr</span> <span class="o">=</span> <span class="s1">&#39;day $d, $H:$M:$S&#39;</span>
  <span class="n">autofmts</span> <span class="o">=</span> <span class="p">[(</span><span class="mf">1.</span><span class="p">,</span> <span class="s1">&#39;$d&#39;</span><span class="p">,</span>         <span class="s1">&#39;&#39;</span><span class="p">),</span>   <span class="c1"># Larger than 1 day</span>
              <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mf">24.</span><span class="p">,</span> <span class="s1">&#39;$H:$M&#39;</span><span class="p">,</span>   <span class="s1">&#39;day $d&#39;</span><span class="p">),</span> <span class="c1"># Larger than 1 hour</span>
              <span class="p">(</span><span class="mf">0.</span>  <span class="p">,</span> <span class="s1">&#39;$H:$M:$S&#39;</span><span class="p">,</span> <span class="s1">&#39;day $d&#39;</span><span class="p">)]</span> <span class="c1"># Less than 1 hour</span>

  <span class="n">allowed_fields</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;day&#39;</span><span class="p">,</span> <span class="s1">&#39;hour&#39;</span><span class="p">,</span> <span class="s1">&#39;minute&#39;</span><span class="p">,</span> <span class="s1">&#39;second&#39;</span><span class="p">)</span>

  <span class="c1"># Regular expression used to parse times</span>
  <span class="n">parse_patterns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;((?P&lt;hour&gt;\d{1,2}):(?P&lt;minute&gt;\d</span><span class="si">{2}</span><span class="s1">)(\s|:(?P&lt;second&gt;\d</span><span class="si">{2}</span><span class="s1">))|^)(?P&lt;day&gt;\d{1,2})&#39;</span><span class="p">]</span>

  <span class="n">_date_as_val</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">date_as_val_yearless</span>
  <span class="n">_val_as_date</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">val_as_date_yearless</span>

  <span class="c1"># Day-of-year calculator</span>
  <span class="c1"># (for formatvalue)</span>
  <span class="k">def</span> <span class="nf">_getdoy</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date</span><span class="p">):</span>
<span class="c1"># {{{</span>
    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;ain&#39;t got no years!&quot;</span><span class="p">)</span>
<span class="c1">#    return &quot;&lt;doy??&gt;&quot;</span>
<span class="c1"># }}}</span>

  <span class="c1"># Number of days in a month</span>
  <span class="c1"># Required by timeticker</span>
<div class="viewcode-block" id="Yearless.days_in_month"><a class="viewcode-back" href="../../timeaxes.html#pygeode.timeaxis.Yearless.days_in_month">[docs]</a>  <span class="k">def</span> <span class="nf">days_in_month</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">yr</span><span class="p">,</span> <span class="n">mn</span><span class="p">):</span>
  <span class="c1"># {{{</span>
    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;ain&#39;t got no months!&quot;</span><span class="p">)</span></div>
<span class="c1">#    return &quot;&lt;days_in_month??&gt;&quot;</span>
  <span class="c1"># }}}</span>

<div class="viewcode-block" id="Yearless.__init__"><a class="viewcode-back" href="../../timeaxes.html#pygeode.timeaxis.Yearless.__init__">[docs]</a>  <span class="k">def</span> <span class="fm">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">timeticker</span> <span class="k">as</span> <span class="n">tt</span>
    <span class="n">CalendarTime</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">tg</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">tg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tt</span><span class="o">.</span><span class="n">DayTickGen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">[</span><span class="mi">10000</span><span class="p">,</span> <span class="mi">5000</span><span class="p">,</span> <span class="mi">3000</span><span class="p">,</span> <span class="mi">2000</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]))</span>
    <span class="n">tg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tt</span><span class="o">.</span><span class="n">HourTickGen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">[</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]))</span>
    <span class="n">tg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tt</span><span class="o">.</span><span class="n">MinuteTickGen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">[</span><span class="mi">30</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]))</span>
    <span class="n">tg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tt</span><span class="o">.</span><span class="n">SecondTickGen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">[</span><span class="mi">30</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tick_generators</span> <span class="o">=</span> <span class="n">tg</span></div></div>

<span class="c1"># }}}</span>

<span class="c1"># Helper functions</span>

<div class="viewcode-block" id="standardtimerange"><a class="viewcode-back" href="../../timeaxes.html#pygeode.timeaxis.standardtimerange">[docs]</a><span class="k">def</span> <span class="nf">standardtimerange</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;days&#39;</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">inc</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="c1"># {{{</span>
  <span class="sa">r</span><span class="sd">&#39;&#39;&#39;Creates a :class:`StandardTime` axis for the period from start to end.</span>

<span class="sd">  Parameters</span>
<span class="sd">  ==========</span>
<span class="sd">  start : string</span>
<span class="sd">    Date to start time axis from (see :meth:`~timeaxis.CalendarTime.str_as_val`)</span>
<span class="sd">  end : string</span>
<span class="sd">    Date to end time axis at. Note this date will not be included.</span>
<span class="sd">  step : float, optional</span>
<span class="sd">    Interval between grid points. Default is 1.</span>
<span class="sd">  units : one of &#39;seconds&#39;, &#39;minutes&#39;, &#39;hours&#39;, &#39;days&#39;, optional</span>
<span class="sd">    Unit in which to define time step values. Default is &#39;days&#39;.</span>
<span class="sd">  ref : string, optional</span>
<span class="sd">    Reference date for calendar. If the default None is specified, start is used.</span>
<span class="sd">  inc : boolean, optional (default False)</span>
<span class="sd">  &#39;&#39;&#39;</span>
  <span class="kn">from</span> <span class="nn">.timeutils</span> <span class="kn">import</span> <span class="n">date_diff</span>
  <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
  <span class="n">tdum</span> <span class="o">=</span> <span class="n">StandardTime</span><span class="p">(</span><span class="n">values</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span> <span class="n">startdate</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
  <span class="n">s</span> <span class="o">=</span> <span class="n">tdum</span><span class="o">.</span><span class="n">str_as_date</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">start</span><span class="p">)</span>
  <span class="n">e</span> <span class="o">=</span> <span class="n">tdum</span><span class="o">.</span><span class="n">str_as_date</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">ref</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">f</span> <span class="o">=</span> <span class="n">s</span>
  <span class="k">else</span><span class="p">:</span> <span class="n">f</span> <span class="o">=</span> <span class="n">tdum</span><span class="o">.</span><span class="n">str_as_date</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">ref</span><span class="p">)</span>
  <span class="n">n</span> <span class="o">=</span> <span class="n">date_diff</span><span class="p">(</span><span class="n">tdum</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">units</span><span class="p">)</span>
  <span class="n">o</span> <span class="o">=</span> <span class="n">date_diff</span><span class="p">(</span><span class="n">tdum</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">units</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">inc</span><span class="p">:</span> <span class="n">vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span> <span class="o">+</span> <span class="n">step</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span> <span class="o">+</span> <span class="n">o</span>
  <span class="k">else</span><span class="p">:</span> <span class="n">vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span> <span class="o">+</span> <span class="n">o</span>
  <span class="k">return</span> <span class="n">StandardTime</span><span class="p">(</span><span class="n">values</span><span class="o">=</span><span class="n">vals</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span> <span class="n">startdate</span><span class="o">=</span><span class="n">f</span><span class="p">)</span></div>
<span class="c1"># }}}</span>

<div class="viewcode-block" id="standardtimen"><a class="viewcode-back" href="../../timeaxes.html#pygeode.timeaxis.standardtimen">[docs]</a><span class="k">def</span> <span class="nf">standardtimen</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;days&#39;</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="c1"># {{{</span>
  <span class="sa">r</span><span class="sd">&#39;&#39;&#39;Creates a :class:`StandardTime` axis of length n.</span>

<span class="sd">  Parameters</span>
<span class="sd">  ==========</span>
<span class="sd">  start : string</span>
<span class="sd">    Date to start time axis from (see :meth:`~timeaxis.CalendarTime.str_as_val`)</span>
<span class="sd">  n : integer</span>
<span class="sd">    Length of axis to create</span>
<span class="sd">  step : float, optional</span>
<span class="sd">    Interval between grid points. Default is 1.</span>
<span class="sd">  units : one of &#39;seconds&#39;, &#39;minutes&#39;, &#39;hours&#39;, &#39;days&#39;, optional</span>
<span class="sd">    Unit in which to define time step values. Default is &#39;days&#39;.</span>
<span class="sd">  ref : string, optional</span>
<span class="sd">    Reference date for calendar. If the default None is specified, start is used.</span>
<span class="sd">  &#39;&#39;&#39;</span>
  <span class="kn">from</span> <span class="nn">.timeutils</span> <span class="kn">import</span> <span class="n">date_diff</span>
  <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
  <span class="n">tdum</span> <span class="o">=</span> <span class="n">StandardTime</span><span class="p">(</span><span class="n">values</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span> <span class="n">startdate</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
  <span class="n">s</span> <span class="o">=</span> <span class="n">tdum</span><span class="o">.</span><span class="n">str_as_date</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">start</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">ref</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">f</span> <span class="o">=</span> <span class="n">s</span>
  <span class="k">else</span><span class="p">:</span> <span class="n">f</span> <span class="o">=</span> <span class="n">tdum</span><span class="o">.</span><span class="n">str_as_date</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">ref</span><span class="p">)</span>
  <span class="n">o</span> <span class="o">=</span> <span class="n">date_diff</span><span class="p">(</span><span class="n">tdum</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">units</span><span class="p">)</span>
  <span class="n">vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="o">*</span><span class="n">step</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span> <span class="o">+</span> <span class="n">o</span>
  <span class="k">return</span> <span class="n">StandardTime</span><span class="p">(</span><span class="n">values</span><span class="o">=</span><span class="n">vals</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span> <span class="n">startdate</span><span class="o">=</span><span class="n">f</span><span class="p">)</span></div>
<span class="c1"># }}}</span>

<div class="viewcode-block" id="modeltime365range"><a class="viewcode-back" href="../../timeaxes.html#pygeode.timeaxis.modeltime365range">[docs]</a><span class="k">def</span> <span class="nf">modeltime365range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;days&#39;</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">inc</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="c1"># {{{</span>
  <span class="sa">r</span><span class="sd">&#39;&#39;&#39;Creates a :class:`ModelTime365` axis for the period from start to end.</span>

<span class="sd">  Parameters</span>
<span class="sd">  ==========</span>
<span class="sd">  start : string</span>
<span class="sd">    Date to start time axis from (see :meth:`~timeaxis.CalendarTime.str_as_val`)</span>
<span class="sd">  end : string</span>
<span class="sd">    Date to end time axis at. Note this date will not be included.</span>
<span class="sd">  step : float, optional</span>
<span class="sd">    Interval between grid points. Default is 1.</span>
<span class="sd">  units : one of &#39;seconds&#39;, &#39;minutes&#39;, &#39;hours&#39;, &#39;days&#39;, optional</span>
<span class="sd">    Unit in which to define time step values. Default is &#39;days&#39;.</span>
<span class="sd">  ref : string, optional</span>
<span class="sd">    Reference date for calendar. If the default None is specified, start is used.</span>
<span class="sd">  inc : boolean, optional (default False)</span>
<span class="sd">  &#39;&#39;&#39;</span>
  <span class="kn">from</span> <span class="nn">.timeutils</span> <span class="kn">import</span> <span class="n">date_diff</span>
  <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
  <span class="n">tdum</span> <span class="o">=</span> <span class="n">ModelTime365</span><span class="p">(</span><span class="n">values</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span> <span class="n">startdate</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
  <span class="n">s</span> <span class="o">=</span> <span class="n">tdum</span><span class="o">.</span><span class="n">str_as_date</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">start</span><span class="p">)</span>
  <span class="n">e</span> <span class="o">=</span> <span class="n">tdum</span><span class="o">.</span><span class="n">str_as_date</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">ref</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">f</span> <span class="o">=</span> <span class="n">s</span>
  <span class="k">else</span><span class="p">:</span> <span class="n">f</span> <span class="o">=</span> <span class="n">tdum</span><span class="o">.</span><span class="n">str_as_date</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">ref</span><span class="p">)</span>
  <span class="n">n</span> <span class="o">=</span> <span class="n">date_diff</span><span class="p">(</span><span class="n">tdum</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">units</span><span class="p">)</span>
  <span class="n">o</span> <span class="o">=</span> <span class="n">date_diff</span><span class="p">(</span><span class="n">tdum</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">units</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">inc</span><span class="p">:</span> <span class="n">vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span> <span class="o">+</span> <span class="n">step</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span> <span class="o">+</span> <span class="n">o</span>
  <span class="k">else</span><span class="p">:</span> <span class="n">vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span> <span class="o">+</span> <span class="n">o</span>

  <span class="k">return</span> <span class="n">ModelTime365</span><span class="p">(</span><span class="n">values</span><span class="o">=</span><span class="n">vals</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span> <span class="n">startdate</span><span class="o">=</span><span class="n">f</span><span class="p">)</span></div>
<span class="c1"># }}}</span>

<div class="viewcode-block" id="modeltime365n"><a class="viewcode-back" href="../../timeaxes.html#pygeode.timeaxis.modeltime365n">[docs]</a><span class="k">def</span> <span class="nf">modeltime365n</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;days&#39;</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="c1"># {{{</span>
  <span class="sa">r</span><span class="sd">&#39;&#39;&#39;Creates a :class:`ModelTime365` axis of length n.</span>

<span class="sd">  Parameters</span>
<span class="sd">  ==========</span>
<span class="sd">  start : string</span>
<span class="sd">    Date to start time axis from (see :meth:`~timeaxis.CalendarTime.str_as_val`)</span>
<span class="sd">  n : integer</span>
<span class="sd">    Length of axis to create</span>
<span class="sd">  step : float, optional</span>
<span class="sd">    Interval between grid points. Default is 1.</span>
<span class="sd">  units : one of &#39;seconds&#39;, &#39;minutes&#39;, &#39;hours&#39;, &#39;days&#39;, optional</span>
<span class="sd">    Unit in which to define time step values. Default is &#39;days&#39;.</span>
<span class="sd">  ref : string, optional</span>
<span class="sd">    Reference date for calendar. If the default None is specified, start is used.</span>
<span class="sd">  &#39;&#39;&#39;</span>
  <span class="kn">from</span> <span class="nn">.timeutils</span> <span class="kn">import</span> <span class="n">date_diff</span>
  <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
  <span class="n">tdum</span> <span class="o">=</span> <span class="n">ModelTime365</span><span class="p">(</span><span class="n">values</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span> <span class="n">startdate</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
  <span class="n">s</span> <span class="o">=</span> <span class="n">tdum</span><span class="o">.</span><span class="n">str_as_date</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">start</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">ref</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">f</span> <span class="o">=</span> <span class="n">s</span>
  <span class="k">else</span><span class="p">:</span> <span class="n">f</span> <span class="o">=</span> <span class="n">tdum</span><span class="o">.</span><span class="n">str_as_date</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">ref</span><span class="p">)</span>
  <span class="n">o</span> <span class="o">=</span> <span class="n">date_diff</span><span class="p">(</span><span class="n">tdum</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">units</span><span class="p">)</span>
  <span class="n">vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="o">*</span><span class="n">step</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span> <span class="o">+</span> <span class="n">o</span>
  <span class="k">return</span> <span class="n">ModelTime365</span><span class="p">(</span><span class="n">values</span><span class="o">=</span><span class="n">vals</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span> <span class="n">startdate</span><span class="o">=</span><span class="n">f</span><span class="p">)</span></div>
<span class="c1"># }}}</span>

<div class="viewcode-block" id="modeltime360range"><a class="viewcode-back" href="../../timeaxes.html#pygeode.timeaxis.modeltime360range">[docs]</a><span class="k">def</span> <span class="nf">modeltime360range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;days&#39;</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">inc</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="c1"># {{{</span>
  <span class="sa">r</span><span class="sd">&#39;&#39;&#39;Creates a :class:`ModelTime360` axis for the period from start to end.</span>

<span class="sd">  Parameters</span>
<span class="sd">  ==========</span>
<span class="sd">  start : string</span>
<span class="sd">    Date to start time axis from (see :meth:`~timeaxis.CalendarTime.str_as_val`)</span>
<span class="sd">  end : string</span>
<span class="sd">    Date to end time axis at. Note this date will not be included.</span>
<span class="sd">  step : float, optional</span>
<span class="sd">    Interval between grid points. Default is 1.</span>
<span class="sd">  units : one of &#39;seconds&#39;, &#39;minutes&#39;, &#39;hours&#39;, &#39;days&#39;, optional</span>
<span class="sd">    Unit in which to define time step values. Default is &#39;days&#39;.</span>
<span class="sd">  ref : string, optional</span>
<span class="sd">    Reference date for calendar. If the default None is specified, start is used.</span>
<span class="sd">  inc : boolean, optional (default False)</span>
<span class="sd">  &#39;&#39;&#39;</span>
  <span class="kn">from</span> <span class="nn">.timeutils</span> <span class="kn">import</span> <span class="n">date_diff</span>
  <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
  <span class="n">tdum</span> <span class="o">=</span> <span class="n">ModelTime360</span><span class="p">(</span><span class="n">values</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span> <span class="n">startdate</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
  <span class="n">s</span> <span class="o">=</span> <span class="n">tdum</span><span class="o">.</span><span class="n">str_as_date</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">start</span><span class="p">)</span>
  <span class="n">e</span> <span class="o">=</span> <span class="n">tdum</span><span class="o">.</span><span class="n">str_as_date</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">ref</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">f</span> <span class="o">=</span> <span class="n">s</span>
  <span class="k">else</span><span class="p">:</span> <span class="n">f</span> <span class="o">=</span> <span class="n">tdum</span><span class="o">.</span><span class="n">str_as_date</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">ref</span><span class="p">)</span>
  <span class="n">n</span> <span class="o">=</span> <span class="n">date_diff</span><span class="p">(</span><span class="n">tdum</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">units</span><span class="p">)</span>
  <span class="n">o</span> <span class="o">=</span> <span class="n">date_diff</span><span class="p">(</span><span class="n">tdum</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">units</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">inc</span><span class="p">:</span> <span class="n">vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span> <span class="o">+</span> <span class="n">step</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span> <span class="o">+</span> <span class="n">o</span>
  <span class="k">else</span><span class="p">:</span> <span class="n">vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span> <span class="o">+</span> <span class="n">o</span>
  <span class="k">return</span> <span class="n">ModelTime360</span><span class="p">(</span><span class="n">values</span><span class="o">=</span><span class="n">vals</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span> <span class="n">startdate</span><span class="o">=</span><span class="n">f</span><span class="p">)</span></div>
<span class="c1"># }}}</span>

<div class="viewcode-block" id="modeltime360n"><a class="viewcode-back" href="../../timeaxes.html#pygeode.timeaxis.modeltime360n">[docs]</a><span class="k">def</span> <span class="nf">modeltime360n</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;days&#39;</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="c1"># {{{</span>
  <span class="sa">r</span><span class="sd">&#39;&#39;&#39;Creates a :class:`ModelTime360` axis of length n.</span>

<span class="sd">  Parameters</span>
<span class="sd">  ==========</span>
<span class="sd">  start : string</span>
<span class="sd">    Date to start time axis from (see :meth:`~timeaxis.CalendarTime.str_as_val`)</span>
<span class="sd">  n : integer</span>
<span class="sd">    Length of axis to create</span>
<span class="sd">  step : float, optional</span>
<span class="sd">    Interval between grid points. Default is 1.</span>
<span class="sd">  units : one of &#39;seconds&#39;, &#39;minutes&#39;, &#39;hours&#39;, &#39;days&#39;, optional</span>
<span class="sd">    Unit in which to define time step values. Default is &#39;days&#39;.</span>
<span class="sd">  ref : string, optional</span>
<span class="sd">    Reference date for calendar. If the default None is specified, start is used.</span>
<span class="sd">  &#39;&#39;&#39;</span>
  <span class="kn">from</span> <span class="nn">.timeutils</span> <span class="kn">import</span> <span class="n">date_diff</span>
  <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
  <span class="n">tdum</span> <span class="o">=</span> <span class="n">ModelTime360</span><span class="p">(</span><span class="n">values</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span> <span class="n">startdate</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
  <span class="n">s</span> <span class="o">=</span> <span class="n">tdum</span><span class="o">.</span><span class="n">str_as_date</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">start</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">ref</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">f</span> <span class="o">=</span> <span class="n">s</span>
  <span class="k">else</span><span class="p">:</span> <span class="n">f</span> <span class="o">=</span> <span class="n">tdum</span><span class="o">.</span><span class="n">str_as_date</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">ref</span><span class="p">)</span>
  <span class="n">o</span> <span class="o">=</span> <span class="n">date_diff</span><span class="p">(</span><span class="n">tdum</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">units</span><span class="p">)</span>
  <span class="n">vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="o">*</span><span class="n">step</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span> <span class="o">+</span> <span class="n">o</span>
  <span class="k">return</span> <span class="n">ModelTime360</span><span class="p">(</span><span class="n">values</span><span class="o">=</span><span class="n">vals</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span> <span class="n">startdate</span><span class="o">=</span><span class="n">f</span><span class="p">)</span></div>
<span class="c1"># }}}</span>

<div class="viewcode-block" id="yearlessn"><a class="viewcode-back" href="../../timeaxes.html#pygeode.timeaxis.yearlessn">[docs]</a><span class="k">def</span> <span class="nf">yearlessn</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;days&#39;</span><span class="p">):</span>
<span class="c1"># {{{</span>
  <span class="sa">r</span><span class="sd">&#39;&#39;&#39;Creates a :class:`Yearless` axis of length n.</span>

<span class="sd">  Parameters</span>
<span class="sd">  ==========</span>
<span class="sd">  start : string</span>
<span class="sd">    Date to start time axis from (see :meth:`~timeaxis.CalendarTime.str_as_val`)</span>
<span class="sd">  n : integer</span>
<span class="sd">    Length of axis to create</span>
<span class="sd">  step : float, optional</span>
<span class="sd">    Interval between grid points. Default is 1.</span>
<span class="sd">  units : one of &#39;seconds&#39;, &#39;minutes&#39;, &#39;hours&#39;, &#39;days&#39;, optional</span>
<span class="sd">    Unit in which to define time step values. Default is &#39;days&#39;.</span>
<span class="sd">  &#39;&#39;&#39;</span>
  <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
  <span class="n">vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="o">*</span><span class="n">step</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">Yearless</span><span class="p">(</span><span class="n">values</span><span class="o">=</span><span class="n">vals</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span> <span class="n">startdate</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">day</span><span class="o">=</span><span class="n">start</span><span class="p">))</span></div>
<span class="c1"># }}}</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;StandardTime&#39;</span><span class="p">,</span> <span class="s1">&#39;ModelTime365&#39;</span><span class="p">,</span> <span class="s1">&#39;ModelTime360&#39;</span><span class="p">,</span> <span class="s1">&#39;Yearless&#39;</span><span class="p">,</span> <span class="s1">&#39;standardtimerange&#39;</span><span class="p">,</span> \
    <span class="s1">&#39;standardtimen&#39;</span><span class="p">,</span> <span class="s1">&#39;modeltime365range&#39;</span><span class="p">,</span> <span class="s1">&#39;modeltime365n&#39;</span><span class="p">,</span> <span class="s1">&#39;modeltime360range&#39;</span><span class="p">,</span> <span class="s1">&#39;modeltime360n&#39;</span><span class="p">,</span> \
    <span class="s1">&#39;yearlessn&#39;</span><span class="p">]</span>
</pre></div>

      </div>
      <div class="bottomnav" role="navigation" aria-label="bottom navigation">
      
        <p>
        <a class="uplink" href="../../reference.html">Reference</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../../tutorial.html">Tutorial</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../../gallery/index.html">Gallery</a>
        </p>

      </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2020, Mike Neish, Peter Hitchcock.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.3.2.
    </div>
  </body>
</html>