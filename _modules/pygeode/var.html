
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>pygeode.var &#8212; PyGeode 1.4.1rc1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/pygtheme.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-binder.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-dataframe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-rendered-html.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../../_static/pygeode_icon.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
<link href="http://fonts.googleapis.com/css?family=Ubuntu:300,300italic,regular,italic,500,500italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='http://fonts.googleapis.com/css?family=Ubuntu+Mono:400,700' rel='stylesheet' type='text/css'>

  </head><body>
      <div class="header" role="banner"><img class="logo" src="../../_static/pygeode_logo.png" width=79px alt="Logo"/>
        <h1 class="heading"><a href="../../index.html">
          <span>PyGeode 1.4.1rc1 documentation</span></a></h1>
        <h2 class="heading"><span>pygeode.var</span></h2>
      </div>
      <div class="topnav" role="navigation" aria-label="top navigation">
      
        <p>
        <a class="uplink" href="../../reference.html">Reference</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../../tutorial.html">Tutorial</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../../gallery/index.html">Gallery</a>
        </p>

      </div>
      <div class="content">
        
        
  <h1>Source code for pygeode.var</h1><div class="highlight"><pre>
<span></span>
<span class="c1"># Python functions for handling geophysical data</span>

<span class="c1"># These are dynamically generated objects, because we need to wrap the</span>
<span class="c1"># appropriate &#39;self&#39; at init-time (here) to abuse the [] notation.</span>
<span class="c1">#TODO - something more pythonic?</span>
<span class="k">class</span> <span class="nc">SL</span><span class="p">:</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="n">v</span>
  <span class="k">def</span> <span class="fm">__getitem__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slices</span><span class="p">):</span>  <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">_getitem_asvar</span><span class="p">(</span><span class="n">slices</span><span class="p">)</span>
  <span class="k">def</span> <span class="fm">__len__</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">)</span>

<span class="c1">#TODO: make Vars truly immutable (i.e. use &#39;slots&#39; or something?).  Then:</span>
<span class="c1">#TODO: get rid of dynamic references to axes (__getattr__) - causes too many headaches!</span>
<span class="c1">#NOTE: keep the name mutable, since it&#39;s something that will commonly be changed</span>
<span class="c1">#     (subclasses should never rely on an immutable name attribute)..</span>
<span class="c1">#TODO: seperate the metadata/attributes from the data handler.</span>
<span class="c1">#  (I.e., have a more simple Var object with just a &#39;getview&#39; or equivalent.</span>
<span class="c1">#    then, wrap this in another object with annotates it with a name,</span>
<span class="c1">#     attributes, axes, etc.)</span>
<span class="c1">#  This would make certain trivial operations (renaming, transposing, axis</span>
<span class="c1">#  replacement, etc.) more efficient, since the vars may go through several</span>
<span class="c1">#  permuations during their lifetime.  Currently, they accumulate layers of</span>
<span class="c1">#  wrappers.</span>
<div class="viewcode-block" id="Var"><a class="viewcode-back" href="../../var.html#pygeode.Var">[docs]</a><span class="k">class</span> <span class="nc">Var</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="c1"># {{{</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The base class of all data objects in PyGeode.  This is not usually</span>
<span class="sd">    instantiated directly, but rather it is extended by a subclass to do some</span>
<span class="sd">    particular operation.  The only case where you would use this directly is</span>
<span class="sd">    if you already have some data loaded in memory (perhaps through some other</span>
<span class="sd">    interface), and you wish to wrap it as a PyGeode data to do further</span>
<span class="sd">    operations on it.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    :doc:`axis`</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="c1"># Default attributes</span>

  <span class="c1">#: A description of the variable (may not be set).  Usually determined at the</span>
  <span class="c1">#: data source (e.g. input file), and may be used to identify the variable</span>
  <span class="c1">#: when saving to an output file.</span>
  <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="c1"># default name (blank)</span>

  <span class="c1">#: A string representation of the units of the variable.</span>
  <span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="c1"># default units (none)</span>

  <span class="c1">#: Formatting code to use for printing values.</span>
  <span class="n">formatstr</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%g</span><span class="s1">&#39;</span>

  <span class="c1">#: Dictionary of metadata associated with the variable.</span>
  <span class="n">atts</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># shared dictionary - replace this in init!</span>

  <span class="c1">#: Dictionary of attributes for plotting; see plotting documentation.</span>
  <span class="n">plotatts</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;plotscale&#39;</span><span class="p">:</span> <span class="s1">&#39;linear&#39;</span><span class="p">,</span>  <span class="c1"># default scale for plotting</span>
              <span class="s1">&#39;plotorder&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>  <span class="c1"># By default, plot with axis values increasing away from origin</span>

  <span class="c1">#: The axes of the variable. A ``tuple`` of :class:`Axis` instances.</span>
  <span class="n">axes</span> <span class="o">=</span> <span class="kc">None</span>

  <span class="c1">#: The number of axes of this variable.</span>
  <span class="n">naxes</span> <span class="o">=</span> <span class="mi">0</span>

  <span class="c1">#: The dimensions of this variable, as a ``tuple``. Similar to :attr:`numpy.ndarray.shape`.</span>
  <span class="n">shape</span> <span class="o">=</span> <span class="kc">None</span>

  <span class="c1">#: The total number of data points represented by this variable.</span>
  <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span>

  <span class="c1">#: The numerical type of the data as a :class:`numpy.dtype`. See also :meth:`Var.__init__`.</span>
  <span class="n">dtype</span> <span class="o">=</span> <span class="kc">None</span>

  <span class="c1">#: A helper to select subsets of this variable using slice notation. See :meth:`Var._getitem_asvar`.</span>
  <span class="nb">slice</span> <span class="o">=</span> <span class="kc">None</span>

  <span class="c1"># This method should be called by all subclasses</span>
<div class="viewcode-block" id="Var.__init__"><a class="viewcode-back" href="../../var.html#pygeode.Var.__init__">[docs]</a>  <span class="k">def</span> <span class="fm">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axes</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">atts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plotatts</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
  <span class="c1"># {{{</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a new Var object with the given axes and values.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    axes : list/tuple</span>
<span class="sd">        The :class:`Axis` objects to associate with each of the data dimensions</span>
<span class="sd">    dtype : string / Python type / numpy.dtype (optional)</span>
<span class="sd">        The numerical type of the data (can be automatically determined from</span>
<span class="sd">        the array)</span>
<span class="sd">    name : string (optional)</span>
<span class="sd">        What to call the variable (i.e. for plot titles &amp; when saving to file)</span>
<span class="sd">    values : numpy.ndarray</span>
<span class="sd">        The data to be wrapped.</span>
<span class="sd">    atts : dict (optional)</span>
<span class="sd">        Any additional metadata to associate with the variable. The dictionary</span>
<span class="sd">        keys should be strings.</span>
<span class="sd">    plotatts : dict (optional)</span>
<span class="sd">        Parameters that control plotting behaviour; default values are available.</span>
<span class="sd">        The dictionary keys should be strings.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    out : Var</span>
<span class="sd">      The array, wrapped as a Var object.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The :class:`Var` class can be instantiated directly (see `constructing-vars`),</span>
<span class="sd">    in which case providing an array for the values argument is necessary. Sub-classes</span>
<span class="sd">    of `Var` which define their values based on some operation need not provide any</span>
<span class="sd">    data; however all subclasses of :class:`Var` need to call this __init__ method within</span>
<span class="sd">    their own __init__, to properly initialize all attributes.</span>
<span class="sd">    &quot;&quot;&quot;</span>


    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
    <span class="kn">from</span> <span class="nn">pygeode.axis</span> <span class="kn">import</span> <span class="n">Axis</span>

    <span class="c1"># Convert the list of axes to a tuple</span>
    <span class="c1"># Since it is normally immutable - modifying the axes implies</span>
    <span class="c1"># changing the variable itself</span>
    <span class="c1"># Do this before calling &#39;hasattr&#39;, or you&#39;re in for a world of pain</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">Axis</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">axes</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">axes</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">naxes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="p">)</span>

    <span class="c1"># If we&#39;re given a Var as the input data, then we need to grab the data.</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">values</span><span class="p">,</span><span class="n">Var</span><span class="p">):</span> <span class="n">values</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

    <span class="c1"># Values stored in memory?</span>
    <span class="k">if</span> <span class="n">values</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">values</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
      <span class="c1"># Make values read-only (or at least difficult to change accidentally)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flags</span><span class="o">.</span><span class="n">writeable</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># Get the shape of the variable</span>
    <span class="c1"># Have to do this after setting self.values, otherwise this crashes</span>
    <span class="c1"># when initializing Axis objects (which call this init)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">)</span>

    <span class="c1"># Check the shape of the value array</span>
    <span class="k">if</span> <span class="n">values</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
      <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">naxes</span><span class="p">,</span> <span class="s2">&quot;ndim=</span><span class="si">%d</span><span class="s2">, naxes=</span><span class="si">%d</span><span class="s2">?&quot;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">ndim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">naxes</span><span class="p">)</span>
      <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s2">&quot;array shape does not match the given axes&quot;</span>

    <span class="c1"># Determine the type, if we&#39;re supplied the values...</span>
    <span class="k">if</span> <span class="n">dtype</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">values</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">dtype</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Can&#39;t determine dtype&quot;</span><span class="p">)</span>

    <span class="c1"># Convert dtype shortcuts like &#39;d&#39; to a standard name</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">dtype</span>

    <span class="c1"># handle meta data (create unique copy of each dictionary for each instance)</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">atts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">atts</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">atts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">atts</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">atts</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">plotatts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">plotatts</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">plotatts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">plotatts</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">plotatts</span><span class="p">)</span>
    <span class="c1"># Note: the default empty dict {} used to be set as a static thing right</span>
    <span class="c1"># after the &#39;class Var&#39; line, but this meant that all vars which weren&#39;t</span>
    <span class="c1"># assigned explicit attributes were sharing the same dict, so any post-init</span>
    <span class="c1"># modifications would be applied to *all* such vars!</span>
<span class="c1">#    if self.naxes == 0:</span>
<span class="c1">#      print &#39;STOP!&#39;</span>
<span class="c1">#      print &#39;Hammer time&#39;</span>
<span class="c1">#      raise Exception(&quot;You can&#39;t touch this&quot;)</span>

<span class="c1">#    # Shortcuts to the axes, referenced by name</span>
<span class="c1">#    axis_names = [a.name for a in axes]</span>
<span class="c1">#    for a in axes:</span>
<span class="c1">#      name = a.name</span>
<span class="c1">#      if axis_names.count(name) == 1:  # Unique occurrences only</span>
<span class="c1">#        setattr(self,name,a)</span>
<span class="c1"># note: this is currently done dynamically, to allow some fudging of the axes</span>

    <span class="c1"># Get the size of the var</span>
<span class="c1">#    self.size = np.prod(self.shape)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">:</span> <span class="n">x</span><span class="o">*</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Slicing notation</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">slice</span> <span class="o">=</span> <span class="n">SL</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

    <span class="c1"># If this is a Var (and not a subclass), then it is safe to lock</span>
    <span class="c1"># the attributes now, and prevent furthur changes.</span>
    <span class="c1">#if type(self) == Var: self._finalize()</span>

  <span class="c1"># }}}</span>

  <span class="c1"># Subset by integer indices - wrapped as Var object</span>
<div class="viewcode-block" id="Var._getitem_asvar"><a class="viewcode-back" href="../../varops.html#pygeode.Var._getitem_asvar">[docs]</a>  <span class="k">def</span> <span class="nf">_getitem_asvar</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slices</span><span class="p">):</span>
<span class="c1"># {{{</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Slice-based data subsetting.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    slices : list of slices</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    subset_var : Var</span>
<span class="sd">      A new Var, restricted to the specified domain.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    A helper function so that standard python slicing notation</span>
<span class="sd">    can be used to subset a Var without loading the underlying</span>
<span class="sd">    data. A new Var object is returned.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    Var.slice, Var.__call__, Var.__getitem__</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; from pygeode.tutorial import t1</span>
<span class="sd">    &gt;&gt;&gt; print(t1.Temp)</span>
<span class="sd">    &lt;Var &#39;Temp&#39;&gt;:</span>
<span class="sd">      Units: K  Shape:  (lat,lon)  (31,60)</span>
<span class="sd">      Axes:</span>
<span class="sd">        lat &lt;Lat&gt;      :  90 S to 90 N (31 values)</span>
<span class="sd">        lon &lt;Lon&gt;      :  0 E to 354 E (60 values)</span>
<span class="sd">      Attributes:</span>
<span class="sd">        {}</span>
<span class="sd">      Type:  Add_Var (dtype=&quot;float64&quot;)</span>
<span class="sd">    &gt;&gt;&gt; print(t1.Temp.slice[10:-10, ::10])</span>
<span class="sd">    &lt;Var &#39;Temp&#39;&gt;:</span>
<span class="sd">      Units: K  Shape:  (lat,lon)  (11,6)</span>
<span class="sd">      Axes:</span>
<span class="sd">        lat &lt;Lat&gt;      :  30 S to 30 N (11 values)</span>
<span class="sd">        lon &lt;Lon&gt;      :  0 E to 300 E (6 values)</span>
<span class="sd">      Attributes:</span>
<span class="sd">        {}</span>
<span class="sd">      Type:  SlicedVar (dtype=&quot;float64&quot;)</span>
<span class="sd">    &gt;&gt;&gt; print(t1.Temp.slice[17, :])</span>
<span class="sd">    &lt;Var &#39;Temp&#39;&gt;:</span>
<span class="sd">      Units: K  Shape:  (lat,lon)  (1,60)</span>
<span class="sd">      Axes:</span>
<span class="sd">        lat &lt;Lat&gt;      :  12 N</span>
<span class="sd">        lon &lt;Lon&gt;      :  0 E to 354 E (60 values)</span>
<span class="sd">      Attributes:</span>
<span class="sd">        {}</span>
<span class="sd">      Type:  SlicedVar (dtype=&quot;float64&quot;)</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="kn">from</span> <span class="nn">pygeode.varoperations</span> <span class="kn">import</span> <span class="n">SlicedVar</span>
    <span class="n">newvar</span> <span class="o">=</span> <span class="n">SlicedVar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slices</span><span class="p">)</span>

    <span class="c1"># Degenerate case: no slicing done?</span>
    <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">a1</span> <span class="ow">is</span> <span class="n">a2</span> <span class="k">for</span> <span class="n">a1</span><span class="p">,</span><span class="n">a2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">newvar</span><span class="o">.</span><span class="n">axes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">)):</span> <span class="k">return</span> <span class="bp">self</span>

<span class="c1">#    # Was the source var preloaded?</span>
<span class="c1">#    # If so, preload this slice as well</span>
<span class="c1">#    if hasattr(self,&#39;values&#39;): newvar = newvar.load(pbar=None)</span>

    <span class="k">return</span> <span class="n">newvar</span></div>
<span class="c1"># }}}</span>

  <span class="c1"># Subset by integer indices</span>
<div class="viewcode-block" id="Var.__getitem__"><a class="viewcode-back" href="../../var.get.html#pygeode.Var.__getitem__">[docs]</a>  <span class="k">def</span> <span class="fm">__getitem__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slices</span><span class="p">):</span>
<span class="c1"># {{{</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gets a raw numpy array containing a subset of values of the variable.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    slices : list of slices</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    out : numpy.ndarray</span>
<span class="sd">      The requested values, as a numpy array.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    Var.get, Var.slice, Var.__call__</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; from pygeode.tutorial import t1</span>
<span class="sd">    &gt;&gt;&gt; print(t1.Temp[:].shape)</span>
<span class="sd">    (31, 60)</span>
<span class="sd">    &gt;&gt;&gt; print(t1.Temp[20:-6, ::12])</span>
<span class="sd">    [[285.64721554 287.07380031 286.52889342 284.76553766 284.22063076]</span>
<span class="sd">     [281.09169696 282.80359869 282.14971042 280.03368351 279.37979523]</span>
<span class="sd">     [276.73945224 278.73667093 277.97380127 275.50510321 274.74223356]</span>
<span class="sd">     [272.82122084 275.10375648 274.23190545 271.41053624 270.5386852 ]</span>
<span class="sd">     [269.47711035 272.04496294 271.06413053 267.89009017 266.90925775]]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get the raw numpy array (with degenerate axes intact)</span>
    <span class="n">array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getitem_asvar</span><span class="p">(</span><span class="n">slices</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="c1"># If any single integer indices were passed, then reduce out those</span>
    <span class="c1"># dimensions.  This is consistent with what would happen with numpy slicing.</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">slices</span><span class="p">,</span><span class="nb">tuple</span><span class="p">):</span>
      <span class="n">extra_slicing</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="mi">0</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sl</span><span class="p">,</span><span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="bp">Ellipsis</span> <span class="k">if</span> <span class="n">sl</span> <span class="ow">is</span> <span class="bp">Ellipsis</span> <span class="k">else</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">sl</span> <span class="ow">in</span> <span class="n">slices</span><span class="p">)</span>
      <span class="n">array</span> <span class="o">=</span> <span class="n">array</span><span class="p">[</span><span class="n">extra_slicing</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">slices</span><span class="p">,</span><span class="nb">int</span><span class="p">):</span>
      <span class="n">array</span> <span class="o">=</span> <span class="n">array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">array</span></div>
<span class="c1"># }}}</span>

  <span class="c1"># Select a subset by keyword arguments (i.e., lat = (-45.0, 45.0))</span>
  <span class="c1"># Keys should be the name of the axis shortcut in the var (i.e., lat, lon, time).</span>
<div class="viewcode-block" id="Var.__call__"><a class="viewcode-back" href="../../varops.html#pygeode.Var.__call__">[docs]</a>  <span class="k">def</span> <span class="fm">__call__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ignore_mismatch</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
  <span class="c1"># {{{</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Keyword-based data subsetting.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ignore_mismatch : boolean (optional)</span>
<span class="sd">      If ``True``, any keywords that don&#39;t match an axis are ignored.</span>
<span class="sd">      Default is ``False``</span>

<span class="sd">    **kwargs : one or more keyword parameters</span>
<span class="sd">      The keys are the Axis names (or Axis class names), and the values are</span>
<span class="sd">      either a `tuple` of the desired (lower,upper) range, or a single Axis</span>
<span class="sd">      value.  E.g., ``lat = (-45,45)`` or ``lat = 10.5``</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    subset_var : Var</span>
<span class="sd">      A new Var, restricted  to the specified domain.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    There are a couple of special prefixes which can be prepended to each</span>
<span class="sd">    keyword to alter the subsetting behaviour. They can be used together.</span>

<span class="sd">      * **i_** indicates that the values are *indices* into the axis, and not</span>
<span class="sd">        the axis values themselves.  Indices start at 0.</span>
<span class="sd">        E.g. ``myvar(i_time = 0)`` selects the first time step of the variable,</span>
<span class="sd">        and ``myvar(i_lon=(10,20))`` selects the 11th through 21st longitudes.</span>

<span class="sd">      * **l_** indicates that you are providing an explicit list of</span>
<span class="sd">        coordinates, instead of a range.</span>
<span class="sd">        E.g. ``myvar(l_lon = (105.,106.,107.,108))``</span>

<span class="sd">      * **n_** returns the complement of the set you request; that is,</span>
<span class="sd">        everything except the specified selection.</span>
<span class="sd">        E.g. ``myvar(n_lat = (60, 90))`` returns all latitudes except those between 60 and 90N.</span>

<span class="sd">      * **m_** triggers an arithmetic mean over the specified range.</span>
<span class="sd">        E.g., ``myvar(m_lon = (10, 80))`` is a shortcut for doing</span>
<span class="sd">        ``myvar(lon = (10,80)).mean(&#39;lon&#39;)``.</span>

<span class="sd">      * **s_** triggers a call to squeeze on the specified axis, so</span>
<span class="sd">        that if only one value is selected the degenerate axis is removed.</span>
<span class="sd">        E.g., ``myvar(s_lon = 5)`` is a shortcut for doing</span>
<span class="sd">        ``myvar(lon = 5).squeeze()`` or ``myvar.squeeze(lon=5)``.</span>


<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; from pygeode.tutorial import t1</span>
<span class="sd">    &gt;&gt;&gt; print(t1.vars)</span>
<span class="sd">    [&lt;Var &#39;Temp&#39;&gt;]</span>
<span class="sd">    &gt;&gt;&gt; T = t1.Temp</span>
<span class="sd">    &gt;&gt;&gt; print(T)</span>
<span class="sd">    &lt;Var &#39;Temp&#39;&gt;:</span>
<span class="sd">      Units: K  Shape:  (lat,lon)  (31,60)</span>
<span class="sd">      Axes:</span>
<span class="sd">        lat &lt;Lat&gt;      :  90 S to 90 N (31 values)</span>
<span class="sd">        lon &lt;Lon&gt;      :  0 E to 354 E (60 values)</span>
<span class="sd">      Attributes:</span>
<span class="sd">        {}</span>
<span class="sd">      Type:  Add_Var (dtype=&quot;float64&quot;)</span>
<span class="sd">    &gt;&gt;&gt; print(T(lat=30,lon=(100,200)))</span>
<span class="sd">    &lt;Var &#39;Temp&#39;&gt;:</span>
<span class="sd">      Units: K  Shape:  (lat,lon)  (1,17)</span>
<span class="sd">      Axes:</span>
<span class="sd">        lat &lt;Lat&gt;      :  30 N</span>
<span class="sd">        lon &lt;Lon&gt;      :  102 E to 198 E (17 values)</span>
<span class="sd">      Attributes:</span>
<span class="sd">        {}</span>
<span class="sd">      Type:  SlicedVar (dtype=&quot;float64&quot;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Check for mean axes</span>
    <span class="c1"># (kind of a hack... prepend an &#39;m_&#39; to the keyword)</span>
    <span class="c1"># i.e., var(m_lon=(30,40)) is equivalent to var(lon=(30,40)).mean(&#39;lon&#39;)</span>

    <span class="n">means</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">squeezes</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">newargs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
      <span class="c1"># Detect special prefixes.</span>
      <span class="k">if</span> <span class="s1">&#39;_&#39;</span> <span class="ow">in</span> <span class="n">k</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">hasaxis</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
        <span class="n">prefix</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">prefix</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">k</span>

      <span class="k">if</span> <span class="s1">&#39;m&#39;</span> <span class="ow">in</span> <span class="n">prefix</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">hasaxis</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span> <span class="ow">and</span> <span class="n">ignore_mismatch</span><span class="p">:</span> <span class="k">continue</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">hasaxis</span><span class="p">(</span><span class="n">ax</span><span class="p">),</span> <span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39; is not a valid axis for var &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">means</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="n">prefix</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

      <span class="k">if</span> <span class="s1">&#39;s&#39;</span> <span class="ow">in</span> <span class="n">prefix</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">hasaxis</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span> <span class="ow">and</span> <span class="n">ignore_mismatch</span><span class="p">:</span> <span class="k">continue</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">hasaxis</span><span class="p">(</span><span class="n">ax</span><span class="p">),</span> <span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39; is not a valid axis for var &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ax</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">means</span><span class="p">:</span> <span class="n">squeezes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="n">prefix</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">k</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">prefix</span><span class="p">,</span> <span class="n">ax</span><span class="p">])</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">ax</span>

      <span class="n">newargs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

    <span class="c1"># Get the slices, apply to the variable</span>
    <span class="n">slices</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">get_slice</span><span class="p">(</span><span class="n">newargs</span><span class="p">,</span> <span class="n">ignore_mismatch</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">]</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">newargs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">ignore_mismatch</span><span class="p">,</span> <span class="s2">&quot;Unmatched slices remain: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">newargs</span><span class="p">)</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getitem_asvar</span><span class="p">(</span><span class="n">slices</span><span class="p">)</span>

    <span class="c1"># Any means or squeezes requested?</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">means</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">ret</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="o">*</span><span class="n">means</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">squeezes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">ret</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="o">*</span><span class="n">squeezes</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ret</span></div>
  <span class="c1"># }}}</span>

  <span class="c1"># Avoid accidentally iterating over vars</span>
  <span class="k">def</span> <span class="fm">__iter__</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="c1"># {{{</span>
    <span class="k">raise</span> <span class="ne">Exception</span> <span class="p">(</span><span class="s2">&quot;Var instances cannot be iterated over&quot;</span><span class="p">)</span>
<span class="c1"># }}}</span>

  <span class="c1"># Include axes names</span>
  <span class="k">def</span> <span class="fm">__dir__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="c1"># {{{</span>
    <span class="n">l</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">+</span> <span class="nb">dir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">l</span> <span class="o">+</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">]</span>
<span class="c1"># }}}</span>

  <span class="c1"># Shortcuts to axes</span>
  <span class="c1"># (handled dynamically, in case some fudging is done to the var)</span>
  <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
<span class="c1"># {{{</span>
    <span class="c1"># Disregard metaclass stuff</span>
    <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;__&#39;</span><span class="p">):</span> <span class="k">raise</span> <span class="ne">AttributeError</span>

<span class="c1">#    print &#39;var getattr ??&#39;, name</span>


    <span class="c1"># Some things that we *know* should not be axis shortcuts</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;axes&#39;</span><span class="p">,</span> <span class="s1">&#39;values&#39;</span><span class="p">):</span>
      <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getaxis</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">AttributeError</span> <span class="p">(</span><span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39; not found in </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="p">)))</span>

    <span class="k">raise</span> <span class="ne">AttributeError</span> <span class="p">(</span><span class="n">name</span><span class="p">)</span>
<span class="c1"># }}}</span>


  <span class="c1"># Modifies __setattr__ and __delattr__ to avoid further modifications to the Var</span>
  <span class="c1"># (should be called by any Var subclasses at the end of their __init__)</span>
  <span class="k">def</span> <span class="nf">_finalize</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="c1"># {{{</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__setattr__</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dont_setattr</span><span class="p">:</span>
      <span class="kn">from</span> <span class="nn">warnings</span> <span class="kn">import</span> <span class="n">warn</span>
      <span class="n">warn</span> <span class="p">(</span><span class="s2">&quot;already finalized the var&quot;</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
      <span class="k">return</span>
    <span class="bp">self</span><span class="o">.</span><span class="fm">__delattr__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dont_delattr</span>
    <span class="bp">self</span><span class="o">.</span><span class="fm">__setattr__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dont_setattr</span>
<span class="c1"># }}}</span>

  <span class="c1"># Send all attribute requests through here, to enforce immutability</span>
  <span class="k">def</span> <span class="nf">_dont_setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">value</span><span class="p">):</span>
<span class="c1"># {{{</span>
    <span class="c1"># Can only modify the var name</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">!=</span> <span class="s1">&#39;name&#39;</span><span class="p">:</span>
<span class="c1">#      raise TypeError (&quot;can&#39;t modify an immutable Var&quot;)</span>
      <span class="kn">from</span> <span class="nn">warnings</span> <span class="kn">import</span> <span class="n">warn</span>
      <span class="n">warn</span> <span class="p">(</span><span class="s2">&quot;shouldn&#39;t be modifying an immutable Var&quot;</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">value</span><span class="p">)</span>
<span class="c1"># }}}</span>

  <span class="k">def</span> <span class="nf">_dont_delattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">):</span>
<span class="c1"># {{{</span>
<span class="c1">#    raise TypeError (&quot;can&#39;t modify an immutable Var&quot;)</span>
    <span class="kn">from</span> <span class="nn">warnings</span> <span class="kn">import</span> <span class="n">warn</span>
    <span class="n">warn</span> <span class="p">(</span><span class="s2">&quot;shouldn&#39;t be modifying an immutable Var&quot;</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="nb">object</span><span class="o">.</span><span class="fm">__delattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>
<span class="c1"># }}}</span>

  <span class="c1"># Get an axis based on its class</span>
  <span class="c1"># ie, somevar.getaxis(ZAxis)</span>
<div class="viewcode-block" id="Var.getaxis"><a class="viewcode-back" href="../../varquery.html#pygeode.Var.getaxis">[docs]</a>  <span class="k">def</span> <span class="nf">getaxis</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iaxis</span><span class="p">):</span>
  <span class="c1"># {{{</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Grabs a reference to a particular :class:`Axis` associated with this variable.</span>

<span class="sd">      Parameters</span>
<span class="sd">      ----------</span>
<span class="sd">      iaxis : string, :class:`Axis` class, or int</span>
<span class="sd">        The search criteria for finding the class.</span>

<span class="sd">      Returns</span>
<span class="sd">      -------</span>
<span class="sd">      axis : :class:`Axis` object that matches.  Raises ``KeyError`` if there is no match.</span>

<span class="sd">      See Also</span>
<span class="sd">      --------</span>
<span class="sd">      whichaxis, hasaxis, Axis</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">whichaxis</span><span class="p">(</span><span class="n">iaxis</span><span class="p">)]</span></div>
  <span class="c1"># }}}</span>

  <span class="c1"># Get the index of an axis given its class (or a string)</span>
  <span class="c1"># (similar to above, but return the index, not the Axis itself)</span>
<div class="viewcode-block" id="Var.whichaxis"><a class="viewcode-back" href="../../varquery.html#pygeode.Var.whichaxis">[docs]</a>  <span class="k">def</span> <span class="nf">whichaxis</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iaxis</span><span class="p">):</span>
  <span class="c1"># {{{</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Locates a particular :class:`Axis` associated with this variable.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    iaxis : string, :class:`Axis` class, or int</span>
<span class="sd">      The search criteria for finding the class.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    i : The index of the matching Axis.  Raises ``KeyError`` if there is no match.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; from pygeode.tutorial import t1</span>
<span class="sd">    &gt;&gt;&gt; T = t1.Temp</span>
<span class="sd">    &gt;&gt;&gt; print(T.axes)</span>
<span class="sd">    (&lt;Lat&gt;, &lt;Lon&gt;)</span>
<span class="sd">    &gt;&gt;&gt; print(T.whichaxis(&#39;lat&#39;))</span>
<span class="sd">    0</span>
<span class="sd">    &gt;&gt;&gt; print(T.whichaxis(&#39;lon&#39;))</span>
<span class="sd">    1</span>
<span class="sd">    &gt;&gt;&gt; print(T.whichaxis(&#39;time&#39;))</span>
<span class="sd">    Traceback (most recent call last):</span>
<span class="sd">      File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;</span>
<span class="sd">      File &quot;/usr/local/lib/python2.6/dist-packages/pygeode/var.py&quot;, line 352, in whichaxis</span>
<span class="sd">        raise KeyError, &quot;axis %s not found in %s&quot;%(repr(iaxis),self.axes)</span>
<span class="sd">    KeyError: &quot;axis &#39;time&#39; not found in (&lt;Lat&gt;, &lt;Lon&gt;)&quot;</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    getaxis, hasaxis, Axis</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">pygeode.tools</span> <span class="kn">import</span> <span class="n">whichaxis</span>
    <span class="k">return</span> <span class="n">whichaxis</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">,</span> <span class="n">iaxis</span><span class="p">)</span></div>
  <span class="c1"># }}}</span>

  <span class="c1"># Indicate if an axis is found</span>
<div class="viewcode-block" id="Var.hasaxis"><a class="viewcode-back" href="../../varquery.html#pygeode.Var.hasaxis">[docs]</a>  <span class="k">def</span> <span class="nf">hasaxis</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iaxis</span><span class="p">):</span>
  <span class="c1"># {{{</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Determines if a particular :class:`Axis` is associated with this variable.</span>

<span class="sd">      Parameters</span>
<span class="sd">      ----------</span>
<span class="sd">      iaxis : string, :class:`Axis` class, or int</span>
<span class="sd">        The search criteria for finding the class.</span>

<span class="sd">      Returns</span>
<span class="sd">      -------</span>
<span class="sd">      found : boolean.  ``True`` if found, otherwise ``False``</span>

<span class="sd">      See Also</span>
<span class="sd">      --------</span>
<span class="sd">      getaxis, whichaxis, Axis</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span> <span class="n">i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">whichaxis</span><span class="p">(</span><span class="n">iaxis</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span> <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="kc">True</span></div>
  <span class="c1"># }}}</span>

<div class="viewcode-block" id="Var.formatvalue"><a class="viewcode-back" href="../../var.html#pygeode.Var.formatvalue">[docs]</a>  <span class="k">def</span> <span class="nf">formatvalue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">unitstr</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
  <span class="c1"># {{{</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Returns formatted string representation of ``value``.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    value : float or int</span>
<span class="sd">      Value to format.</span>
<span class="sd">    fmt : string (optional)</span>
<span class="sd">      Format specification. If the default ``None`` is specified,</span>
<span class="sd">      ``self.formatstr`` is used.</span>
<span class="sd">    units : boolean (optional)</span>
<span class="sd">      If ``True``, will include the units in the string returned.</span>
<span class="sd">      Default is ``True``.</span>
<span class="sd">    unitstr : string (optional)</span>
<span class="sd">      String to use for the units; default is ``self.units``.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    If units is True, fmt % value + &#39; &#39; + unitstr. Otherwise fmt % value.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    This is overridden in a number of Axis classes for more sophisticated formatting.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="n">fmt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">fmt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">formatstr</span>
    <span class="n">strval</span> <span class="o">=</span> <span class="n">fmt</span> <span class="o">%</span> <span class="n">value</span>

    <span class="k">if</span> <span class="n">units</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">unitstr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">unitstr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span>
      <span class="n">strval</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">unitstr</span>

    <span class="k">return</span> <span class="n">strval</span></div>
  <span class="c1"># }}}</span>

  <span class="c1"># Pretty printing</span>
  <span class="k">def</span> <span class="fm">__str__</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>
  <span class="c1"># {{{</span>
    <span class="kn">import</span> <span class="nn">textwrap</span>

    <span class="n">s</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;:</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
      <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;  Units: &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;  Shape:&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;  (&#39;</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;  (&#39;</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">))</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;)</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;  Axes:</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">:</span>
      <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;    &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>

    <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;  Attributes:</span><span class="se">\n</span><span class="s1">&#39;</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;    </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span>

    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
      <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;    &#39;</span> <span class="o">+</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">shorten</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="mi">15</span><span class="p">)</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span> \
           <span class="o">+</span> <span class="s1">&#39;: &#39;</span> <span class="o">+</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">shorten</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">),</span> <span class="mi">59</span><span class="p">)</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">59</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>

    <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;  Type:  </span><span class="si">%s</span><span class="s1"> (dtype=&quot;</span><span class="si">%s</span><span class="s1">&quot;)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">s</span>
  <span class="c1"># }}}</span>

  <span class="k">def</span> <span class="fm">__repr__</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>
  <span class="c1"># {{{</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
<span class="c1">#      return &#39;&lt;&#39; + self.__class__.__name__ + &quot; &#39;&quot; + self.name + &quot;&#39;&gt;&quot;</span>
      <span class="k">return</span> <span class="s2">&quot;&lt;Var &#39;&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;&#39;&gt;&quot;</span>
    <span class="k">return</span> <span class="s1">&#39;&lt;Var&gt;&#39;</span>
  <span class="c1"># }}}</span>

<div class="viewcode-block" id="Var.get"><a class="viewcode-back" href="../../var.get.html#pygeode.Var.get">[docs]</a>  <span class="k">def</span> <span class="nf">get</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pbar</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
  <span class="c1"># {{{</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gets a raw numpy array containing the values of the variable.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pbar : boolean (optional)</span>
<span class="sd">      If ``True``, will display a progress bar while the data is being</span>
<span class="sd">      retrieved.  This requires the *python-progressbar* package (not included</span>
<span class="sd">      with PyGeode).</span>

<span class="sd">    **kwargs : keyword arguments (optional)</span>
<span class="sd">      One or more keyword arguments may be included to subset the variable</span>
<span class="sd">      before grabbing the data.  See :func:`Var.__call__` for a similar</span>
<span class="sd">      method which uses this keyword subsetting.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    out : numpy.ndarray</span>
<span class="sd">      The requested values, as a numpy array.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>

<span class="sd">    Once you grab the data as a numpy array, you can no longer use the PyGeode</span>
<span class="sd">    functions to do further work on it directly.  You can, however, use</span>
<span class="sd">    :func:`Var.__init__` to re-wrap your numpy array as a PyGeode Var.  This</span>
<span class="sd">    may be useful if you want to do some very complicated operations on the</span>
<span class="sd">    data using the numpy interface as an intermediate step.</span>

<span class="sd">    PyGeode variables can be huge!  They can be larger than the available RAM</span>
<span class="sd">    in your computer, or even larger than your hard disk.  Numpy arrays, on</span>
<span class="sd">    the other hand, need to fit in memory, so make sure you are only getting</span>
<span class="sd">    a reasonable piece of data at a time.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; from pygeode.tutorial import t1</span>
<span class="sd">    &gt;&gt;&gt; print(t1.Temp)</span>
<span class="sd">    &lt;Var &#39;Temp&#39;&gt;:</span>
<span class="sd">      Units: K  Shape:  (lat,lon)  (31,60)</span>
<span class="sd">      Axes:</span>
<span class="sd">        lat &lt;Lat&gt;      :  90 S to 90 N (31 values)</span>
<span class="sd">        lon &lt;Lon&gt;      :  0 E to 354 E (60 values)</span>
<span class="sd">      Attributes:</span>
<span class="sd">        {}</span>
<span class="sd">      Type:  Add_Var (dtype=&quot;float64&quot;)</span>
<span class="sd">    &gt;&gt;&gt; x = t1.Temp.get()</span>
<span class="sd">    &gt;&gt;&gt; print(x)</span>
<span class="sd">    [[260.73262556 258.08759192 256.45287123 ... 265.01237988 265.01237988</span>
<span class="sd">      263.37765919]</span>
<span class="sd">     [261.22683172 258.75813366 257.23239435 ... 265.22126909 265.22126909</span>
<span class="sd">      263.69552978]</span>
<span class="sd">     [261.98265134 259.69028886 258.27353093 ... 265.69177175 265.69177175</span>
<span class="sd">      264.27501382]</span>
<span class="sd">     ...</span>
<span class="sd">     [261.98265134 264.27501382 265.69177175 ... 258.27353093 258.27353093</span>
<span class="sd">      259.69028886]</span>
<span class="sd">     [261.22683172 263.69552978 265.22126909 ... 257.23239435 257.23239435</span>
<span class="sd">      258.75813366]</span>
<span class="sd">     [260.73262556 263.37765919 265.01237988 ... 256.45287123 256.45287123</span>
<span class="sd">      258.08759192]]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">pygeode.view</span> <span class="kn">import</span> <span class="n">View</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
    <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">View</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">axes</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">var</span><span class="p">,</span><span class="n">pbar</span><span class="o">=</span><span class="n">pbar</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
      <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data</span></div>
  <span class="c1"># }}}</span>

<div class="viewcode-block" id="Var.getweights"><a class="viewcode-back" href="../../varquery.html#pygeode.Var.getweights">[docs]</a>  <span class="k">def</span> <span class="nf">getweights</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iaxes</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
  <span class="c1"># {{{</span>
    <span class="sd">&#39;&#39;&#39; Returns weights associated with the axes of this variable.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    iaxes : list of axis identifiers (string, :class:`Axis`, or int) (optional)</span>
<span class="sd">      Axes over which to compute the weights</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    weights : :class:`Var`</span>
<span class="sd">      defined on the subgrid of this variable on which weights are defined.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    Axis.__init__</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># Add weights object if any of the axes are weighted</span>
    <span class="c1"># Take outer product of weights if present on more than one axis</span>
    <span class="k">if</span> <span class="n">iaxes</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">iaxes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
      <span class="n">axes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">getaxis</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">iaxes</span><span class="p">]</span>
    <span class="n">wt</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">a</span><span class="o">.</span><span class="n">auxasvar</span><span class="p">(</span><span class="s1">&#39;weights&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">axes</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="s1">&#39;weights&#39;</span><span class="p">)])</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">wt</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<span class="c1">#      return None</span>
      <span class="k">return</span> <span class="n">Var</span><span class="p">(</span><span class="n">axes</span><span class="o">=</span><span class="p">[],</span> <span class="n">values</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>  <span class="c1"># Return degenerate variable?</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="kn">from</span> <span class="nn">pygeode.ufunc</span> <span class="kn">import</span> <span class="n">vprod</span>
      <span class="k">return</span> <span class="n">vprod</span><span class="p">(</span><span class="o">*</span><span class="n">wt</span><span class="p">)</span> <span class="c1"># Variable-wise product of weights</span></div>
  <span class="c1"># }}}</span>

  <span class="c1"># Preload the values of a variable</span>
  <span class="c1"># If the values are already loaded, then return self</span>
<div class="viewcode-block" id="Var.load"><a class="viewcode-back" href="../../var.get.html#pygeode.Var.load">[docs]</a>  <span class="k">def</span> <span class="nf">load</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pbar</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
  <span class="c1"># {{{</span>
    <span class="sd">&#39;&#39;&#39; Returns a version of this variable with all data loaded into memory.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pbar : boolean</span>
<span class="sd">      If True, display a progress bar while loading data.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="kn">from</span> <span class="nn">pygeode.progress</span> <span class="kn">import</span> <span class="n">PBar</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;values&#39;</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span>
    <span class="k">if</span> <span class="n">pbar</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
      <span class="n">pbar</span> <span class="o">=</span> <span class="n">PBar</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s2">&quot;Loading </span><span class="si">%s</span><span class="s2">:&quot;</span><span class="o">%</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
    <span class="n">var</span> <span class="o">=</span> <span class="n">Var</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pbar</span><span class="o">=</span><span class="n">pbar</span><span class="p">))</span>
    <span class="n">copy_meta</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">var</span></div>
  <span class="c1"># }}}</span>

  <span class="c1"># Plotting helper functions</span>
<div class="viewcode-block" id="Var.formatter"><a class="viewcode-back" href="../../var.html#pygeode.Var.formatter">[docs]</a>  <span class="k">def</span> <span class="nf">formatter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
  <span class="c1"># {{{</span>
    <span class="sd">&#39;&#39;&#39;Returns a matplotlib formatter (pygeode.AxisFormatter) for use in plotting. &#39;&#39;&#39;</span>
    <span class="kn">from</span> <span class="nn">pygeode.axis</span> <span class="kn">import</span> <span class="n">AxisFormatter</span>
    <span class="k">return</span> <span class="n">AxisFormatter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>
  <span class="c1"># }}}</span>

<div class="viewcode-block" id="Var.locator"><a class="viewcode-back" href="../../var.html#pygeode.Var.locator">[docs]</a>  <span class="k">def</span> <span class="nf">locator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
  <span class="c1"># {{{</span>
    <span class="sd">&#39;&#39;&#39;Returns a matplotlib locator object for use in plotting.&#39;&#39;&#39;</span>
    <span class="kn">import</span> <span class="nn">pylab</span> <span class="k">as</span> <span class="nn">pyl</span>
    <span class="n">scl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plotatts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;plotscale&#39;</span><span class="p">,</span> <span class="s1">&#39;linear&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">scl</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span> <span class="k">return</span> <span class="n">pyl</span><span class="o">.</span><span class="n">LogLocator</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="n">pyl</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">()</span></div></div>
  <span class="c1"># }}}</span>
<span class="c1"># }}}</span>

<span class="c1"># a function to copy metadata from one variable to another</span>
<span class="k">def</span> <span class="nf">copy_meta</span> <span class="p">(</span><span class="n">invar</span><span class="p">,</span> <span class="n">outvar</span><span class="p">,</span> <span class="n">plotatts</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="c1"># {{{</span>
  <span class="n">outvar</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">invar</span><span class="o">.</span><span class="n">name</span>
  <span class="n">outvar</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">invar</span><span class="o">.</span><span class="n">units</span>
  <span class="n">outvar</span><span class="o">.</span><span class="n">atts</span> <span class="o">=</span> <span class="n">invar</span><span class="o">.</span><span class="n">atts</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
  <span class="k">if</span> <span class="n">plotatts</span><span class="p">:</span> <span class="n">outvar</span><span class="o">.</span><span class="n">plotatts</span> <span class="o">=</span> <span class="n">invar</span><span class="o">.</span><span class="n">plotatts</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="c1"># }}}</span>

<span class="c1"># a function to try and combine metadata from multiple inputs into an output</span>
<span class="c1"># (similar to copy_meta, but takes multiple input variables)</span>
<span class="k">def</span> <span class="nf">combine_meta</span> <span class="p">(</span><span class="n">invars</span><span class="p">,</span> <span class="n">outvar</span><span class="p">):</span>
<span class="c1"># {{{</span>
  <span class="kn">from</span> <span class="nn">pygeode.tools</span> <span class="kn">import</span> <span class="n">common_dict</span>
  <span class="kn">from</span> <span class="nn">pygeode</span> <span class="kn">import</span> <span class="n">Axis</span>
  <span class="c1"># Intrinsic attributes</span>
  <span class="k">for</span> <span class="n">att</span> <span class="ow">in</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;units&#39;</span><span class="p">:</span>
    <span class="n">s</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="nb">getattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">att</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">invars</span><span class="p">]))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="nb">setattr</span><span class="p">(</span><span class="n">outvar</span><span class="p">,</span><span class="n">att</span><span class="p">,</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
  <span class="c1"># Get common metadata from the input segments</span>
  <span class="c1"># *Set* these attributes, don&#39;t &#39;update&#39; the dictionaries!</span>
  <span class="c1"># This method may be called from the __init__ of a Var subclass, before the</span>
  <span class="c1"># dictionaries are properly created - the existing &#39;atts&#39; and &#39;plotatts&#39; may</span>
  <span class="c1"># be a shared dictionary! Skip Axis objects for the plotatts dict (see issue 53)</span>
  <span class="n">outvar</span><span class="o">.</span><span class="n">atts</span> <span class="o">=</span> <span class="n">common_dict</span><span class="p">([</span><span class="n">v</span><span class="o">.</span><span class="n">atts</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">invars</span><span class="p">])</span>
  <span class="n">outvar</span><span class="o">.</span><span class="n">plotatts</span> <span class="o">=</span> <span class="n">common_dict</span><span class="p">([</span><span class="n">v</span><span class="o">.</span><span class="n">plotatts</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">invars</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">Axis</span><span class="p">)])</span>
<span class="c1"># }}}</span>


<span class="c1">##################################################</span>
<span class="c1"># Hook various useful methods into the Var class.</span>
<span class="c1"># We can&#39;t define these in the class definition, because it would create</span>
<span class="c1"># a circular reference.</span>
<span class="c1">##################################################</span>

<span class="c1"># Numeric operations</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">ndarray</span> <span class="k">as</span> <span class="n">nd</span>
<span class="kn">from</span> <span class="nn">pygeode.ufunc</span> <span class="kn">import</span> <span class="n">wrap_unary</span><span class="p">,</span> <span class="n">wrap_binary</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">reduce</span>
<span class="n">Var</span><span class="o">.</span><span class="fm">__add__</span>  <span class="o">=</span> <span class="n">wrap_binary</span><span class="p">(</span><span class="n">nd</span><span class="o">.</span><span class="fm">__add__</span><span class="p">,</span>  <span class="n">symbol</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">)</span>
<span class="n">Var</span><span class="o">.</span><span class="fm">__radd__</span> <span class="o">=</span> <span class="n">wrap_binary</span><span class="p">(</span><span class="n">nd</span><span class="o">.</span><span class="fm">__radd__</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">)</span>
<span class="n">Var</span><span class="o">.</span><span class="fm">__sub__</span>  <span class="o">=</span> <span class="n">wrap_binary</span><span class="p">(</span><span class="n">nd</span><span class="o">.</span><span class="fm">__sub__</span><span class="p">,</span>  <span class="n">symbol</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
<span class="n">Var</span><span class="o">.</span><span class="fm">__rsub__</span> <span class="o">=</span> <span class="n">wrap_binary</span><span class="p">(</span><span class="n">nd</span><span class="o">.</span><span class="fm">__rsub__</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
<span class="n">Var</span><span class="o">.</span><span class="fm">__mul__</span>  <span class="o">=</span> <span class="n">wrap_binary</span><span class="p">(</span><span class="n">nd</span><span class="o">.</span><span class="fm">__mul__</span><span class="p">,</span>  <span class="n">symbol</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">)</span>
<span class="n">Var</span><span class="o">.</span><span class="fm">__rmul__</span> <span class="o">=</span> <span class="n">wrap_binary</span><span class="p">(</span><span class="n">nd</span><span class="o">.</span><span class="fm">__rmul__</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">)</span>
<span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">nd</span><span class="p">,</span><span class="s1">&#39;__div__&#39;</span><span class="p">):</span>  <span class="c1"># Python2</span>
  <span class="n">Var</span><span class="o">.</span><span class="n">__div__</span>  <span class="o">=</span> <span class="n">wrap_binary</span><span class="p">(</span><span class="n">nd</span><span class="o">.</span><span class="n">__div__</span><span class="p">,</span>  <span class="n">symbol</span><span class="o">=</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
  <span class="n">Var</span><span class="o">.</span><span class="n">__rdiv__</span> <span class="o">=</span> <span class="n">wrap_binary</span><span class="p">(</span><span class="n">nd</span><span class="o">.</span><span class="n">__rdiv__</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>  <span class="c1"># Python3</span>
  <span class="n">Var</span><span class="o">.</span><span class="fm">__truediv__</span>  <span class="o">=</span> <span class="n">wrap_binary</span><span class="p">(</span><span class="n">nd</span><span class="o">.</span><span class="fm">__truediv__</span><span class="p">,</span>  <span class="n">symbol</span><span class="o">=</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
  <span class="n">Var</span><span class="o">.</span><span class="fm">__rtruediv__</span> <span class="o">=</span> <span class="n">wrap_binary</span><span class="p">(</span><span class="n">nd</span><span class="o">.</span><span class="fm">__rtruediv__</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
<span class="n">Var</span><span class="o">.</span><span class="fm">__pow__</span>  <span class="o">=</span> <span class="n">wrap_binary</span><span class="p">(</span><span class="n">nd</span><span class="o">.</span><span class="fm">__pow__</span><span class="p">,</span>  <span class="n">symbol</span><span class="o">=</span><span class="s1">&#39;**&#39;</span><span class="p">)</span>
<span class="n">Var</span><span class="o">.</span><span class="fm">__rpow__</span> <span class="o">=</span> <span class="n">wrap_binary</span><span class="p">(</span><span class="n">nd</span><span class="o">.</span><span class="fm">__rpow__</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="s1">&#39;**&#39;</span><span class="p">)</span>
<span class="n">Var</span><span class="o">.</span><span class="fm">__mod__</span>  <span class="o">=</span> <span class="n">wrap_binary</span><span class="p">(</span><span class="n">nd</span><span class="o">.</span><span class="fm">__mod__</span><span class="p">,</span>  <span class="n">symbol</span><span class="o">=</span><span class="s1">&#39;%&#39;</span><span class="p">)</span>
<span class="n">Var</span><span class="o">.</span><span class="fm">__rmod__</span> <span class="o">=</span> <span class="n">wrap_binary</span><span class="p">(</span><span class="n">nd</span><span class="o">.</span><span class="fm">__rmod__</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="s1">&#39;%&#39;</span><span class="p">)</span>

<span class="n">Var</span><span class="o">.</span><span class="fm">__lt__</span> <span class="o">=</span> <span class="n">wrap_binary</span><span class="p">(</span><span class="n">nd</span><span class="o">.</span><span class="fm">__lt__</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="s1">&#39;&lt;&#39;</span><span class="p">)</span>
<span class="n">Var</span><span class="o">.</span><span class="fm">__le__</span> <span class="o">=</span> <span class="n">wrap_binary</span><span class="p">(</span><span class="n">nd</span><span class="o">.</span><span class="fm">__le__</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="s1">&#39;&lt;=&#39;</span><span class="p">)</span>
<span class="n">Var</span><span class="o">.</span><span class="fm">__gt__</span> <span class="o">=</span> <span class="n">wrap_binary</span><span class="p">(</span><span class="n">nd</span><span class="o">.</span><span class="fm">__gt__</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="s1">&#39;&gt;&#39;</span><span class="p">)</span>
<span class="n">Var</span><span class="o">.</span><span class="fm">__ge__</span> <span class="o">=</span> <span class="n">wrap_binary</span><span class="p">(</span><span class="n">nd</span><span class="o">.</span><span class="fm">__ge__</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="s1">&#39;&gt;=&#39;</span><span class="p">)</span>
<span class="n">Var</span><span class="o">.</span><span class="fm">__eq__</span> <span class="o">=</span> <span class="n">wrap_binary</span><span class="p">(</span><span class="n">nd</span><span class="o">.</span><span class="fm">__eq__</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="s1">&#39;==&#39;</span><span class="p">)</span>
<span class="n">Var</span><span class="o">.</span><span class="fm">__ne__</span> <span class="o">=</span> <span class="n">wrap_binary</span><span class="p">(</span><span class="n">nd</span><span class="o">.</span><span class="fm">__ne__</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="s1">&#39;!=&#39;</span><span class="p">)</span>

<span class="n">Var</span><span class="o">.</span><span class="fm">__abs__</span> <span class="o">=</span> <span class="n">wrap_unary</span><span class="p">(</span><span class="n">nd</span><span class="o">.</span><span class="fm">__abs__</span><span class="p">,</span> <span class="s2">&quot;Absolute value&quot;</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">,</span><span class="s1">&#39;|&#39;</span><span class="p">))</span>
<span class="n">Var</span><span class="o">.</span><span class="fm">__neg__</span> <span class="o">=</span> <span class="n">wrap_unary</span><span class="p">(</span><span class="n">nd</span><span class="o">.</span><span class="fm">__neg__</span><span class="p">,</span> <span class="s2">&quot;Flips the sign of the values&quot;</span><span class="p">,</span> <span class="n">symbol</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">))</span>
<span class="n">Var</span><span class="o">.</span><span class="fm">__pos__</span> <span class="o">=</span> <span class="n">wrap_unary</span><span class="p">(</span><span class="n">nd</span><span class="o">.</span><span class="fm">__pos__</span><span class="p">,</span> <span class="s2">&quot;Does nothing&quot;</span><span class="p">,</span> <span class="n">symbol</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;+&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">__trunc__</span> <span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
  <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
<span class="n">Var</span><span class="o">.</span><span class="n">__trunc__</span> <span class="o">=</span> <span class="n">wrap_unary</span><span class="p">(</span><span class="n">__trunc__</span><span class="p">,</span> <span class="s2">&quot;Truncate to integer value&quot;</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;trunc(&#39;</span><span class="p">,</span><span class="s1">&#39;)&#39;</span><span class="p">))</span>
<span class="k">del</span> <span class="n">__trunc__</span>

<span class="k">del</span> <span class="n">nd</span><span class="p">,</span> <span class="n">wrap_unary</span><span class="p">,</span> <span class="n">wrap_binary</span>


<span class="n">global_hooks</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">class_hooks</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># Universal functions (pointwise arithmetic, etc.)</span>
<span class="c1">#from pygeode.ufunc import class_flist, generic_flist</span>
<span class="c1">#global_hooks += generic_flist</span>
<span class="c1">#class_hooks += class_flist</span>
<span class="c1">#del class_flist, generic_flist</span>
<span class="kn">from</span> <span class="nn">pygeode.ufunc</span> <span class="kn">import</span> <span class="n">unary_flist</span>
<span class="n">class_hooks</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">unary_flist</span><span class="p">)</span>
<span class="k">del</span> <span class="n">unary_flist</span>


<span class="c1"># --- Array reduction  ---</span>
<span class="c1"># (summation, average, min, max, etc)</span>
<span class="kn">from</span> <span class="nn">pygeode.reduce</span> <span class="kn">import</span> <span class="n">class_flist</span>
<span class="n">class_hooks</span> <span class="o">+=</span> <span class="n">class_flist</span>
<span class="k">del</span> <span class="n">class_flist</span>

<span class="c1"># Other operations deemed important enough to hook into Var</span>
<span class="c1"># Static methods</span>
<span class="kn">from</span> <span class="nn">pygeode.concat</span> <span class="kn">import</span> <span class="n">concat</span>
<span class="n">global_hooks</span> <span class="o">+=</span> <span class="p">[</span><span class="n">concat</span><span class="p">]</span>
<span class="k">del</span> <span class="n">concat</span>
<span class="c1"># Class methods</span>
<span class="kn">from</span> <span class="nn">pygeode.smooth</span> <span class="kn">import</span> <span class="n">smooth</span>
<span class="kn">from</span> <span class="nn">pygeode.deriv</span> <span class="kn">import</span> <span class="n">deriv</span>
<span class="kn">from</span> <span class="nn">pygeode.diff</span> <span class="kn">import</span> <span class="n">diff</span>
<span class="kn">from</span> <span class="nn">pygeode.intgr</span> <span class="kn">import</span> <span class="n">integrate</span><span class="p">,</span> <span class="n">cumsum</span>
<span class="kn">from</span> <span class="nn">pygeode.composite</span> <span class="kn">import</span> <span class="n">composite</span><span class="p">,</span> <span class="n">flatten</span>
<span class="kn">from</span> <span class="nn">pygeode.fft_smooth</span> <span class="kn">import</span> <span class="n">fft_smooth</span>
<span class="kn">from</span> <span class="nn">pygeode.timeutils</span> <span class="kn">import</span> <span class="n">lag</span>
<span class="k">try</span><span class="p">:</span>
  <span class="kn">from</span> <span class="nn">pygeode.interp</span> <span class="kn">import</span> <span class="n">interpolate</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
  <span class="kn">from</span> <span class="nn">warnings</span> <span class="kn">import</span> <span class="n">warn</span>
  <span class="n">warn</span> <span class="p">(</span><span class="s2">&quot;Can&#39;t import the GSL library.  Interpolation is disabled.&quot;</span><span class="p">)</span>
  <span class="n">interpolate</span> <span class="o">=</span> <span class="kc">None</span>
<span class="kn">from</span> <span class="nn">pygeode.varoperations</span> <span class="kn">import</span> <span class="n">squeeze</span><span class="p">,</span> <span class="n">extend</span><span class="p">,</span> <span class="n">transpose</span><span class="p">,</span> <span class="nb">sorted</span><span class="p">,</span> <span class="n">replace_axes</span><span class="p">,</span> <span class="n">rename</span><span class="p">,</span> <span class="n">rename_axes</span><span class="p">,</span> <span class="n">fill</span><span class="p">,</span> <span class="n">unfill</span><span class="p">,</span> <span class="n">as_type</span>
<span class="n">class_hooks</span> <span class="o">+=</span> <span class="p">[</span><span class="n">_f</span> <span class="k">for</span> <span class="n">_f</span> <span class="ow">in</span> <span class="p">[</span><span class="n">smooth</span><span class="p">,</span> <span class="n">deriv</span><span class="p">,</span> <span class="n">diff</span><span class="p">,</span> <span class="n">integrate</span><span class="p">,</span> <span class="n">cumsum</span><span class="p">,</span> <span class="n">composite</span><span class="p">,</span> <span class="n">flatten</span><span class="p">,</span> <span class="n">fft_smooth</span><span class="p">,</span> <span class="n">lag</span><span class="p">,</span> <span class="n">interpolate</span><span class="p">,</span> <span class="n">squeeze</span><span class="p">,</span> <span class="n">extend</span><span class="p">,</span> <span class="n">transpose</span><span class="p">,</span> <span class="nb">sorted</span><span class="p">,</span> <span class="n">replace_axes</span><span class="p">,</span> <span class="n">rename</span><span class="p">,</span> <span class="n">rename_axes</span><span class="p">,</span> <span class="n">fill</span><span class="p">,</span> <span class="n">unfill</span><span class="p">,</span> <span class="n">as_type</span><span class="p">]</span> <span class="k">if</span> <span class="n">_f</span><span class="p">]</span>
<span class="k">del</span> <span class="n">smooth</span><span class="p">,</span> <span class="n">deriv</span><span class="p">,</span> <span class="n">diff</span><span class="p">,</span> <span class="n">integrate</span><span class="p">,</span> <span class="n">cumsum</span><span class="p">,</span> <span class="n">composite</span><span class="p">,</span> <span class="n">flatten</span><span class="p">,</span> <span class="n">fft_smooth</span><span class="p">,</span> <span class="n">lag</span><span class="p">,</span> <span class="n">interpolate</span><span class="p">,</span> <span class="n">squeeze</span><span class="p">,</span> <span class="n">extend</span><span class="p">,</span> <span class="n">transpose</span><span class="p">,</span> <span class="nb">sorted</span><span class="p">,</span> <span class="n">replace_axes</span><span class="p">,</span> <span class="n">rename</span><span class="p">,</span> <span class="n">rename_axes</span><span class="p">,</span> <span class="n">fill</span><span class="p">,</span> <span class="n">unfill</span><span class="p">,</span> <span class="n">as_type</span>

<span class="c1"># Climatology operators</span>
<span class="kn">from</span> <span class="nn">pygeode</span> <span class="kn">import</span> <span class="n">climat</span>
<span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">climat</span><span class="o">.</span><span class="n">__all__</span><span class="p">:</span>
  <span class="n">c</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">climat</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">do_wrapper</span> <span class="p">(</span><span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">f</span> <span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
      <span class="k">return</span> <span class="n">c</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="n">n</span>
    <span class="k">return</span> <span class="n">f</span>
  <span class="n">class_hooks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">do_wrapper</span><span class="p">())</span>
<span class="k">del</span> <span class="n">climat</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">c</span>


<span class="c1"># Apply the global hooks</span>
<span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">global_hooks</span><span class="p">:</span>
  <span class="nb">globals</span><span class="p">()[</span><span class="n">f</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span>

<span class="c1"># Apply the class hooks</span>
<span class="k">def</span> <span class="nf">wrap_static</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
  <span class="k">def</span> <span class="nf">g</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
  <span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">update_wrapper</span>
  <span class="n">g</span> <span class="o">=</span> <span class="n">update_wrapper</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
  <span class="n">g</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="s1">&#39;Test&#39;</span>
  <span class="k">return</span> <span class="n">g</span>

<span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">class_hooks</span><span class="p">:</span>
  <span class="nb">setattr</span><span class="p">(</span><span class="n">Var</span><span class="p">,</span><span class="n">f</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span><span class="n">f</span><span class="p">)</span>

<span class="k">del</span> <span class="n">f</span>


<span class="c1"># Apply unary functions from ufunc</span>
<span class="c1">#TODO: remove these?  (kind of an awkward syntax, i.e. t.lat.cosd().sqrt() )</span>
<span class="kn">from</span> <span class="nn">pygeode.ufunc</span> <span class="kn">import</span> <span class="n">unary_flist</span>
<span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">unary_flist</span><span class="p">:</span>
  <span class="c1"># We need to retain a copy of *this* f in a local scope,</span>
  <span class="c1"># so encapsulate this part of the process in another (trivial) function</span>
  <span class="k">def</span> <span class="nf">newf_creator</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="n">_f</span> <span class="o">=</span> <span class="n">f</span>  <span class="c1"># store a copy of the source function in this local scope</span>
    <span class="k">def</span> <span class="nf">newf</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="k">return</span> <span class="n">_f</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="n">newf</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="vm">__name__</span>
    <span class="n">newf</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">+</span> <span class="s1">&#39; Called on the Var object.&#39;</span>
    <span class="k">return</span> <span class="n">newf</span>

  <span class="nb">setattr</span><span class="p">(</span><span class="n">Var</span><span class="p">,</span><span class="n">f</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span><span class="n">newf_creator</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
  <span class="k">del</span> <span class="n">newf_creator</span>
<span class="k">del</span> <span class="n">f</span>
</pre></div>

      </div>
      <div class="bottomnav" role="navigation" aria-label="bottom navigation">
      
        <p>
        <a class="uplink" href="../../reference.html">Reference</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../../tutorial.html">Tutorial</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../../gallery/index.html">Gallery</a>
        </p>

      </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2020, Mike Neish, Peter Hitchcock.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.3.2.
    </div>
  </body>
</html>