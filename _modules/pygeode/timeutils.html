
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>pygeode.timeutils &#8212; PyGeode 1.4.1rc1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/pygtheme.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-binder.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-dataframe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-rendered-html.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../../_static/pygeode_icon.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
<link href="http://fonts.googleapis.com/css?family=Ubuntu:300,300italic,regular,italic,500,500italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='http://fonts.googleapis.com/css?family=Ubuntu+Mono:400,700' rel='stylesheet' type='text/css'>

  </head><body>
      <div class="header" role="banner"><img class="logo" src="../../_static/pygeode_logo.png" width=79px alt="Logo"/>
        <h1 class="heading"><a href="../../index.html">
          <span>PyGeode 1.4.1rc1 documentation</span></a></h1>
        <h2 class="heading"><span>pygeode.timeutils</span></h2>
      </div>
      <div class="topnav" role="navigation" aria-label="top navigation">
      
        <p>
        <a class="uplink" href="../../reference.html">Reference</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../../tutorial.html">Tutorial</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../../gallery/index.html">Gallery</a>
        </p>

      </div>
      <div class="content">
        
        
  <h1>Source code for pygeode.timeutils</h1><div class="highlight"><pre>
<span></span><span class="c1"># Time axis utilities</span>

<span class="sd">&#39;&#39;&#39; A set of tools for manipulating time axes. &#39;&#39;&#39;</span>

<span class="c1"># Things which are useful for manipulating time axes, but aren&#39;t needed in the</span>
<span class="c1"># core timeaxis module.</span>

<span class="c1"># For now, share the same C library as the timeaxis module</span>
<span class="kn">from</span> <span class="nn">pygeode.timeaxis</span> <span class="kn">import</span> <span class="n">lib</span>

<span class="c1"># Take a list of fields (year, month, day, etc.) and return the fields with duplicates removed.</span>
<span class="c1"># NOTE: the fields are assumed to be pre-sorted</span>
<span class="k">def</span> <span class="nf">_uniquify</span> <span class="p">(</span><span class="n">fields</span><span class="p">):</span>
<span class="c1"># {{{</span>
  <span class="kn">from</span> <span class="nn">pygeode.timeaxis</span> <span class="kn">import</span> <span class="n">_argsort</span>
  <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

  <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;no fields provided&#39;</span>
  <span class="n">S</span> <span class="o">=</span> <span class="n">_argsort</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span>
  <span class="n">in_atts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="n">S</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">])</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
  <span class="n">in_atts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">in_atts</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int32&#39;</span><span class="p">)</span>
  <span class="n">out_atts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">in_atts</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int32&#39;</span><span class="p">)</span>
  <span class="n">nout</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">uniquify</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fields</span><span class="p">),</span> <span class="n">in_atts</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">in_atts</span><span class="p">),</span> <span class="n">out_atts</span><span class="p">)</span>

  <span class="c1"># Convert back to a list of fields</span>
  <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">out_atts</span><span class="p">[:</span><span class="n">nout</span><span class="p">,:]</span><span class="o">.</span><span class="n">transpose</span><span class="p">())</span>

<span class="c1"># }}}</span>


<span class="c1"># Mask out certain fields from a time axis</span>
<span class="c1"># resolution: maximum resolution of the output &#39;day&#39;, &#39;hour&#39;, &#39;year&#39;, etc.)</span>
<span class="c1"># exclude: list of fields to remove (i.e. mask out &#39;year&#39; when making a climatology axis)</span>
<span class="c1"># include: explicit list of fields to include (everything else is excluded)</span>
<div class="viewcode-block" id="modify"><a class="viewcode-back" href="../../timeutils.html#pygeode.timeutils.modify">[docs]</a><span class="k">def</span> <span class="nf">modify</span> <span class="p">(</span><span class="n">taxis</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="p">[],</span> <span class="n">include</span><span class="o">=</span><span class="p">[],</span> <span class="n">uniquify</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="c1"># {{{</span>
  <span class="sd">&#39;&#39;&#39; Modifies the auxiliary arrays associated with a time axis.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ==========</span>
<span class="sd">    taxis : time axis instance</span>
<span class="sd">      Time axis to modify</span>

<span class="sd">    resolution : {None, &#39;year&#39;, &#39;month&#39;, &#39;day&#39;, &#39;hour&#39;, &#39;minute&#39;, &#39;second&#39;}, optional</span>
<span class="sd">      Finest division to retain.</span>

<span class="sd">    exclude : list of strings, optional</span>
<span class="sd">      List of arrays to remove</span>

<span class="sd">    include : list of strings, optional</span>
<span class="sd">      Explicit list of arrays to include</span>

<span class="sd">    Returns</span>
<span class="sd">    =======</span>
<span class="sd">    taxis : time axis instance</span>
<span class="sd">      Modified time axis</span>
<span class="sd">  &#39;&#39;&#39;</span>
  <span class="c1"># Determine which fields to use</span>
  <span class="n">fnames</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">taxis</span><span class="o">.</span><span class="n">auxarrays</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
  <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exclude</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span> <span class="n">exclude</span> <span class="o">=</span> <span class="p">[</span><span class="n">exclude</span><span class="p">]</span>
  <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">include</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span> <span class="n">include</span> <span class="o">=</span> <span class="p">[</span><span class="n">include</span><span class="p">]</span>
  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">include</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">fnames</span> <span class="o">=</span> <span class="n">fnames</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">include</span><span class="p">)</span>
  <span class="n">fnames</span> <span class="o">-=</span> <span class="nb">set</span><span class="p">(</span><span class="n">exclude</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">resolution</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">i</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">taxis</span><span class="o">.</span><span class="n">allowed_fields</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">resolution</span><span class="p">)</span>
    <span class="n">fnames</span> <span class="o">-=</span> <span class="nb">set</span><span class="p">(</span><span class="n">taxis</span><span class="o">.</span><span class="n">allowed_fields</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:])</span>

  <span class="c1"># Convert back to an ordered list</span>
  <span class="n">fnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">taxis</span><span class="o">.</span><span class="n">allowed_fields</span> <span class="k">if</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fnames</span><span class="p">]</span>

  <span class="c1"># Get the fields</span>
  <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="n">taxis</span><span class="o">.</span><span class="n">auxarrays</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fnames</span><span class="p">]</span>

  <span class="k">if</span> <span class="n">uniquify</span><span class="p">:</span> <span class="n">fields</span> <span class="o">=</span> <span class="n">_uniquify</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span>

  <span class="c1"># Get a dictionary for the fields</span>
  <span class="n">fields</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([</span><span class="n">name</span><span class="p">,</span><span class="n">f</span><span class="p">]</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span><span class="n">f</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">fnames</span><span class="p">,</span><span class="n">fields</span><span class="p">))</span>

  <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">taxis</span><span class="o">.</span><span class="n">auxatts</span><span class="p">,</span> <span class="o">**</span><span class="n">fields</span><span class="p">)</span>
  <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="n">taxis</span><span class="p">)(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
<span class="c1"># }}}</span>


<span class="c1"># Get a relative time array with the given parameters</span>
<div class="viewcode-block" id="reltime"><a class="viewcode-back" href="../../timeutils.html#pygeode.timeutils.reltime">[docs]</a><span class="k">def</span> <span class="nf">reltime</span> <span class="p">(</span><span class="n">taxis</span><span class="p">,</span> <span class="n">startdate</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="c1"># {{{</span>
  <span class="sd">&#39;&#39;&#39; Returns time axis values relative to a given reference date. The units can be</span>
<span class="sd">  be specified, if none are given the units of the given time axis are used.&#39;&#39;&#39;</span>
  <span class="k">if</span> <span class="n">units</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">units</span> <span class="o">=</span> <span class="n">taxis</span><span class="o">.</span><span class="n">units</span>
  <span class="k">return</span> <span class="n">taxis</span><span class="o">.</span><span class="n">date_as_val</span> <span class="p">(</span><span class="n">startdate</span><span class="o">=</span><span class="n">startdate</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">)</span></div>
<span class="c1"># }}}</span>


<span class="c1"># Get time increment</span>
<span class="c1"># Units: day, hour, minute, second</span>
<div class="viewcode-block" id="delta"><a class="viewcode-back" href="../../timeutils.html#pygeode.timeutils.delta">[docs]</a><span class="k">def</span> <span class="nf">delta</span> <span class="p">(</span><span class="n">taxis</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">allow_multiple</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="c1"># {{{</span>
  <span class="sd">&#39;&#39;&#39; Returns the interval between values of a given time axis. If</span>
<span class="sd">  non-unique intervals are found an exception is raised. The units</span>
<span class="sd">  can be specified; if none are given the units of the given time axis</span>
<span class="sd">  are used.&#39;&#39;&#39;</span>
  <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

  <span class="n">delt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">reltime</span><span class="p">(</span><span class="n">taxis</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">))</span>
  <span class="c1"># If we have more than one &#39;unique&#39; value, check if it&#39;s just a case of numerical precision</span>
  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">delt</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">delt</span><span class="p">,</span> <span class="n">delt</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span> <span class="n">delt</span> <span class="o">=</span> <span class="n">delt</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span> <span class="n">delt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">delt</span><span class="p">))</span>
  <span class="c1"># Not enough values to determine a delt?</span>
  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">delt</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="mi">0</span>

  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">delt</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">estr</span> <span class="o">=</span> <span class="s1">&#39;Warning: non-unique deltas found in axis </span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">taxis</span><span class="p">,</span> <span class="n">delt</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">allow_multiple</span><span class="p">:</span> 
      <span class="nb">print</span><span class="p">(</span><span class="n">estr</span> <span class="o">+</span> <span class="s1">&#39; Returning smallest.&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">estr</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">delt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>
<span class="c1"># }}}</span>

<span class="c1"># Helper function; normalizes date object so that all fields are within the standard range</span>
<div class="viewcode-block" id="wrapdate"><a class="viewcode-back" href="../../timeutils.html#pygeode.timeutils.wrapdate">[docs]</a><span class="k">def</span> <span class="nf">wrapdate</span><span class="p">(</span><span class="n">taxis</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">allfields</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="c1"># {{{</span>
  <span class="sd">&#39;&#39;&#39; Returns a modified date dictionary such that all fields</span>
<span class="sd">  lie within standard values. &#39;&#39;&#39;</span>
  <span class="k">return</span> <span class="n">taxis</span><span class="o">.</span><span class="n">val_as_date</span><span class="p">(</span><span class="n">taxis</span><span class="o">.</span><span class="n">date_as_val</span><span class="p">(</span><span class="n">dt</span><span class="p">),</span> <span class="n">allfields</span><span class="o">=</span><span class="n">allfields</span><span class="p">)</span></div>
<span class="c1"># }}}</span>

<span class="c1"># Helper function; returns time between two dates in specified units</span>
<div class="viewcode-block" id="date_diff"><a class="viewcode-back" href="../../timeutils.html#pygeode.timeutils.date_diff">[docs]</a><span class="k">def</span> <span class="nf">date_diff</span><span class="p">(</span><span class="n">taxis</span><span class="p">,</span> <span class="n">dt1</span><span class="p">,</span> <span class="n">dt2</span><span class="p">,</span> <span class="n">units</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="c1"># {{{</span>
  <span class="sd">&#39;&#39;&#39; Returns time interval between two dates. A time axis must be given</span>
<span class="sd">  to specify the calendar. If no units are specified the units of the given</span>
<span class="sd">  time axis are used.&#39;&#39;&#39;</span>
  <span class="k">return</span> <span class="n">taxis</span><span class="o">.</span><span class="n">date_as_val</span><span class="p">(</span><span class="n">dt2</span><span class="p">,</span> <span class="n">startdate</span><span class="o">=</span><span class="n">dt1</span><span class="p">,</span> <span class="n">units</span> <span class="o">=</span> <span class="n">units</span><span class="p">)</span></div>
<span class="c1"># }}}</span>

<span class="c1"># Conform two time axes so their values are comparable</span>
<div class="viewcode-block" id="conform_values"><a class="viewcode-back" href="../../timeutils.html#pygeode.timeutils.conform_values">[docs]</a><span class="k">def</span> <span class="nf">conform_values</span> <span class="p">(</span><span class="n">taxis1</span><span class="p">,</span> <span class="n">taxis2</span><span class="p">):</span>
<span class="c1"># {{{</span>
  <span class="sd">&#39;&#39;&#39;Given two time axes, return new axes such that their values are comparable.&#39;&#39;&#39;</span>
  <span class="kn">from</span> <span class="nn">pygeode.timeaxis</span> <span class="kn">import</span> <span class="n">Time</span>
  <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">taxis1</span><span class="p">,</span> <span class="n">Time</span><span class="p">)</span>
  <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">taxis2</span><span class="p">,</span> <span class="n">Time</span><span class="p">)</span>
  <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">taxis1</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">type</span><span class="p">(</span><span class="n">taxis2</span><span class="p">),</span> <span class="s2">&quot;can&#39;t conform time axes of different types&quot;</span>  

  <span class="n">allowed_fields</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">taxis1</span><span class="p">)</span><span class="o">.</span><span class="n">allowed_fields</span>

  <span class="c1"># Make taxis1 be the one with the &#39;larger&#39; set of fields</span>
  <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">taxis1</span><span class="o">.</span><span class="n">auxarrays</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">&lt;</span> <span class="nb">set</span><span class="p">(</span><span class="n">taxis2</span><span class="o">.</span><span class="n">auxarrays</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
    <span class="n">taxis1</span><span class="p">,</span> <span class="n">taxis2</span> <span class="o">=</span> <span class="n">taxis2</span><span class="p">,</span> <span class="n">taxis1</span>
  <span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="n">taxis1</span><span class="o">.</span><span class="n">auxarrays</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">&gt;=</span> <span class="nb">set</span><span class="p">(</span><span class="n">taxis2</span><span class="o">.</span><span class="n">auxarrays</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="s2">&quot;incompatible fields&quot;</span>

  <span class="c1"># From here on out, can assume that taxis1 contains the superset of all the fields.</span>

  <span class="c1"># Check that the only extra fields of taxis1 occur at the end (fastest varying).</span>
  <span class="c1"># Otherwise, we get a non-trivial many-to-one mapping between the axes</span>
  <span class="c1"># (they can&#39;t share a linear &#39;values&#39; relationship).</span>
  <span class="n">end_resolution</span> <span class="o">=</span> <span class="kc">False</span>
  <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">allowed_fields</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">taxis1</span><span class="o">.</span><span class="n">auxarrays</span><span class="p">:</span> <span class="k">continue</span>
    <span class="c1"># If we&#39;ve already gone beyond the resolution of taxis2, then there</span>
    <span class="c1"># shouldn&#39;t be any further fields defined in it.</span>
    <span class="k">if</span> <span class="n">end_resolution</span><span class="p">:</span> <span class="k">assert</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">taxis2</span><span class="o">.</span><span class="n">auxarrays</span><span class="p">,</span> <span class="s2">&quot;incompatible fields&quot;</span>
    <span class="c1"># Check if we&#39;re now beyond the resolution of taxis2</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">taxis2</span><span class="o">.</span><span class="n">auxarrays</span><span class="p">:</span> <span class="n">end_resolution</span> <span class="o">=</span> <span class="kc">True</span>

  <span class="c1"># Use the units and start date from the second axis</span>
  <span class="n">units</span> <span class="o">=</span> <span class="n">taxis2</span><span class="o">.</span><span class="n">units</span>
  <span class="n">startdate</span> <span class="o">=</span> <span class="n">taxis2</span><span class="o">.</span><span class="n">startdate</span>

  <span class="c1"># Change the values of the first time axis</span>
  <span class="n">taxis1</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">taxis1</span><span class="p">)(</span><span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span> <span class="n">startdate</span><span class="o">=</span><span class="n">startdate</span><span class="p">,</span> <span class="o">**</span><span class="n">taxis1</span><span class="o">.</span><span class="n">auxarrays</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">taxis1</span><span class="p">,</span> <span class="n">taxis2</span></div>
<span class="c1"># }}}</span>


<span class="kn">from</span> <span class="nn">pygeode.var</span> <span class="kn">import</span> <span class="n">Var</span>
<span class="kn">from</span> <span class="nn">pygeode.timeaxis</span> <span class="kn">import</span> <span class="n">Yearless</span>

<span class="k">class</span> <span class="nc">Lag</span><span class="p">(</span><span class="n">Yearless</span><span class="p">):</span> 
<span class="c1"># {{{</span>
  <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;lag&#39;</span>
  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">class_has_alias</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
  <span class="c1"># {{{</span>
    <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span> <span class="k">return</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="kc">False</span>
  <span class="c1"># }}}</span>
<span class="c1"># }}}</span>


<span class="c1"># Remove leap days from data on a standard calendar, coerce the data onto a</span>
<span class="c1"># 365-day calendar.</span>
<span class="kn">from</span> <span class="nn">pygeode.timeaxis</span> <span class="kn">import</span> <span class="n">ModelTime365</span>
<div class="viewcode-block" id="removeleapyears"><a class="viewcode-back" href="../../timeutils.html#pygeode.timeutils.removeleapyears">[docs]</a><span class="k">def</span> <span class="nf">removeleapyears</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">omitdoy_leap</span><span class="o">=</span><span class="p">[</span><span class="mi">60</span><span class="p">],</span> <span class="n">omitdoy_noleap</span><span class="o">=</span><span class="p">[],</span> <span class="n">new_axis_type</span><span class="o">=</span><span class="n">ModelTime365</span><span class="p">):</span>
<span class="c1"># {{{</span>
  <span class="sd">&#39;&#39;&#39;Removes leap day(s) from data on a standard calendar. Casts variable with</span>
<span class="sd">  a :class:`StandardTime` time axis onto a time axis with a uniform year length</span>
<span class="sd">  by removing days from leap years.</span>
<span class="sd">  </span>
<span class="sd">  Parameters</span>
<span class="sd">  ----------</span>
<span class="sd">  data :  :class:`Var`</span>
<span class="sd">    The variable to modify. Should have a :class:`Time` axis.</span>
<span class="sd">  </span>
<span class="sd">  omitdoy_leap : list, optional [ [60] ]</span>
<span class="sd">    A list of days of the year (e.g. 1 is 1 January, 60 is 29 February) to remove</span>
<span class="sd">    from leap years.</span>

<span class="sd">  omitdoy_noleap : list, optional [ [] ]</span>
<span class="sd">    A list of days of the year (e.g. 1 is 1 January, 60 is 1 March) to remove</span>
<span class="sd">    from non-leap years. Can be empty.</span>
<span class="sd">  </span>
<span class="sd">  new_axis_type : :class:`CalendarTime`, optional</span>
<span class="sd">    Time axis class to use instead. Default is :class:`ModelTime365`. Should</span>
<span class="sd">    expect a year length consistent with the lists passed to omitdoy_leap and</span>
<span class="sd">    omitdoy_noleap</span>

<span class="sd">  Returns</span>
<span class="sd">  -------</span>
<span class="sd">  New :class:`Var` object with modified time axis and specified days removed</span>
<span class="sd">  from leap year.&#39;&#39;&#39;</span>

  <span class="kn">from</span> <span class="nn">pygeode.timeaxis</span> <span class="kn">import</span> <span class="n">Time</span><span class="p">,</span> <span class="n">StandardTime</span>
  <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

  <span class="n">taxis</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">getaxis</span><span class="p">(</span><span class="n">Time</span><span class="p">)</span>

  <span class="c1"># Determine which times to keep</span>
  <span class="n">year</span> <span class="o">=</span> <span class="n">taxis</span><span class="o">.</span><span class="n">year</span>
  <span class="n">isleapyear</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">taxis</span><span class="p">,</span><span class="n">StandardTime</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">year</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span> <span class="p">(</span><span class="n">year</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">year</span> <span class="o">%</span> <span class="mi">400</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">)</span>

  <span class="n">doy</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">taxis</span><span class="o">.</span><span class="n">year</span><span class="p">)):</span>
    <span class="n">doy</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">reltime</span><span class="p">(</span><span class="n">taxis</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="n">y</span><span class="p">),</span> <span class="n">startdate</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;year&#39;</span><span class="p">:</span><span class="n">y</span><span class="p">,</span> <span class="s1">&#39;month&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;day&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">},</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;days&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
  <span class="n">doy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">doy</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

  <span class="n">omit_on_leap</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">taxis</span><span class="p">)</span>
  <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">omitdoy_leap</span><span class="p">:</span>
    <span class="n">omit_on_leap</span> <span class="o">|=</span> <span class="p">(</span><span class="n">doy</span> <span class="o">==</span> <span class="n">d</span><span class="p">)</span>

  <span class="n">omit_on_noleap</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">taxis</span><span class="p">)</span>
  <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">omitdoy_noleap</span><span class="p">:</span>
    <span class="n">omit_on_noleap</span> <span class="o">|=</span> <span class="p">(</span><span class="n">doy</span> <span class="o">==</span> <span class="n">d</span><span class="p">)</span>

  <span class="n">omit</span> <span class="o">=</span> <span class="p">(</span><span class="n">isleapyear</span> <span class="o">&amp;</span> <span class="n">omit_on_leap</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="o">~</span><span class="n">isleapyear</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">omit_on_noleap</span><span class="p">)</span>
  <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="o">~</span><span class="n">omit</span><span class="p">)</span>

  <span class="c1"># Remove the leap days from the data</span>
  <span class="n">slices</span> <span class="o">=</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)]</span> <span class="o">*</span> <span class="n">data</span><span class="o">.</span><span class="n">naxes</span>
  <span class="n">slices</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">whichaxis</span><span class="p">(</span><span class="n">Time</span><span class="p">)]</span> <span class="o">=</span> <span class="n">indices</span>
  <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">_getitem_asvar</span><span class="p">(</span><span class="n">slices</span><span class="p">)</span>

  <span class="c1"># Recreate the axis as the new type.</span>
  <span class="c1"># Convert doy (old axis) to doy (new axis)</span>
  <span class="n">new_taxis_pieces</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">taxis</span><span class="o">.</span><span class="n">year</span><span class="p">)):</span>
    <span class="c1"># Check for leap year - use one list of omitted days or the other</span>
    <span class="k">if</span> <span class="n">isleapyear</span><span class="p">[</span><span class="n">taxis</span><span class="o">.</span><span class="n">year</span><span class="o">==</span><span class="n">y</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
      <span class="n">omitted_days</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">omitdoy_leap</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">omitted_days</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">omitdoy_noleap</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># Start with the old doy</span>
    <span class="n">doy</span> <span class="o">=</span> <span class="n">reltime</span><span class="p">(</span><span class="n">taxis</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="n">y</span><span class="p">),</span> <span class="n">startdate</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;year&#39;</span><span class="p">:</span><span class="n">y</span><span class="p">,</span> <span class="s1">&#39;month&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;day&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">},</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;days&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
    <span class="c1"># Strip out the omitted days, and re-index the other days</span>
    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">omitted_days</span><span class="p">:</span>
      <span class="n">doy</span> <span class="o">=</span> <span class="n">doy</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">doy</span><span class="p">)</span> <span class="o">!=</span> <span class="n">d</span><span class="p">]</span>
      <span class="n">doy</span><span class="p">[</span><span class="n">doy</span><span class="o">&gt;</span><span class="n">d</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
    <span class="c1"># Create an axis of the new type</span>
    <span class="n">new_taxis_pieces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_axis_type</span><span class="p">(</span><span class="n">values</span><span class="o">=</span><span class="n">doy</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;days&#39;</span><span class="p">,</span> <span class="n">startdate</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;year&#39;</span><span class="p">:</span><span class="n">y</span><span class="p">,</span> <span class="s1">&#39;month&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;day&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">}))</span>

  <span class="c1"># Rebuild the final new axis</span>
  <span class="c1"># (Had to break it down by year, to do the doy arithmetic)</span>
  <span class="n">new_taxis</span> <span class="o">=</span> <span class="n">new_axis_type</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">new_taxis_pieces</span><span class="p">)</span>

  <span class="c1"># Replace the time axis of the data</span>
  <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">replace_axes</span><span class="p">(</span><span class="n">time</span> <span class="o">=</span> <span class="n">new_taxis</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">data</span></div>
<span class="c1"># }}}</span>

<span class="k">del</span> <span class="n">ModelTime365</span>

<span class="k">class</span> <span class="nc">LagVar</span><span class="p">(</span><span class="n">Var</span><span class="p">):</span>
<span class="c1"># {{{</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">iaxis</span><span class="p">,</span> <span class="n">lags</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
  <span class="c1"># {{{</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
    <span class="kn">from</span> <span class="nn">pygeode</span> <span class="kn">import</span> <span class="n">Var</span>
    <span class="kn">from</span> <span class="nn">pygeode.timeaxis</span> <span class="kn">import</span> <span class="n">Time</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">iaxis</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">whichaxis</span><span class="p">(</span><span class="n">iaxis</span><span class="p">)</span>
    <span class="n">taxis</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">iaxis</span><span class="p">]</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">taxis</span><span class="p">,</span> <span class="n">Time</span><span class="p">),</span> <span class="s1">&#39;must specify a Time axis&#39;</span>
    <span class="n">delt</span> <span class="o">=</span> <span class="p">(</span><span class="n">taxis</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">taxis</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">reverse</span><span class="p">:</span> 
      <span class="n">delt</span> <span class="o">=</span> <span class="o">-</span><span class="n">delt</span>
      <span class="n">lags</span> <span class="o">=</span> <span class="n">lags</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="bp">self</span><span class="o">.</span><span class="n">lags</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lags</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">)</span>
    <span class="n">lag</span> <span class="o">=</span> <span class="n">Lag</span><span class="p">(</span><span class="n">values</span> <span class="o">=</span> <span class="n">delt</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">lags</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">taxis</span><span class="o">.</span><span class="n">units</span><span class="p">,</span> <span class="n">startdate</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;day&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">})</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">axes</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">iaxis</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">lag</span><span class="p">,</span> <span class="p">)</span> <span class="o">+</span> <span class="n">var</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">iaxis</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">var</span>

    <span class="n">Var</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axes</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">var</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">var</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">atts</span><span class="o">=</span><span class="n">var</span><span class="o">.</span><span class="n">atts</span><span class="p">,</span> <span class="n">plotatts</span><span class="o">=</span><span class="n">var</span><span class="o">.</span><span class="n">plotatts</span><span class="p">)</span>
  <span class="c1"># }}}</span>

  <span class="k">def</span> <span class="nf">getview</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">pbar</span><span class="p">):</span>
  <span class="c1"># {{{</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
    <span class="n">lind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lags</span><span class="p">[</span><span class="n">view</span><span class="o">.</span><span class="n">integer_indices</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">iaxis</span><span class="o">+</span><span class="mi">1</span><span class="p">]]</span>
    <span class="n">loff</span><span class="p">,</span> <span class="n">roff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">lind</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">lind</span><span class="p">)</span>

    <span class="n">tind</span> <span class="o">=</span> <span class="n">view</span><span class="o">.</span><span class="n">integer_indices</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">iaxis</span><span class="p">]</span>
    <span class="n">tmin</span><span class="p">,</span> <span class="n">tmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">tind</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">tind</span><span class="p">)</span>

    <span class="n">tsl</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">tmin</span> <span class="o">+</span> <span class="n">loff</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">tmax</span> <span class="o">+</span> <span class="n">roff</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">iaxis</span><span class="p">]))</span>
    <span class="n">imin</span> <span class="o">=</span> <span class="n">tsl</span><span class="o">.</span><span class="n">start</span>
    <span class="n">inview</span> <span class="o">=</span> <span class="n">view</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iaxis</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">modify_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iaxis</span><span class="p">,</span> <span class="n">tsl</span><span class="p">)</span>
    <span class="n">src</span> <span class="o">=</span> <span class="n">inview</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="p">,</span> <span class="n">pbar</span><span class="o">=</span><span class="n">pbar</span><span class="p">)</span>

    <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">view</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">outsl</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">iaxis</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">else</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">naxes</span><span class="p">)]</span>
    <span class="n">insl</span> <span class="o">=</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">naxes</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lind</span><span class="p">):</span>
      <span class="n">valid</span> <span class="o">=</span> <span class="p">(</span><span class="n">tind</span> <span class="o">+</span> <span class="n">l</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">tind</span> <span class="o">+</span> <span class="n">l</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">iaxis</span><span class="p">])</span>
      <span class="n">ivalid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">valid</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
      <span class="n">insl</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">iaxis</span><span class="p">]</span> <span class="o">=</span> <span class="n">tind</span><span class="p">[</span><span class="n">ivalid</span><span class="p">]</span> <span class="o">+</span> <span class="n">l</span> <span class="o">-</span> <span class="n">imin</span>
      <span class="n">outsl</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">iaxis</span><span class="p">]</span> <span class="o">=</span> <span class="n">ivalid</span>
      <span class="n">outsl</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">iaxis</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
      <span class="n">out</span><span class="p">[</span><span class="n">outsl</span><span class="p">]</span> <span class="o">=</span> <span class="n">src</span><span class="p">[</span><span class="n">insl</span><span class="p">]</span>
      <span class="n">outsl</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">iaxis</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">valid</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
      <span class="n">out</span><span class="p">[</span><span class="n">outsl</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    
    <span class="k">return</span> <span class="n">out</span>
  <span class="c1"># }}}</span>
<span class="c1"># }}}</span>

<span class="k">del</span> <span class="n">Yearless</span>

<span class="k">def</span> <span class="nf">lag</span> <span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">iaxis</span><span class="p">,</span> <span class="n">lags</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="c1"># {{{</span>
  <span class="sd">&#39;&#39;&#39; Adds a lag axis with offset values. &#39;&#39;&#39;</span>
  <span class="k">return</span> <span class="n">LagVar</span> <span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">iaxis</span><span class="p">,</span> <span class="n">lags</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="n">reverse</span><span class="p">)</span>
<span class="c1"># }}}</span>


<span class="c1"># Split a time axis into year,&lt;everything else&gt;</span>
<span class="k">def</span> <span class="nf">_splittime</span> <span class="p">(</span><span class="n">taxis</span><span class="p">):</span>
<span class="c1"># {{{</span>
  <span class="kn">from</span> <span class="nn">pygeode.timeaxis</span> <span class="kn">import</span> <span class="n">CalendarTime</span>
  <span class="kn">from</span> <span class="nn">pygeode.axis</span> <span class="kn">import</span> <span class="n">NamedAxis</span>
  <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

  <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">taxis</span><span class="p">,</span><span class="n">CalendarTime</span><span class="p">)</span>
  <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">taxis</span><span class="p">,</span><span class="s1">&#39;year&#39;</span><span class="p">),</span> <span class="s2">&quot;no years to split off!&quot;</span>

  <span class="c1"># Get the years, turn them into an axis</span>
  <span class="n">years</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">taxis</span><span class="o">.</span><span class="n">year</span><span class="p">)</span>
  <span class="n">years</span> <span class="o">=</span> <span class="n">NamedAxis</span><span class="p">(</span><span class="n">values</span><span class="o">=</span><span class="n">years</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;year&#39;</span><span class="p">)</span>

  <span class="c1"># Get the rest, as a &#39;climatological&#39; axis</span>
  <span class="n">days</span> <span class="o">=</span> <span class="n">modify</span><span class="p">(</span><span class="n">taxis</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="n">uniquify</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;day&#39;</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">years</span><span class="p">,</span> <span class="n">days</span>
<span class="c1"># }}}</span>


<span class="c1"># Join 2 axes (year,&lt;everything else&gt;) into a single time axis</span>
<span class="c1"># &#39;years&#39; is an axis, &#39;days&#39; is a CalendarTime axis.</span>
<span class="c1"># NOTE: magical things can happen when the calendar year doesn&#39;t have a fixed length</span>
<span class="k">def</span> <span class="nf">_jointime</span> <span class="p">(</span><span class="n">years</span><span class="p">,</span> <span class="n">days</span><span class="p">):</span>
<span class="c1"># {{{</span>
  <span class="kn">from</span> <span class="nn">pygeode.axis</span> <span class="kn">import</span> <span class="n">Axis</span>
  <span class="kn">from</span> <span class="nn">pygeode.timeaxis</span> <span class="kn">import</span> <span class="n">CalendarTime</span>
  <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">years</span><span class="p">,</span> <span class="n">Axis</span><span class="p">)</span>
  <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">days</span><span class="p">,</span> <span class="n">CalendarTime</span><span class="p">)</span>
  <span class="k">assert</span> <span class="s1">&#39;year&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">days</span>

  <span class="n">nyears</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">years</span><span class="p">)</span>
  <span class="n">ndays</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">days</span><span class="p">)</span>
  <span class="n">timetype</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">days</span><span class="p">)</span>
  <span class="n">timeunits</span> <span class="o">=</span> <span class="n">days</span><span class="o">.</span><span class="n">units</span>

  <span class="c1"># Convert &#39;years&#39; to a raw numpy array, and &#39;days&#39; to a dictionary of numpy</span>
  <span class="c1"># arrays, representing the other date/time fields.</span>
  <span class="n">years</span> <span class="o">=</span> <span class="n">years</span><span class="o">.</span><span class="n">values</span>
  <span class="n">days</span> <span class="o">=</span> <span class="n">days</span><span class="o">.</span><span class="n">auxarrays</span>

  <span class="c1"># Broadcast all combinations of selected years and days, get a list of</span>
  <span class="c1"># dates to request from the input var</span>
  <span class="n">fields</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="n">fields</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">years</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">ndays</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
  <span class="k">for</span> <span class="n">fname</span><span class="p">,</span> <span class="n">farray</span> <span class="ow">in</span> <span class="n">days</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">fields</span><span class="p">[</span><span class="n">fname</span><span class="p">]</span> <span class="o">=</span> <span class="n">farray</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">nyears</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

  <span class="c1"># Construct a time axis with this field information</span>
  <span class="n">out_times</span> <span class="o">=</span> <span class="n">timetype</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="n">timeunits</span><span class="p">,</span> <span class="o">**</span><span class="n">fields</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">out_times</span>
<span class="c1"># }}}</span>

<span class="c1"># Now, define some Var classes that apply the above split/join to</span>
<span class="c1"># variables that contain time axes.</span>

<span class="c1"># Split a time axis into a 2D representation (year,&lt;everything else&gt;)</span>
<span class="k">class</span> <span class="nc">SplitTime</span> <span class="p">(</span><span class="n">Var</span><span class="p">):</span>
<span class="c1"># {{{</span>
  <span class="k">def</span> <span class="fm">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">iaxis</span><span class="p">):</span>
<span class="c1"># {{{</span>
    <span class="kn">from</span> <span class="nn">pygeode.var</span> <span class="kn">import</span> <span class="n">copy_meta</span><span class="p">,</span> <span class="n">Var</span>

    <span class="c1"># Get the time axis to split</span>
    <span class="n">iaxis</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">whichaxis</span><span class="p">(</span><span class="n">iaxis</span><span class="p">)</span>
    <span class="n">taxis</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">getaxis</span><span class="p">(</span><span class="n">iaxis</span><span class="p">)</span>

    <span class="n">years</span><span class="p">,</span> <span class="n">days</span> <span class="o">=</span> <span class="n">_splittime</span><span class="p">(</span><span class="n">taxis</span><span class="p">)</span>

    <span class="c1"># Construct the output axes</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">axes</span><span class="p">)</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[:</span><span class="n">iaxis</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">years</span><span class="p">,</span> <span class="n">days</span><span class="p">]</span> <span class="o">+</span> <span class="n">axes</span><span class="p">[</span><span class="n">iaxis</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>

    <span class="n">copy_meta</span><span class="p">(</span><span class="n">var</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span>

    <span class="n">Var</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">var</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">iaxis</span> <span class="o">=</span> <span class="n">iaxis</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">var</span>
<span class="c1"># }}}</span>

  <span class="k">def</span> <span class="nf">getview</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">pbar</span><span class="p">):</span>
<span class="c1"># {{{</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

    <span class="c1"># Get the selected years and days</span>
    <span class="n">iaxis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iaxis</span>
    <span class="n">years</span> <span class="o">=</span> <span class="n">view</span><span class="o">.</span><span class="n">subaxis</span><span class="p">(</span><span class="n">iaxis</span><span class="p">)</span>
    <span class="n">days</span> <span class="o">=</span> <span class="n">view</span><span class="o">.</span><span class="n">subaxis</span><span class="p">(</span><span class="n">iaxis</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Input time axis (full, not sliced)</span>
    <span class="n">in_taxis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">getaxis</span><span class="p">(</span><span class="n">iaxis</span><span class="p">)</span>

    <span class="c1"># Selected output times (joined into a 1D time axis)</span>
    <span class="n">out_times</span> <span class="o">=</span> <span class="n">_jointime</span><span class="p">(</span><span class="n">years</span><span class="p">,</span><span class="n">days</span><span class="p">)</span>

    <span class="c1"># Determine how much of the input axis we need, and how much</span>
    <span class="c1"># that provides for the output (the rest will be NaNs).</span>
    <span class="n">in_sl</span><span class="p">,</span> <span class="n">out_sl</span> <span class="o">=</span> <span class="n">in_taxis</span><span class="o">.</span><span class="n">common_map</span><span class="p">(</span><span class="n">out_times</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">in_sl</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">out_sl</span><span class="p">)</span>  <span class="c1"># just for the hell of it</span>

    <span class="c1"># Start with a field of NaNs</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">view</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">out</span><span class="p">[()]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;NaN&#39;</span><span class="p">)</span>  <span class="c1"># will fail horribly if we have integer data.</span>

    <span class="c1"># Get some input data</span>
    <span class="n">inview</span> <span class="o">=</span> <span class="n">view</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">iaxis</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">replace_axis</span><span class="p">(</span><span class="n">iaxis</span><span class="p">,</span> <span class="n">in_taxis</span><span class="p">,</span> <span class="n">sl</span><span class="o">=</span><span class="n">in_sl</span><span class="p">)</span>
    <span class="n">indata</span> <span class="o">=</span> <span class="n">inview</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="p">,</span> <span class="n">pbar</span><span class="o">=</span><span class="n">pbar</span><span class="p">)</span>

    <span class="c1"># Now, put this where we need it.</span>
    <span class="c1"># Input data has a single time axis, so we need to reshape the output a bit.</span>
    <span class="n">squished_shape</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="n">iaxis</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,)</span> <span class="o">+</span> <span class="n">out</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">iaxis</span><span class="o">+</span><span class="mi">2</span><span class="p">:]</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">squished_shape</span><span class="p">)</span>
    <span class="n">sl</span> <span class="o">=</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)]</span> <span class="o">*</span> <span class="n">out</span><span class="o">.</span><span class="n">ndim</span>
    <span class="n">sl</span><span class="p">[</span><span class="n">iaxis</span><span class="p">]</span> <span class="o">=</span> <span class="n">out_sl</span>
    <span class="n">out</span><span class="p">[</span><span class="n">sl</span><span class="p">]</span> <span class="o">=</span> <span class="n">indata</span>

    <span class="c1"># Restore the shape</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">view</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">out</span>
<span class="c1"># }}}</span>
<span class="c1"># }}}</span>

<div class="viewcode-block" id="splittimeaxis"><a class="viewcode-back" href="../../timeutils.html#pygeode.timeutils.splittimeaxis">[docs]</a><span class="k">def</span> <span class="nf">splittimeaxis</span> <span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">iaxis</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">):</span>
<span class="c1"># {{{</span>
  <span class="sd">&#39;&#39;&#39;Convert a variable with a 1D time axis into one with a 2D time axis.&#39;&#39;&#39;</span>
  <span class="k">return</span> <span class="n">SplitTime</span> <span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">iaxis</span><span class="p">)</span></div>
<span class="c1"># }}}</span>


<span class="c1"># Join a 2D time representation (year,&lt;everything else&gt;) into a single</span>
<span class="c1"># 1D time axis.</span>
<span class="k">class</span> <span class="nc">JoinTime</span><span class="p">(</span><span class="n">Var</span><span class="p">):</span>
<span class="c1"># {{{</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">yaxis</span><span class="p">,</span> <span class="n">daxis</span><span class="p">):</span>
<span class="c1"># {{{</span>
    <span class="kn">from</span> <span class="nn">pygeode.var</span> <span class="kn">import</span> <span class="n">copy_meta</span><span class="p">,</span> <span class="n">Var</span>

    <span class="n">yaxis</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">whichaxis</span><span class="p">(</span><span class="n">yaxis</span><span class="p">)</span>
    <span class="n">daxis</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">whichaxis</span><span class="p">(</span><span class="n">daxis</span><span class="p">)</span>
    <span class="k">assert</span> <span class="p">(</span><span class="n">yaxis</span> <span class="o">&lt;</span> <span class="n">daxis</span><span class="p">)</span>  <span class="c1"># need a certain order</span>

    <span class="n">years</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">getaxis</span><span class="p">(</span><span class="n">yaxis</span><span class="p">)</span>
    <span class="n">days</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">getaxis</span><span class="p">(</span><span class="n">daxis</span><span class="p">)</span>

    <span class="c1"># Generate the joined axis</span>
    <span class="n">taxis</span> <span class="o">=</span> <span class="n">_jointime</span><span class="p">(</span><span class="n">years</span><span class="p">,</span> <span class="n">days</span><span class="p">)</span>

    <span class="n">axes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">axes</span><span class="p">)</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[:</span><span class="n">daxis</span><span class="p">]</span> <span class="o">+</span> <span class="n">axes</span><span class="p">[</span><span class="n">daxis</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">yaxis</span><span class="p">]</span> <span class="o">=</span> <span class="n">taxis</span>

    <span class="n">Var</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">var</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">copy_meta</span><span class="p">(</span><span class="n">var</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">yaxis</span> <span class="o">=</span> <span class="n">yaxis</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">daxis</span> <span class="o">=</span> <span class="n">daxis</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">var</span>
<span class="c1"># }}}</span>

  <span class="k">def</span> <span class="nf">getview</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">pbar</span><span class="p">):</span>
<span class="c1"># {{{</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

    <span class="n">yaxis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">yaxis</span>
    <span class="n">daxis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">daxis</span>

    <span class="c1"># Get the requested times.</span>
    <span class="c1"># Since the time axis is in the same position as &#39;years&#39; when comparing</span>
    <span class="c1"># the input and output vars, we can do:</span>
    <span class="n">taxis</span> <span class="o">=</span> <span class="n">yaxis</span>
    <span class="n">times</span> <span class="o">=</span> <span class="n">view</span><span class="o">.</span><span class="n">subaxis</span><span class="p">(</span><span class="n">taxis</span><span class="p">)</span>

    <span class="c1"># Determine which years and (day-of-year?) these times correspond to</span>
    <span class="n">years</span><span class="p">,</span> <span class="n">days</span> <span class="o">=</span> <span class="n">_splittime</span><span class="p">(</span><span class="n">times</span><span class="p">)</span>

    <span class="c1"># The full input years/days</span>
    <span class="n">in_years</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">getaxis</span><span class="p">(</span><span class="n">yaxis</span><span class="p">)</span>
    <span class="n">in_days</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">getaxis</span><span class="p">(</span><span class="n">daxis</span><span class="p">)</span>

    <span class="c1"># Get the input data</span>
    <span class="n">inview</span> <span class="o">=</span> <span class="n">view</span><span class="o">.</span><span class="n">replace_axis</span><span class="p">(</span><span class="n">taxis</span><span class="p">,</span> <span class="n">years</span><span class="p">)</span><span class="o">.</span><span class="n">add_axis</span><span class="p">(</span><span class="n">daxis</span><span class="p">,</span> <span class="n">days</span><span class="p">,</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">inview</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="p">,</span> <span class="n">pbar</span><span class="o">=</span><span class="n">pbar</span><span class="p">)</span>

    <span class="c1"># Reshape the data so it has a single time axis.</span>
    <span class="c1"># First, move the year and day axes next to each other</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rollaxis</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">daxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># Then, combine then</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="n">shape</span><span class="p">[:</span><span class="n">yaxis</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">shape</span><span class="p">[</span><span class="n">daxis</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>

    <span class="c1"># Now, we may have slightly more data than we actually need</span>
    <span class="c1"># (e.g., we may not actually want data at the start of the first year)</span>
    <span class="c1"># Define a time axis that represents *all* the data we just got:</span>
    <span class="n">uber_time</span> <span class="o">=</span> <span class="n">_jointime</span><span class="p">(</span><span class="n">years</span><span class="p">,</span> <span class="n">days</span><span class="p">)</span>

    <span class="c1"># Slice out what we actually wanted from this</span>
    <span class="n">slices</span> <span class="o">=</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)]</span> <span class="o">*</span> <span class="n">data</span><span class="o">.</span><span class="n">ndim</span>
    <span class="n">slices</span><span class="p">[</span><span class="n">taxis</span><span class="p">]</span> <span class="o">=</span> <span class="n">uber_time</span><span class="o">.</span><span class="n">map_to</span><span class="p">(</span><span class="n">times</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="n">slices</span><span class="p">]</span>
<span class="c1"># }}}</span>
<span class="c1"># }}}</span>

<div class="viewcode-block" id="jointimeaxes"><a class="viewcode-back" href="../../timeutils.html#pygeode.timeutils.jointimeaxes">[docs]</a><span class="k">def</span> <span class="nf">jointimeaxes</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">yaxis</span><span class="o">=</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="n">daxis</span><span class="o">=</span><span class="s1">&#39;day&#39;</span><span class="p">):</span>
<span class="c1"># {{{</span>
  <span class="sd">&#39;&#39;&#39;Convert a variable with a 2D time axis into one with a 1D time axis.&#39;&#39;&#39;</span>
  <span class="k">return</span> <span class="n">JoinTime</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">yaxis</span><span class="p">,</span> <span class="n">daxis</span><span class="p">)</span></div>
<span class="c1"># }}}</span>

<span class="k">del</span> <span class="n">Var</span>
</pre></div>

      </div>
      <div class="bottomnav" role="navigation" aria-label="bottom navigation">
      
        <p>
        <a class="uplink" href="../../reference.html">Reference</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../../tutorial.html">Tutorial</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../../gallery/index.html">Gallery</a>
        </p>

      </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2020, Mike Neish, Peter Hitchcock.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.3.2.
    </div>
  </body>
</html>