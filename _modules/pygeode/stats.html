
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>pygeode.stats &#8212; PyGeode 1.4.0 documentation</title>
    <link rel="stylesheet" href="../../_static/pygtheme.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/gallery.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
<link href="http://fonts.googleapis.com/css?family=Ubuntu:300,300italic,regular,italic,500,500italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='http://fonts.googleapis.com/css?family=Ubuntu+Mono:400,700' rel='stylesheet' type='text/css'>

  </head><body>
      <div class="header" role="banner"><h1 class="heading"><a href="../../index.html">
          <span>PyGeode 1.4.0 documentation</span></a></h1>
        <h2 class="heading"><span>pygeode.stats</span></h2>
      </div>
      <div class="topnav" role="navigation" aria-label="top navigation">
      
        <p>
        <a class="uplink" href="../../reference.html">Reference</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../../tutorial.html">Tutorial</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../../gallery/index.html">Gallery</a>
        </p>

      </div>
      <div class="content">
        
        
  <h1>Source code for pygeode.stats</h1><div class="highlight"><pre>
<span></span><span class="sd">&#39;&#39;&#39; Tools for computing some basic statistical quantities. &#39;&#39;&#39;</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;correlate&#39;</span><span class="p">,</span> <span class="s1">&#39;regress&#39;</span><span class="p">,</span> <span class="s1">&#39;multiple_regress&#39;</span><span class="p">,</span> <span class="s1">&#39;difference&#39;</span><span class="p">,</span> <span class="s1">&#39;paired_difference&#39;</span><span class="p">,</span> <span class="s1">&#39;isnonzero&#39;</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">norm</span><span class="p">,</span> <span class="n">t</span> <span class="k">as</span> <span class="n">tdist</span>

<div class="viewcode-block" id="correlate"><a class="viewcode-back" href="../../stats.html#pygeode.correlate">[docs]</a><span class="k">def</span> <span class="nf">correlate</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output</span> <span class="o">=</span> <span class="s1">&#39;r,p&#39;</span><span class="p">,</span> <span class="n">pbar</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="c1"># {{{</span>
  <span class="sa">r</span><span class="sd">&#39;&#39;&#39;Computes Pearson correlation coefficient between variables X and Y.</span>

<span class="sd">  Parameters</span>
<span class="sd">  ==========</span>
<span class="sd">  X, Y : :class:`Var`</span>
<span class="sd">    Variables to correlate. Must have at least one axis in common.</span>

<span class="sd">  axes : list, optional</span>
<span class="sd">    Axes over which to compute correlation; if nothing is specified, the correlation</span>
<span class="sd">    is computed over all axes common to  shared by X and Y.</span>

<span class="sd">  output : string, optional</span>
<span class="sd">    A string determining which parameters are returned; see list of possible outputs</span>
<span class="sd">    in the Returns section. The specifications must be separated by a comma. Defaults</span>
<span class="sd">    to &#39;r,p&#39;.</span>

<span class="sd">  pbar : progress bar, optional</span>
<span class="sd">    A progress bar object. If nothing is provided, a progress bar will be displayed</span>
<span class="sd">    if the calculation takes sufficiently long.</span>

<span class="sd">  Returns</span>
<span class="sd">  =======</span>
<span class="sd">  results : :class:`Dataset` </span>
<span class="sd">    The names of the variables match the output request string (i.e. if ``ds``</span>
<span class="sd">    is the returned dataset, the correlation coefficient can be obtained</span>
<span class="sd">    through ``ds.r2``).</span>

<span class="sd">    * &#39;r&#39;: The Pearson correlation coefficient :math:`\rho_{XY}`</span>
<span class="sd">    * &#39;r2&#39;: The coefficient of determination :math:`\rho^2_{XY}`</span>
<span class="sd">    * &#39;p&#39;:  The p-value; see notes.</span>

<span class="sd">  Notes</span>
<span class="sd">  =====</span>
<span class="sd">  The coefficient :math:`\rho_{XY}` is computed following von Storch and Zwiers</span>
<span class="sd">  1999, section 8.2.2. The p-value is the probability of finding a correlation</span>
<span class="sd">  coeefficient of equal or greater magnitude (two-sided) to the given result</span>
<span class="sd">  under the hypothesis that the true correlation coefficient between X and Y is</span>
<span class="sd">  zero. It is computed from the t-statistic given in eq (8.7), in section</span>
<span class="sd">  8.2.3, and assumes normally distributed quantities.&#39;&#39;&#39;</span>

  <span class="kn">from</span> <span class="nn">pygeode.tools</span> <span class="kn">import</span> <span class="n">loopover</span><span class="p">,</span> <span class="n">whichaxis</span><span class="p">,</span> <span class="n">combine_axes</span><span class="p">,</span> <span class="n">shared_axes</span><span class="p">,</span> <span class="n">npnansum</span>
  <span class="kn">from</span> <span class="nn">pygeode.view</span> <span class="kn">import</span> <span class="n">View</span>

  <span class="c1"># Split output request now</span>
  <span class="c1"># Default output is &#39;r,p&#39; so as not to break existing scripts</span>
  <span class="n">ovars</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="s1">&#39;r2&#39;</span><span class="p">,</span> <span class="s1">&#39;p&#39;</span><span class="p">]</span>
  <span class="n">output</span> <span class="o">=</span> <span class="p">[</span><span class="n">o</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">output</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">ovars</span><span class="p">]</span>
  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No valid outputs are requested from correlation. Possible outputs are </span><span class="si">%s</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">ovars</span><span class="p">))</span>

  <span class="n">xn</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="n">X</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="s1">&#39;X&#39;</span> <span class="c1"># Note: could write:  xn = X.name or &#39;X&#39;</span>
  <span class="n">yn</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="n">Y</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="s1">&#39;Y&#39;</span>

  <span class="c1"># Put all the axes being reduced over at the end </span>
  <span class="c1"># so that we can reshape </span>
  <span class="n">srcaxes</span> <span class="o">=</span> <span class="n">combine_axes</span><span class="p">([</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">])</span>
  <span class="n">oiaxes</span><span class="p">,</span> <span class="n">riaxes</span> <span class="o">=</span> <span class="n">shared_axes</span><span class="p">(</span><span class="n">srcaxes</span><span class="p">,</span> <span class="p">[</span><span class="n">X</span><span class="o">.</span><span class="n">axes</span><span class="p">,</span> <span class="n">Y</span><span class="o">.</span><span class="n">axes</span><span class="p">])</span>
  <span class="k">if</span> <span class="n">axes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">ri_new</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">:</span>
      <span class="n">i</span> <span class="o">=</span> <span class="n">whichaxis</span><span class="p">(</span><span class="n">srcaxes</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">riaxes</span><span class="p">:</span> 
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> axis not shared by X (&quot;</span><span class="si">%s</span><span class="s1">&quot;) and Y (&quot;</span><span class="si">%s</span><span class="s1">&quot;)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">xn</span><span class="p">,</span> <span class="n">yn</span><span class="p">))</span>
      <span class="n">ri_new</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="n">oiaxes</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">riaxes</span> <span class="k">if</span> <span class="n">r</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ri_new</span><span class="p">])</span>
    <span class="n">riaxes</span> <span class="o">=</span> <span class="n">ri_new</span>
    
  <span class="n">oaxes</span> <span class="o">=</span> <span class="p">[</span><span class="n">srcaxes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">oiaxes</span><span class="p">]</span>
  <span class="n">inaxes</span> <span class="o">=</span> <span class="n">oaxes</span> <span class="o">+</span> <span class="p">[</span><span class="n">srcaxes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">riaxes</span><span class="p">]</span>
  <span class="n">oview</span> <span class="o">=</span> <span class="n">View</span><span class="p">(</span><span class="n">oaxes</span><span class="p">)</span> 
  <span class="n">iview</span> <span class="o">=</span> <span class="n">View</span><span class="p">(</span><span class="n">inaxes</span><span class="p">)</span> 
  <span class="n">siaxes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">oaxes</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">srcaxes</span><span class="p">)))</span>

  <span class="c1"># Construct work arrays</span>
  <span class="n">x</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">oview</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>
  <span class="n">y</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">oview</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>
  <span class="n">xx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">oview</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>
  <span class="n">yy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">oview</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>
  <span class="n">xy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">oview</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>
  <span class="n">Na</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">oview</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>

  <span class="k">if</span> <span class="n">pbar</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">pygeode.progress</span> <span class="kn">import</span> <span class="n">PBar</span>
    <span class="n">pbar</span> <span class="o">=</span> <span class="n">PBar</span><span class="p">(</span><span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Computing correlation &#39;</span><span class="si">%s</span><span class="s2">&#39; vs &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">xn</span><span class="p">,</span> <span class="n">yn</span><span class="p">))</span>

  <span class="k">for</span> <span class="n">outsl</span><span class="p">,</span> <span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="n">ydata</span><span class="p">)</span> <span class="ow">in</span> <span class="n">loopover</span><span class="p">([</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">],</span> <span class="n">oview</span><span class="p">,</span> <span class="n">inaxes</span><span class="p">,</span> <span class="n">pbar</span><span class="o">=</span><span class="n">pbar</span><span class="p">):</span>
    <span class="n">xdata</span> <span class="o">=</span> <span class="n">xdata</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
    <span class="n">ydata</span> <span class="o">=</span> <span class="n">ydata</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
    <span class="n">xydata</span> <span class="o">=</span> <span class="n">xdata</span><span class="o">*</span><span class="n">ydata</span>

    <span class="n">xbc</span> <span class="o">=</span> <span class="p">[</span><span class="n">s1</span> <span class="o">//</span> <span class="n">s2</span> <span class="k">for</span> <span class="n">s1</span><span class="p">,</span> <span class="n">s2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">xydata</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">xdata</span><span class="o">.</span><span class="n">shape</span><span class="p">)]</span>
    <span class="n">ybc</span> <span class="o">=</span> <span class="p">[</span><span class="n">s1</span> <span class="o">//</span> <span class="n">s2</span> <span class="k">for</span> <span class="n">s1</span><span class="p">,</span> <span class="n">s2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">xydata</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">ydata</span><span class="o">.</span><span class="n">shape</span><span class="p">)]</span>
    <span class="n">xdata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="n">xbc</span><span class="p">)</span>
    <span class="n">ydata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">ydata</span><span class="p">,</span> <span class="n">ybc</span><span class="p">)</span>
    <span class="n">xdata</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">xydata</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">ydata</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">xydata</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="c1"># It seems np.nansum does not broadcast its arguments automatically</span>
    <span class="c1"># so there must be a better way of doing this...</span>
    <span class="n">x</span><span class="p">[</span><span class="n">outsl</span><span class="p">]</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="n">outsl</span><span class="p">],</span>  <span class="n">npnansum</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="n">siaxes</span><span class="p">)],</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">y</span><span class="p">[</span><span class="n">outsl</span><span class="p">]</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">([</span><span class="n">y</span><span class="p">[</span><span class="n">outsl</span><span class="p">],</span>  <span class="n">npnansum</span><span class="p">(</span><span class="n">ydata</span><span class="p">,</span> <span class="n">siaxes</span><span class="p">)],</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">xx</span><span class="p">[</span><span class="n">outsl</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">([</span><span class="n">xx</span><span class="p">[</span><span class="n">outsl</span><span class="p">],</span> <span class="n">npnansum</span><span class="p">(</span><span class="n">xdata</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">siaxes</span><span class="p">)],</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">yy</span><span class="p">[</span><span class="n">outsl</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">([</span><span class="n">yy</span><span class="p">[</span><span class="n">outsl</span><span class="p">],</span> <span class="n">npnansum</span><span class="p">(</span><span class="n">ydata</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">siaxes</span><span class="p">)],</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">xy</span><span class="p">[</span><span class="n">outsl</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">([</span><span class="n">xy</span><span class="p">[</span><span class="n">outsl</span><span class="p">],</span> <span class="n">npnansum</span><span class="p">(</span><span class="n">xydata</span><span class="p">,</span> <span class="n">siaxes</span><span class="p">)],</span> <span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Count of non-NaN data points</span>
    <span class="n">Na</span><span class="p">[</span><span class="n">outsl</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">([</span><span class="n">Na</span><span class="p">[</span><span class="n">outsl</span><span class="p">],</span> <span class="n">npnansum</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">xydata</span><span class="p">),</span> <span class="n">siaxes</span><span class="p">)],</span> <span class="mi">0</span><span class="p">)</span>

  <span class="n">imsk</span> <span class="o">=</span> <span class="p">(</span><span class="n">Na</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>

  <span class="n">xx</span><span class="p">[</span><span class="n">imsk</span><span class="p">]</span> <span class="o">-=</span> <span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">x</span><span class="p">)[</span><span class="n">imsk</span><span class="p">]</span><span class="o">/</span><span class="n">Na</span><span class="p">[</span><span class="n">imsk</span><span class="p">]</span>
  <span class="n">yy</span><span class="p">[</span><span class="n">imsk</span><span class="p">]</span> <span class="o">-=</span> <span class="p">(</span><span class="n">y</span><span class="o">*</span><span class="n">y</span><span class="p">)[</span><span class="n">imsk</span><span class="p">]</span><span class="o">/</span><span class="n">Na</span><span class="p">[</span><span class="n">imsk</span><span class="p">]</span>
  <span class="n">xy</span><span class="p">[</span><span class="n">imsk</span><span class="p">]</span> <span class="o">-=</span> <span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">y</span><span class="p">)[</span><span class="n">imsk</span><span class="p">]</span><span class="o">/</span><span class="n">Na</span><span class="p">[</span><span class="n">imsk</span><span class="p">]</span>

  <span class="c1"># Ensure variances are non-negative</span>
  <span class="n">xx</span><span class="p">[</span><span class="n">xx</span> <span class="o">&lt;=</span> <span class="mf">0.</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
  <span class="n">yy</span><span class="p">[</span><span class="n">yy</span> <span class="o">&lt;=</span> <span class="mf">0.</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>

  <span class="c1"># Compute correlation coefficient, t-statistic, p-value</span>
  <span class="n">den</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">oview</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>
  <span class="n">rho</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">oview</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>

  <span class="n">den</span><span class="p">[</span><span class="n">imsk</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">xx</span><span class="o">*</span><span class="n">yy</span><span class="p">)[</span><span class="n">imsk</span><span class="p">])</span>
  <span class="n">dmsk</span> <span class="o">=</span> <span class="p">(</span><span class="n">den</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">)</span>

  <span class="n">rho</span><span class="p">[</span><span class="n">dmsk</span><span class="p">]</span> <span class="o">=</span> <span class="n">xy</span><span class="p">[</span><span class="n">dmsk</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">xx</span><span class="o">*</span><span class="n">yy</span><span class="p">)[</span><span class="n">dmsk</span><span class="p">]</span>

  <span class="n">den</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">rho</span><span class="o">**</span><span class="mi">2</span>
  <span class="c1"># Saturate the denominator (when correlation is perfect) to avoid div by zero warnings</span>
  <span class="n">eps</span> <span class="o">=</span> <span class="mf">1e-8</span>
  <span class="n">den</span><span class="p">[</span><span class="n">den</span> <span class="o">&lt;</span> <span class="n">eps</span><span class="p">]</span> <span class="o">=</span> <span class="n">eps</span>

  <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">oview</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>
  <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">oview</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>

  <span class="n">t</span><span class="p">[</span><span class="n">imsk</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">rho</span><span class="p">)[</span><span class="n">imsk</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">Na</span><span class="p">[</span><span class="n">imsk</span><span class="p">]</span> <span class="o">-</span> <span class="mf">2.</span><span class="p">)</span><span class="o">/</span><span class="n">den</span><span class="p">[</span><span class="n">imsk</span><span class="p">])</span>
  <span class="n">p</span><span class="p">[</span><span class="n">imsk</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">tdist</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">imsk</span><span class="p">],</span> <span class="n">Na</span><span class="p">[</span><span class="n">imsk</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span><span class="p">))</span>

  <span class="n">p</span><span class="p">[</span><span class="o">~</span><span class="n">imsk</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
  <span class="n">rho</span><span class="p">[</span><span class="o">~</span><span class="n">imsk</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

  <span class="n">p</span><span class="p">[</span><span class="o">~</span><span class="n">dmsk</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
  <span class="n">rho</span><span class="p">[</span><span class="o">~</span><span class="n">dmsk</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

  <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>

  <span class="c1"># Construct and return variables</span>
  <span class="kn">from</span> <span class="nn">pygeode.var</span> <span class="kn">import</span> <span class="n">Var</span>
  <span class="kn">from</span> <span class="nn">pygeode.dataset</span> <span class="kn">import</span> <span class="n">asdataset</span>

  <span class="n">rvs</span> <span class="o">=</span> <span class="p">[]</span>

  <span class="k">if</span> <span class="s1">&#39;r&#39;</span> <span class="ow">in</span> <span class="n">output</span><span class="p">:</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">Var</span><span class="p">(</span><span class="n">oaxes</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="n">rho</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">atts</span><span class="p">[</span><span class="s1">&#39;longname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Correlation coefficient r between </span><span class="si">%s</span><span class="s1"> and </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">xn</span><span class="p">,</span> <span class="n">yn</span><span class="p">)</span>
    <span class="n">rvs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

  <span class="k">if</span> <span class="s1">&#39;r2&#39;</span> <span class="ow">in</span> <span class="n">output</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">warnings</span> <span class="kn">import</span> <span class="n">warn</span>
    <span class="n">warn</span> <span class="p">(</span><span class="s2">&quot;r2 now returns the correct value as opposed to r&quot;</span><span class="p">)</span>
    <span class="n">r2</span> <span class="o">=</span> <span class="n">Var</span><span class="p">(</span><span class="n">oaxes</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="n">rho</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;r2&#39;</span><span class="p">)</span>
    <span class="n">r2</span><span class="o">.</span><span class="n">atts</span><span class="p">[</span><span class="s1">&#39;longname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Coefficient of determination r^2 between </span><span class="si">%s</span><span class="s1"> and </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">xn</span><span class="p">,</span> <span class="n">yn</span><span class="p">)</span>
    <span class="n">rvs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r2</span><span class="p">)</span>

  <span class="k">if</span> <span class="s1">&#39;p&#39;</span> <span class="ow">in</span> <span class="n">output</span><span class="p">:</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">Var</span><span class="p">(</span><span class="n">oaxes</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="n">p</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;p&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">atts</span><span class="p">[</span><span class="s1">&#39;longname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;p-value for correlation coefficient between </span><span class="si">%s</span><span class="s1"> and </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">xn</span><span class="p">,</span> <span class="n">yn</span><span class="p">)</span>
    <span class="n">rvs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

  <span class="n">ds</span> <span class="o">=</span> <span class="n">asdataset</span><span class="p">(</span><span class="n">rvs</span><span class="p">)</span>
  <span class="n">ds</span><span class="o">.</span><span class="n">atts</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;correlation analysis </span><span class="si">%s</span><span class="s1"> against </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">yn</span><span class="p">,</span> <span class="n">xn</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">ds</span></div>
<span class="c1"># }}}</span>

<div class="viewcode-block" id="regress"><a class="viewcode-back" href="../../stats.html#pygeode.regress">[docs]</a><span class="k">def</span> <span class="nf">regress</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">N_fac</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="s1">&#39;m,b,p&#39;</span><span class="p">,</span> <span class="n">pbar</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="c1"># {{{</span>
  <span class="sa">r</span><span class="sd">&#39;&#39;&#39;Computes least-squares linear regression of Y against X.</span>

<span class="sd">  Parameters</span>
<span class="sd">  ==========</span>
<span class="sd">  X, Y : :class:`Var`</span>
<span class="sd">    Variables to regress. Must have at least one axis in common.</span>

<span class="sd">  axes : list, optional</span>
<span class="sd">    Axes over which to compute correlation; if nothing is specified, the correlation</span>
<span class="sd">    is computed over all axes common to X and Y.</span>

<span class="sd">  N_fac : integer</span>
<span class="sd">    A factor by which to rescale the estimated number of degrees of freedom; the effective</span>
<span class="sd">    number will be given by the number estimated from the dataset divided by ``N_fac``.</span>

<span class="sd">  output : string, optional</span>
<span class="sd">    A string determining which parameters are returned; see list of possible outputs</span>
<span class="sd">    in the Returns section. The specifications must be separated by a comma. Defaults </span>
<span class="sd">    to &#39;m,b,p&#39;.</span>

<span class="sd">  pbar : progress bar, optional</span>
<span class="sd">    A progress bar object. If nothing is provided, a progress bar will be displayed</span>
<span class="sd">    if the calculation takes sufficiently long.</span>

<span class="sd">  Returns</span>
<span class="sd">  =======</span>
<span class="sd">  results : :class:`Dataset` </span>
<span class="sd">    The returned variables are specified by the ``output`` argument. The names of the </span>
<span class="sd">    variables match the output request string (i.e. if ``ds`` is the returned dataset, the </span>
<span class="sd">    linear coefficient of the regression can be obtained by ``ds.m``). </span>
<span class="sd">    </span>
<span class="sd">    A fit of the form :math:`Y = m X + b + \epsilon` is assumed, and the</span>
<span class="sd">    following parameters can be returned:</span>

<span class="sd">    * &#39;m&#39;: Linear coefficient of the regression</span>
<span class="sd">    * &#39;b&#39;: Constant coefficient of the regression</span>
<span class="sd">    * &#39;r2&#39;: Fraction of the variance in Y explained by X (:math:`R^2`)</span>
<span class="sd">    * &#39;p&#39;: Probability of this fit under null hypothesis that true linear coefficient is zero</span>
<span class="sd">    * &#39;sm&#39;: Standard deviation of linear coefficient estimate (:math:`\hat{\sigma}_E/\sqrt{S_{XX}}`)</span>
<span class="sd">    * &#39;se&#39;: Standard deviation of residuals (:math:`\hat{\sigma}_E`)</span>

<span class="sd">  Notes</span>
<span class="sd">  =====</span>
<span class="sd">  The statistics described are computed following von Storch and Zwiers 1999,</span>
<span class="sd">  section 8.3. The p-value &#39;p&#39; is computed using the t-statistic given in</span>
<span class="sd">  section 8.3.8, and confidence intervals for the slope and intercept can be</span>
<span class="sd">  computed from &#39;sm&#39; or &#39;se&#39;.  The data is assumed to be normally</span>
<span class="sd">  distributed.&#39;&#39;&#39;</span>

  <span class="kn">from</span> <span class="nn">pygeode.tools</span> <span class="kn">import</span> <span class="n">loopover</span><span class="p">,</span> <span class="n">whichaxis</span><span class="p">,</span> <span class="n">combine_axes</span><span class="p">,</span> <span class="n">shared_axes</span><span class="p">,</span> <span class="n">npnansum</span>
  <span class="kn">from</span> <span class="nn">pygeode.view</span> <span class="kn">import</span> <span class="n">View</span>

  <span class="c1"># Split output request now</span>
  <span class="n">ovars</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;r2&#39;</span><span class="p">,</span> <span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="s1">&#39;sm&#39;</span><span class="p">,</span> <span class="s1">&#39;se&#39;</span><span class="p">]</span>
  <span class="n">output</span> <span class="o">=</span> <span class="p">[</span><span class="n">o</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">output</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">ovars</span><span class="p">]</span>
  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No valid outputs are requested from regression. Possible outputs are </span><span class="si">%s</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">ovars</span><span class="p">))</span>

  <span class="n">xn</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="n">X</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="s1">&#39;X&#39;</span>
  <span class="n">yn</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="n">Y</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="s1">&#39;Y&#39;</span>

  <span class="n">srcaxes</span> <span class="o">=</span> <span class="n">combine_axes</span><span class="p">([</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">])</span>
  <span class="n">oiaxes</span><span class="p">,</span> <span class="n">riaxes</span> <span class="o">=</span> <span class="n">shared_axes</span><span class="p">(</span><span class="n">srcaxes</span><span class="p">,</span> <span class="p">[</span><span class="n">X</span><span class="o">.</span><span class="n">axes</span><span class="p">,</span> <span class="n">Y</span><span class="o">.</span><span class="n">axes</span><span class="p">])</span>
  <span class="k">if</span> <span class="n">axes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">ri_new</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">:</span>
      <span class="n">i</span> <span class="o">=</span> <span class="n">whichaxis</span><span class="p">(</span><span class="n">srcaxes</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">riaxes</span><span class="p">:</span> 
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> axis not shared by X (&quot;</span><span class="si">%s</span><span class="s1">&quot;) and Y (&quot;</span><span class="si">%s</span><span class="s1">&quot;)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">xn</span><span class="p">,</span> <span class="n">yn</span><span class="p">))</span>
      <span class="n">ri_new</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="n">oiaxes</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">riaxes</span> <span class="k">if</span> <span class="n">r</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ri_new</span><span class="p">])</span>
    <span class="n">riaxes</span> <span class="o">=</span> <span class="n">ri_new</span>
    
  <span class="n">oaxes</span> <span class="o">=</span> <span class="p">[</span><span class="n">srcaxes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">oiaxes</span><span class="p">]</span>
  <span class="n">inaxes</span> <span class="o">=</span> <span class="n">oaxes</span> <span class="o">+</span> <span class="p">[</span><span class="n">srcaxes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">riaxes</span><span class="p">]</span>
  <span class="n">oview</span> <span class="o">=</span> <span class="n">View</span><span class="p">(</span><span class="n">oaxes</span><span class="p">)</span> 
  <span class="n">siaxes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">oaxes</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">srcaxes</span><span class="p">)))</span>

  <span class="k">if</span> <span class="n">pbar</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">pygeode.progress</span> <span class="kn">import</span> <span class="n">PBar</span>
    <span class="n">pbar</span> <span class="o">=</span> <span class="n">PBar</span><span class="p">(</span><span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Computing regression &#39;</span><span class="si">%s</span><span class="s2">&#39; vs &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">xn</span><span class="p">,</span> <span class="n">yn</span><span class="p">))</span>

  <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">riaxes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> and </span><span class="si">%s</span><span class="s1"> share no axes to be regressed over&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">xn</span><span class="p">,</span> <span class="n">yn</span><span class="p">)</span>

  <span class="c1"># Construct work arrays</span>
  <span class="n">x</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">oview</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>
  <span class="n">y</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">oview</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>
  <span class="n">xx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">oview</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>
  <span class="n">yy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">oview</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>
  <span class="n">xy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">oview</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>
  <span class="n">Na</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">oview</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>

  <span class="c1"># Accumulate data</span>
  <span class="k">for</span> <span class="n">outsl</span><span class="p">,</span> <span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="n">ydata</span><span class="p">)</span> <span class="ow">in</span> <span class="n">loopover</span><span class="p">([</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">],</span> <span class="n">oview</span><span class="p">,</span> <span class="n">inaxes</span><span class="p">,</span> <span class="n">pbar</span><span class="o">=</span><span class="n">pbar</span><span class="p">):</span>
    <span class="n">xdata</span> <span class="o">=</span> <span class="n">xdata</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
    <span class="n">ydata</span> <span class="o">=</span> <span class="n">ydata</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
    <span class="n">xydata</span> <span class="o">=</span> <span class="n">xdata</span><span class="o">*</span><span class="n">ydata</span>

    <span class="n">xbc</span> <span class="o">=</span> <span class="p">[</span><span class="n">s1</span> <span class="o">//</span> <span class="n">s2</span> <span class="k">for</span> <span class="n">s1</span><span class="p">,</span> <span class="n">s2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">xydata</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">xdata</span><span class="o">.</span><span class="n">shape</span><span class="p">)]</span>
    <span class="n">ybc</span> <span class="o">=</span> <span class="p">[</span><span class="n">s1</span> <span class="o">//</span> <span class="n">s2</span> <span class="k">for</span> <span class="n">s1</span><span class="p">,</span> <span class="n">s2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">xydata</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">ydata</span><span class="o">.</span><span class="n">shape</span><span class="p">)]</span>
    <span class="n">xdata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="n">xbc</span><span class="p">)</span>
    <span class="n">ydata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">ydata</span><span class="p">,</span> <span class="n">ybc</span><span class="p">)</span>
    <span class="n">xdata</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">xydata</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">ydata</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">xydata</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="c1"># It seems np.nansum does not broadcast its arguments automatically</span>
    <span class="c1"># so there must be a better way of doing this...</span>
    <span class="n">x</span><span class="p">[</span><span class="n">outsl</span><span class="p">]</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="n">outsl</span><span class="p">],</span>  <span class="n">npnansum</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="n">siaxes</span><span class="p">)],</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">y</span><span class="p">[</span><span class="n">outsl</span><span class="p">]</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">([</span><span class="n">y</span><span class="p">[</span><span class="n">outsl</span><span class="p">],</span>  <span class="n">npnansum</span><span class="p">(</span><span class="n">ydata</span><span class="p">,</span> <span class="n">siaxes</span><span class="p">)],</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">xx</span><span class="p">[</span><span class="n">outsl</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">([</span><span class="n">xx</span><span class="p">[</span><span class="n">outsl</span><span class="p">],</span> <span class="n">npnansum</span><span class="p">(</span><span class="n">xdata</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">siaxes</span><span class="p">)],</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">yy</span><span class="p">[</span><span class="n">outsl</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">([</span><span class="n">yy</span><span class="p">[</span><span class="n">outsl</span><span class="p">],</span> <span class="n">npnansum</span><span class="p">(</span><span class="n">ydata</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">siaxes</span><span class="p">)],</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">xy</span><span class="p">[</span><span class="n">outsl</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">([</span><span class="n">xy</span><span class="p">[</span><span class="n">outsl</span><span class="p">],</span> <span class="n">npnansum</span><span class="p">(</span><span class="n">xydata</span><span class="p">,</span> <span class="n">siaxes</span><span class="p">)],</span> <span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Sum of weights</span>
    <span class="n">Na</span><span class="p">[</span><span class="n">outsl</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">([</span><span class="n">Na</span><span class="p">[</span><span class="n">outsl</span><span class="p">],</span> <span class="n">npnansum</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">xydata</span><span class="p">),</span> <span class="n">siaxes</span><span class="p">)],</span> <span class="mi">0</span><span class="p">)</span>

  <span class="k">if</span> <span class="n">N_fac</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">N_eff</span> <span class="o">=</span> <span class="n">Na</span> <span class="o">-</span> <span class="mf">2.</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">N_eff</span> <span class="o">=</span> <span class="n">Na</span> <span class="o">/</span> <span class="n">N_fac</span> <span class="o">-</span> <span class="mf">2.</span>

  <span class="n">nmsk</span> <span class="o">=</span> <span class="p">(</span><span class="n">N_eff</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">)</span>

  <span class="n">xx</span><span class="p">[</span><span class="n">nmsk</span><span class="p">]</span> <span class="o">-=</span> <span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">x</span><span class="p">)[</span><span class="n">nmsk</span><span class="p">]</span><span class="o">/</span><span class="n">Na</span><span class="p">[</span><span class="n">nmsk</span><span class="p">]</span>
  <span class="n">yy</span><span class="p">[</span><span class="n">nmsk</span><span class="p">]</span> <span class="o">-=</span> <span class="p">(</span><span class="n">y</span><span class="o">*</span><span class="n">y</span><span class="p">)[</span><span class="n">nmsk</span><span class="p">]</span><span class="o">/</span><span class="n">Na</span><span class="p">[</span><span class="n">nmsk</span><span class="p">]</span>
  <span class="n">xy</span><span class="p">[</span><span class="n">nmsk</span><span class="p">]</span> <span class="o">-=</span> <span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">y</span><span class="p">)[</span><span class="n">nmsk</span><span class="p">]</span><span class="o">/</span><span class="n">Na</span><span class="p">[</span><span class="n">nmsk</span><span class="p">]</span>

  <span class="n">dmsk</span> <span class="o">=</span> <span class="p">(</span><span class="n">xx</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">)</span>

  <span class="n">m</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">oview</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>
  <span class="n">b</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">oview</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>
  <span class="n">r2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">oview</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>

  <span class="n">m</span><span class="p">[</span><span class="n">dmsk</span><span class="p">]</span> <span class="o">=</span> <span class="n">xy</span><span class="p">[</span><span class="n">dmsk</span><span class="p">]</span><span class="o">/</span><span class="n">xx</span><span class="p">[</span><span class="n">dmsk</span><span class="p">]</span>
  <span class="n">b</span><span class="p">[</span><span class="n">nmsk</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">nmsk</span><span class="p">]</span> <span class="o">-</span> <span class="n">m</span><span class="p">[</span><span class="n">nmsk</span><span class="p">]</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="n">nmsk</span><span class="p">])</span> <span class="o">/</span> <span class="n">Na</span><span class="p">[</span><span class="n">nmsk</span><span class="p">]</span>

  <span class="n">r2den</span> <span class="o">=</span> <span class="n">xx</span> <span class="o">*</span> <span class="n">yy</span>
  <span class="n">d2msk</span> <span class="o">=</span> <span class="p">(</span><span class="n">r2den</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">)</span>

  <span class="n">r2</span><span class="p">[</span><span class="n">d2msk</span><span class="p">]</span> <span class="o">=</span> <span class="n">xy</span><span class="p">[</span><span class="n">d2msk</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">r2den</span><span class="p">[</span><span class="n">d2msk</span><span class="p">]</span>

  <span class="n">sige</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">oview</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>
  <span class="n">sigm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">oview</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>
  <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">oview</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>
  <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">oview</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>

  <span class="n">sige</span><span class="p">[</span><span class="n">dmsk</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">yy</span><span class="p">[</span><span class="n">dmsk</span><span class="p">]</span> <span class="o">-</span> <span class="n">m</span><span class="p">[</span><span class="n">dmsk</span><span class="p">]</span> <span class="o">*</span> <span class="n">xy</span><span class="p">[</span><span class="n">dmsk</span><span class="p">])</span> <span class="o">/</span> <span class="n">N_eff</span><span class="p">[</span><span class="n">dmsk</span><span class="p">]</span>
  <span class="n">sigm</span><span class="p">[</span><span class="n">dmsk</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sige</span><span class="p">[</span><span class="n">dmsk</span><span class="p">]</span> <span class="o">/</span> <span class="n">xx</span><span class="p">[</span><span class="n">dmsk</span><span class="p">])</span>
  <span class="n">sige</span><span class="p">[</span><span class="n">dmsk</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sige</span><span class="p">[</span><span class="n">dmsk</span><span class="p">])</span>
  <span class="n">t</span><span class="p">[</span><span class="n">dmsk</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="n">dmsk</span><span class="p">])</span> <span class="o">/</span> <span class="n">sigm</span><span class="p">[</span><span class="n">dmsk</span><span class="p">]</span>
  <span class="n">p</span><span class="p">[</span><span class="n">dmsk</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">tdist</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">dmsk</span><span class="p">],</span> <span class="n">N_eff</span><span class="p">[</span><span class="n">dmsk</span><span class="p">]))</span>

  <span class="n">msk</span> <span class="o">=</span> <span class="n">nmsk</span> <span class="o">&amp;</span> <span class="n">dmsk</span>
   
  <span class="n">m</span><span class="p">[</span><span class="o">~</span><span class="n">msk</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
  <span class="n">b</span><span class="p">[</span><span class="o">~</span><span class="n">msk</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
  <span class="n">sige</span><span class="p">[</span><span class="o">~</span><span class="n">msk</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
  <span class="n">sigm</span><span class="p">[</span><span class="o">~</span><span class="n">msk</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
  <span class="n">p</span><span class="p">[</span><span class="o">~</span><span class="n">msk</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

  <span class="n">msk</span> <span class="o">=</span> <span class="n">nmsk</span> <span class="o">&amp;</span> <span class="n">d2msk</span>
  <span class="n">r2</span><span class="p">[</span><span class="o">~</span><span class="n">msk</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

  <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>

  <span class="kn">from</span> <span class="nn">pygeode.var</span> <span class="kn">import</span> <span class="n">Var</span>
  <span class="kn">from</span> <span class="nn">pygeode.dataset</span> <span class="kn">import</span> <span class="n">asdataset</span>
  
  <span class="n">rvs</span> <span class="o">=</span> <span class="p">[]</span>

  <span class="k">if</span> <span class="s1">&#39;m&#39;</span> <span class="ow">in</span> <span class="n">output</span><span class="p">:</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">Var</span><span class="p">(</span><span class="n">oaxes</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="n">m</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;m&#39;</span><span class="p">)</span>
    <span class="n">M</span><span class="o">.</span><span class="n">atts</span><span class="p">[</span><span class="s1">&#39;longname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;slope&#39;</span>
    <span class="n">rvs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>

  <span class="k">if</span> <span class="s1">&#39;b&#39;</span> <span class="ow">in</span> <span class="n">output</span><span class="p">:</span>
    <span class="n">B</span> <span class="o">=</span> <span class="n">Var</span><span class="p">(</span><span class="n">oaxes</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="n">b</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
    <span class="n">B</span><span class="o">.</span><span class="n">atts</span><span class="p">[</span><span class="s1">&#39;longname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;intercept&#39;</span>
    <span class="n">rvs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">B</span><span class="p">)</span>

  <span class="k">if</span> <span class="s1">&#39;r2&#39;</span> <span class="ow">in</span> <span class="n">output</span><span class="p">:</span>
    <span class="n">R2</span> <span class="o">=</span> <span class="n">Var</span><span class="p">(</span><span class="n">oaxes</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="n">r2</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;r2&#39;</span><span class="p">)</span>
    <span class="n">R2</span><span class="o">.</span><span class="n">atts</span><span class="p">[</span><span class="s1">&#39;longname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;fraction of variance explained&#39;</span>
    <span class="n">rvs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">R2</span><span class="p">)</span>

  <span class="k">if</span> <span class="s1">&#39;p&#39;</span> <span class="ow">in</span> <span class="n">output</span><span class="p">:</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">Var</span><span class="p">(</span><span class="n">oaxes</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="n">p</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;p&#39;</span><span class="p">)</span>
    <span class="n">P</span><span class="o">.</span><span class="n">atts</span><span class="p">[</span><span class="s1">&#39;longname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;p-value&#39;</span>
    <span class="n">rvs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>

  <span class="k">if</span> <span class="s1">&#39;sm&#39;</span> <span class="ow">in</span> <span class="n">output</span><span class="p">:</span>
    <span class="n">SM</span> <span class="o">=</span> <span class="n">Var</span><span class="p">(</span><span class="n">oaxes</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="n">sigm</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;sm&#39;</span><span class="p">)</span>
    <span class="n">SM</span><span class="o">.</span><span class="n">atts</span><span class="p">[</span><span class="s1">&#39;longname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;standard deviation of slope parameter&#39;</span>
    <span class="n">rvs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SM</span><span class="p">)</span>

  <span class="k">if</span> <span class="s1">&#39;se&#39;</span> <span class="ow">in</span> <span class="n">output</span><span class="p">:</span>
    <span class="n">SE</span> <span class="o">=</span> <span class="n">Var</span><span class="p">(</span><span class="n">oaxes</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="n">sige</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;se&#39;</span><span class="p">)</span>
    <span class="n">SE</span><span class="o">.</span><span class="n">atts</span><span class="p">[</span><span class="s1">&#39;longname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;standard deviation of residual&#39;</span>
    <span class="n">rvs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SE</span><span class="p">)</span>

  <span class="n">ds</span> <span class="o">=</span> <span class="n">asdataset</span><span class="p">(</span><span class="n">rvs</span><span class="p">)</span>
  <span class="n">ds</span><span class="o">.</span><span class="n">atts</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;linear regression parameters for </span><span class="si">%s</span><span class="s1"> regressed against </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">yn</span><span class="p">,</span> <span class="n">xn</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">ds</span></div>
<span class="c1"># }}}</span>

<div class="viewcode-block" id="multiple_regress"><a class="viewcode-back" href="../../stats.html#pygeode.multiple_regress">[docs]</a><span class="k">def</span> <span class="nf">multiple_regress</span><span class="p">(</span><span class="n">Xs</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">N_fac</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="s1">&#39;B,p&#39;</span><span class="p">,</span> <span class="n">pbar</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="c1"># {{{</span>
  <span class="sa">r</span><span class="sd">&#39;&#39;&#39;Computes least-squares multiple regression of Y against variables Xs.</span>

<span class="sd">  Parameters</span>
<span class="sd">  ==========</span>
<span class="sd">  Xs : list of :class:`Var` instances</span>
<span class="sd">    Variables to treat as independent regressors. Must have at least one axis</span>
<span class="sd">    in common with each other and with Y.</span>

<span class="sd">  Y : :class:`Var`</span>
<span class="sd">    The dependent variable. Must have at least one axis in common with the Xs.</span>

<span class="sd">  axes : list, optional</span>
<span class="sd">    Axes over which to compute correlation; if nothing is specified, the correlation</span>
<span class="sd">    is computed over all axes common to the Xs and Y.</span>

<span class="sd">  N_fac : integer</span>
<span class="sd">    A factor by which to rescale the estimated number of degrees of freedom; the effective</span>
<span class="sd">    number will be given by the number estimated from the dataset divided by ``N_fac``.</span>

<span class="sd">  output : string, optional</span>
<span class="sd">    A string determining which parameters are returned; see list of possible outputs</span>
<span class="sd">    in the Returns section. The specifications must be separated by a comma. Defaults </span>
<span class="sd">    to &#39;B,p&#39;.</span>

<span class="sd">  pbar : progress bar, optional</span>
<span class="sd">    A progress bar object. If nothing is provided, a progress bar will be displayed</span>
<span class="sd">    if the calculation takes sufficiently long.</span>

<span class="sd">  Returns</span>
<span class="sd">  =======</span>
<span class="sd">  results : tuple of floats or :class:`Var` instances.</span>
<span class="sd">    The return values are specified by the ``output`` argument. The names of the </span>
<span class="sd">    variables match the output request string (i.e. if ``ds`` is the returned dataset, the </span>
<span class="sd">    linear coefficient of the regression can be obtained by ``ds.m``). </span>
<span class="sd">    </span>
<span class="sd">    A fit of the form :math:`Y = \sum_i \beta_i X_i + \epsilon` is assumed.</span>
<span class="sd">    Note that a constant term is not included by default. The following</span>
<span class="sd">    parameters can be returned:</span>

<span class="sd">    * &#39;B&#39;: Linear coefficients :math:`\beta_i` of each regressor</span>
<span class="sd">    * &#39;r2&#39;: Fraction of the variance in Y explained by all Xs (:math:`R^2`)</span>
<span class="sd">    * &#39;p&#39;: p-value of regession; see notes.</span>
<span class="sd">    * &#39;sb&#39;: Standard deviation of each linear coefficient</span>
<span class="sd">    * &#39;covb&#39;: Covariance matrix of the linear coefficients</span>
<span class="sd">    * &#39;se&#39;: Standard deviation of residuals</span>

<span class="sd">    The outputs &#39;B&#39;, &#39;p&#39;, and &#39;sb&#39; will produce as many outputs as there are</span>
<span class="sd">    regressors. </span>

<span class="sd">  Notes</span>
<span class="sd">  =====</span>
<span class="sd">  The statistics described are computed following von Storch and Zwiers 1999,</span>
<span class="sd">  section 8.4. The p-value &#39;p&#39; is computed using the t-statistic appropriate</span>
<span class="sd">  for the multi-variate normal estimator :math:`\hat{\vec{a}}` given in section</span>
<span class="sd">  8.4.2; it corresponds to the probability of obtaining the regression</span>
<span class="sd">  coefficient under the null hypothesis that there is no linear relationship.</span>
<span class="sd">  Note this may not be the best way to determine if a given parameter is</span>
<span class="sd">  contributing a significant fraction to the explained variance of Y.  The</span>
<span class="sd">  variances &#39;se&#39; and &#39;sb&#39; are :math:`\hat{\sigma}_E` and the square root of the</span>
<span class="sd">  diagonal elements of :math:`\hat{\sigma}^2_E (\chi^T\chi)` in von Storch and</span>
<span class="sd">  Zwiers, respectively.  The data is assumed to be normally distributed.&#39;&#39;&#39;</span>

  <span class="kn">from</span> <span class="nn">pygeode.tools</span> <span class="kn">import</span> <span class="n">loopover</span><span class="p">,</span> <span class="n">whichaxis</span><span class="p">,</span> <span class="n">combine_axes</span><span class="p">,</span> <span class="n">shared_axes</span><span class="p">,</span> <span class="n">npsum</span>
  <span class="kn">from</span> <span class="nn">pygeode.view</span> <span class="kn">import</span> <span class="n">View</span>

  <span class="c1"># Split output request now</span>
  <span class="n">ovars</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">,</span> <span class="s1">&#39;r2&#39;</span><span class="p">,</span> <span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="s1">&#39;sb&#39;</span><span class="p">,</span> <span class="s1">&#39;covb&#39;</span><span class="p">,</span> <span class="s1">&#39;se&#39;</span><span class="p">]</span>
  <span class="n">output</span> <span class="o">=</span> <span class="p">[</span><span class="n">o</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">output</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">ovars</span><span class="p">]</span>
  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No valid outputs are requested from correlation. Possible outputs are </span><span class="si">%s</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">ovars</span><span class="p">))</span>

  <span class="n">Nr</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Xs</span><span class="p">)</span>

  <span class="n">Xaxes</span> <span class="o">=</span> <span class="n">combine_axes</span><span class="p">(</span><span class="n">Xs</span><span class="p">)</span>

  <span class="n">srcaxes</span> <span class="o">=</span> <span class="n">combine_axes</span><span class="p">([</span><span class="n">Xaxes</span><span class="p">,</span> <span class="n">Y</span><span class="p">])</span>
  <span class="n">oiaxes</span><span class="p">,</span> <span class="n">riaxes</span> <span class="o">=</span> <span class="n">shared_axes</span><span class="p">(</span><span class="n">srcaxes</span><span class="p">,</span> <span class="p">[</span><span class="n">Xaxes</span><span class="p">,</span> <span class="n">Y</span><span class="o">.</span><span class="n">axes</span><span class="p">])</span>
  <span class="k">if</span> <span class="n">axes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">ri_new</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">:</span>
      <span class="n">ia</span> <span class="o">=</span> <span class="n">whichaxis</span><span class="p">(</span><span class="n">srcaxes</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">ia</span> <span class="ow">in</span> <span class="n">riaxes</span><span class="p">:</span> <span class="n">ri_new</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ia</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;One of the Xs or Y does not have the axis </span><span class="si">%s</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="n">a</span><span class="p">)</span>
    <span class="n">oiaxes</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">riaxes</span> <span class="k">if</span> <span class="n">r</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ri_new</span><span class="p">])</span>
    <span class="n">riaxes</span> <span class="o">=</span> <span class="n">ri_new</span>
    
  <span class="n">oaxes</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">srcaxes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">oiaxes</span><span class="p">])</span>
  <span class="n">inaxes</span> <span class="o">=</span> <span class="n">oaxes</span> <span class="o">+</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">srcaxes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">riaxes</span><span class="p">])</span>
  <span class="n">oview</span> <span class="o">=</span> <span class="n">View</span><span class="p">(</span><span class="n">oaxes</span><span class="p">)</span> 
  <span class="n">siaxes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">oaxes</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">srcaxes</span><span class="p">)))</span>

  <span class="k">if</span> <span class="n">pbar</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">pygeode.progress</span> <span class="kn">import</span> <span class="n">PBar</span>
    <span class="n">pbar</span> <span class="o">=</span> <span class="n">PBar</span><span class="p">()</span>

  <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">riaxes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;Regressors and </span><span class="si">%s</span><span class="s1"> share no axes to be regressed over&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

  <span class="c1"># Construct work arrays</span>
  <span class="n">os</span> <span class="o">=</span> <span class="n">oview</span><span class="o">.</span><span class="n">shape</span>
  <span class="n">os1</span> <span class="o">=</span> <span class="n">os</span> <span class="o">+</span> <span class="p">(</span><span class="n">Nr</span><span class="p">,)</span>
  <span class="n">os2</span> <span class="o">=</span> <span class="n">os</span> <span class="o">+</span> <span class="p">(</span><span class="n">Nr</span><span class="p">,</span><span class="n">Nr</span><span class="p">)</span>
  <span class="n">y</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>
  <span class="n">yy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>
  <span class="n">xy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">os1</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>
  <span class="n">xx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">os2</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>
  <span class="n">xxinv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">os2</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>

  <span class="n">N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">srcaxes</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">riaxes</span><span class="p">])</span>

  <span class="c1"># Accumulate data</span>
  <span class="k">for</span> <span class="n">outsl</span><span class="p">,</span> <span class="n">datatuple</span> <span class="ow">in</span> <span class="n">loopover</span><span class="p">(</span><span class="n">Xs</span> <span class="o">+</span> <span class="p">[</span><span class="n">Y</span><span class="p">],</span> <span class="n">oview</span><span class="p">,</span> <span class="n">inaxes</span><span class="p">,</span> <span class="n">pbar</span><span class="o">=</span><span class="n">pbar</span><span class="p">):</span>
    <span class="n">ydata</span> <span class="o">=</span>  <span class="n">datatuple</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
    <span class="n">xdata</span> <span class="o">=</span> <span class="p">[</span><span class="n">datatuple</span><span class="p">[</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nr</span><span class="p">)]</span>
    <span class="n">y</span><span class="p">[</span><span class="n">outsl</span><span class="p">]</span>  <span class="o">+=</span> <span class="n">npsum</span><span class="p">(</span><span class="n">ydata</span><span class="p">,</span>    <span class="n">siaxes</span><span class="p">)</span>
    <span class="n">yy</span><span class="p">[</span><span class="n">outsl</span><span class="p">]</span> <span class="o">+=</span> <span class="n">npsum</span><span class="p">(</span><span class="n">ydata</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">siaxes</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nr</span><span class="p">):</span>
      <span class="n">xy</span><span class="p">[</span><span class="n">outsl</span><span class="o">+</span><span class="p">(</span><span class="n">i</span><span class="p">,)]</span> <span class="o">+=</span> <span class="n">npsum</span><span class="p">(</span><span class="n">xdata</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">ydata</span><span class="p">,</span> <span class="n">siaxes</span><span class="p">)</span>
      <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">xx</span><span class="p">[</span><span class="n">outsl</span><span class="o">+</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)]</span> <span class="o">+=</span> <span class="n">npsum</span><span class="p">(</span><span class="n">xdata</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">xdata</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">siaxes</span><span class="p">)</span>

  <span class="c1"># Fill in opposite side of xTx</span>
  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nr</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
      <span class="n">xx</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">xx</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>

  <span class="c1"># Compute inverse of covariance matrix (could be done more intellegently? certainly the python</span>
  <span class="c1"># loop over oview does not help)</span>
  <span class="n">xx</span>    <span class="o">=</span> <span class="n">xx</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">Nr</span><span class="p">,</span> <span class="n">Nr</span><span class="p">)</span>
  <span class="n">xxinv</span> <span class="o">=</span> <span class="n">xxinv</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">Nr</span><span class="p">,</span> <span class="n">Nr</span><span class="p">)</span>
  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">xx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
    <span class="n">xxinv</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">xx</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:])</span>
  <span class="n">xx</span> <span class="o">=</span> <span class="n">xx</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">os2</span><span class="p">)</span>
  <span class="n">xxinv</span> <span class="o">=</span> <span class="n">xxinv</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">os2</span><span class="p">)</span>

  <span class="n">beta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">xy</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">os</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">Nr</span><span class="p">))</span> <span class="o">*</span> <span class="n">xxinv</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
  <span class="n">vare</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">xy</span> <span class="o">*</span> <span class="n">beta</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

  <span class="k">if</span> <span class="n">N_fac</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">N_eff</span> <span class="o">=</span> <span class="n">N</span>
  <span class="k">else</span><span class="p">:</span> <span class="n">N_eff</span> <span class="o">=</span> <span class="n">N</span> <span class="o">//</span> <span class="n">N_fac</span>

  <span class="n">sigbeta</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">yy</span> <span class="o">-</span> <span class="n">vare</span><span class="p">)</span> <span class="o">*</span> <span class="n">xxinv</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">N_eff</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nr</span><span class="p">)]</span>

  <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>

  <span class="n">xns</span> <span class="o">=</span> <span class="p">[</span><span class="n">X</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="n">X</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="s1">&#39;X</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">X</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">Xs</span><span class="p">)]</span>
  <span class="n">yn</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="n">Y</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="s1">&#39;Y&#39;</span>

  <span class="kn">from</span> <span class="nn">.var</span> <span class="kn">import</span> <span class="n">Var</span>
  <span class="kn">from</span> <span class="nn">.dataset</span> <span class="kn">import</span> <span class="n">asdataset</span>
  <span class="kn">from</span> <span class="nn">.axis</span> <span class="kn">import</span> <span class="n">NonCoordinateAxis</span>

  <span class="n">ra</span>  <span class="o">=</span> <span class="n">NonCoordinateAxis</span><span class="p">(</span><span class="n">values</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">Nr</span><span class="p">),</span> <span class="n">regressor</span> <span class="o">=</span> <span class="n">xns</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;regressor&#39;</span><span class="p">)</span>
  <span class="n">ra2</span> <span class="o">=</span> <span class="n">NonCoordinateAxis</span><span class="p">(</span><span class="n">values</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">Nr</span><span class="p">),</span> <span class="n">regressor</span> <span class="o">=</span> <span class="n">xns</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;regressor2&#39;</span><span class="p">)</span>
  <span class="n">Nd</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">oaxes</span><span class="p">)</span>

  <span class="n">rvs</span> <span class="o">=</span> <span class="p">[]</span>

  <span class="k">if</span> <span class="s1">&#39;beta&#39;</span> <span class="ow">in</span> <span class="n">output</span><span class="p">:</span>
    <span class="n">B</span> <span class="o">=</span> <span class="n">Var</span><span class="p">(</span><span class="n">oaxes</span> <span class="o">+</span> <span class="p">(</span><span class="n">ra</span><span class="p">,),</span> <span class="n">values</span><span class="o">=</span><span class="n">beta</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;beta&#39;</span><span class="p">)</span>
    <span class="n">B</span><span class="o">.</span><span class="n">atts</span><span class="p">[</span><span class="s1">&#39;longname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;regression coefficient&#39;</span>
    <span class="n">rvs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">B</span><span class="p">)</span>

  <span class="k">if</span> <span class="s1">&#39;r2&#39;</span> <span class="ow">in</span> <span class="n">output</span><span class="p">:</span>
    <span class="n">vary</span> <span class="o">=</span> <span class="p">(</span><span class="n">yy</span> <span class="o">-</span> <span class="n">y</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">N</span><span class="p">)</span>
    <span class="n">R2</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">yy</span> <span class="o">-</span> <span class="n">vare</span><span class="p">)</span> <span class="o">/</span> <span class="n">vary</span>
    <span class="n">R2</span> <span class="o">=</span> <span class="n">Var</span><span class="p">(</span><span class="n">oaxes</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="n">R2</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;R2&#39;</span><span class="p">)</span>
    <span class="n">R2</span><span class="o">.</span><span class="n">atts</span><span class="p">[</span><span class="s1">&#39;longname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;fraction of variance explained&#39;</span>
    <span class="n">rvs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">R2</span><span class="p">)</span>

  <span class="k">if</span> <span class="s1">&#39;p&#39;</span> <span class="ow">in</span> <span class="n">output</span><span class="p">:</span>
    <span class="n">p</span> <span class="o">=</span> <span class="p">[</span><span class="mf">2.</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">tdist</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">beta</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">sigbeta</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">N_eff</span><span class="o">-</span><span class="n">Nr</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nr</span><span class="p">)]</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="p">[</span><span class="n">Nd</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">Nd</span><span class="p">)))</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">Var</span><span class="p">(</span><span class="n">oaxes</span> <span class="o">+</span> <span class="p">(</span><span class="n">ra</span><span class="p">,),</span> <span class="n">values</span><span class="o">=</span><span class="n">p</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;p&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">atts</span><span class="p">[</span><span class="s1">&#39;longname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;p-values&#39;</span>
    <span class="n">rvs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

  <span class="k">if</span> <span class="s1">&#39;sb&#39;</span> <span class="ow">in</span> <span class="n">output</span><span class="p">:</span>
    <span class="n">sigbeta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sigbeta</span><span class="p">),</span> <span class="p">[</span><span class="n">Nd</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">Nd</span><span class="p">)))</span>
    <span class="n">sb</span> <span class="o">=</span> <span class="n">Var</span><span class="p">(</span><span class="n">oaxes</span> <span class="o">+</span> <span class="p">(</span><span class="n">ra</span><span class="p">,),</span> <span class="n">values</span><span class="o">=</span><span class="n">sigbeta</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;sb&#39;</span><span class="p">)</span>
    <span class="n">sb</span><span class="o">.</span><span class="n">atts</span><span class="p">[</span><span class="s1">&#39;longname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;standard deviation of linear coefficients&#39;</span>
    <span class="n">rvs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span>

  <span class="k">if</span> <span class="s1">&#39;covb&#39;</span> <span class="ow">in</span> <span class="n">output</span><span class="p">:</span>
    <span class="n">sigmat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">os2</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nr</span><span class="p">):</span>
      <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nr</span><span class="p">):</span>
        <span class="c1">#sigmat[..., i, j] = np.sqrt((yy - vare) * xxinv[..., i, j] / N_eff)</span>
        <span class="n">sigmat</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">yy</span> <span class="o">-</span> <span class="n">vare</span><span class="p">)</span> <span class="o">*</span> <span class="n">xxinv</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">/</span> <span class="n">N_eff</span>
    <span class="n">covb</span> <span class="o">=</span> <span class="n">Var</span><span class="p">(</span><span class="n">oaxes</span> <span class="o">+</span> <span class="p">(</span><span class="n">ra</span><span class="p">,</span> <span class="n">ra2</span><span class="p">),</span> <span class="n">values</span><span class="o">=</span><span class="n">sigmat</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;covb&#39;</span><span class="p">)</span>
    <span class="n">covb</span><span class="o">.</span><span class="n">atts</span><span class="p">[</span><span class="s1">&#39;longname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Covariance matrix of the linear coefficients&#39;</span>
    <span class="n">rvs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">covb</span><span class="p">)</span>

  <span class="k">if</span> <span class="s1">&#39;se&#39;</span> <span class="ow">in</span> <span class="n">output</span><span class="p">:</span>
    <span class="n">se</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">yy</span> <span class="o">-</span> <span class="n">vare</span><span class="p">)</span> <span class="o">/</span> <span class="n">N_eff</span><span class="p">)</span>
    <span class="n">se</span> <span class="o">=</span> <span class="n">Var</span><span class="p">(</span><span class="n">oaxes</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="n">se</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;se&#39;</span><span class="p">)</span>
    <span class="n">se</span><span class="o">.</span><span class="n">atts</span><span class="p">[</span><span class="s1">&#39;longname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;standard deviation of residual&#39;</span>
    <span class="n">rvs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">se</span><span class="p">)</span>

  <span class="n">ds</span> <span class="o">=</span> <span class="n">asdataset</span><span class="p">(</span><span class="n">rvs</span><span class="p">)</span>
  <span class="n">ds</span><span class="o">.</span><span class="n">atts</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;multiple linear regression parameters for </span><span class="si">%s</span><span class="s1"> regressed against </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">yn</span><span class="p">,</span> <span class="n">xns</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">ds</span></div>
<span class="c1"># }}}</span>

<div class="viewcode-block" id="difference"><a class="viewcode-back" href="../../stats.html#pygeode.difference">[docs]</a><span class="k">def</span> <span class="nf">difference</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">Nx_fac</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">Ny_fac</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="s1">&#39;d,p,ci&#39;</span><span class="p">,</span> <span class="n">pbar</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="c1"># {{{</span>
  <span class="sa">r</span><span class="sd">&#39;&#39;&#39;Computes the mean value and statistics of X - Y.</span>

<span class="sd">  Parameters</span>
<span class="sd">  ==========</span>
<span class="sd">  X, Y : :class:`Var`</span>
<span class="sd">    Variables to difference. Must have at least one axis in common.</span>

<span class="sd">  axes : list, optional, defaults to None</span>
<span class="sd">    Axes over which to compute means; if othing is specified, the mean</span>
<span class="sd">    is computed over all axes common to X and Y.</span>

<span class="sd">  alpha : float, optional; defaults to 0.05</span>
<span class="sd">    Confidence level for which to compute confidence interval.</span>

<span class="sd">  Nx_fac : integer, optional: defaults to None</span>
<span class="sd">    A factor by which to rescale the estimated number of degrees of freedom of</span>
<span class="sd">    X; the effective number will be given by the number estimated from the</span>
<span class="sd">    dataset divided by ``Nx_fac``.</span>

<span class="sd">  Ny_fac : integer, optional: defaults to None</span>
<span class="sd">    A factor by which to rescale the estimated number of degrees of freedom of</span>
<span class="sd">    Y; the effective number will be given by the number estimated from the</span>
<span class="sd">    dataset divided by ``Ny_fac``.</span>

<span class="sd">  output : string, optional</span>
<span class="sd">    A string determining which parameters are returned; see list of possible outputs</span>
<span class="sd">    in the Returns section. The specifications must be separated by a comma. Defaults </span>
<span class="sd">    to &#39;d,p,ci&#39;.</span>

<span class="sd">  pbar : progress bar, optional</span>
<span class="sd">    A progress bar object. If nothing is provided, a progress bar will be displayed</span>
<span class="sd">    if the calculation takes sufficiently long.</span>

<span class="sd">  Returns</span>
<span class="sd">  =======</span>
<span class="sd">  results : :class:`Dataset` </span>
<span class="sd">    The returned variables are specified by the ``output`` argument. The names</span>
<span class="sd">    of the variables match the output request string (i.e. if ``ds`` is the</span>
<span class="sd">    returned dataset, the average of the difference can be obtained by</span>
<span class="sd">    ``ds.d``). The following four quantities can be computed:</span>

<span class="sd">    * &#39;d&#39;: The difference in the means, X - Y</span>
<span class="sd">    * &#39;df&#39;: The effective number of degrees of freedom, :math:`df`</span>
<span class="sd">    * &#39;p&#39;: The p-value; see notes.</span>
<span class="sd">    * &#39;ci&#39;: The confidence interval of the difference at the level specified by ``alpha``</span>

<span class="sd">  See Also</span>
<span class="sd">  ========</span>
<span class="sd">  isnonzero</span>
<span class="sd">  paired_difference</span>

<span class="sd">  Notes</span>
<span class="sd">  =====</span>
<span class="sd">  The effective number of degrees of freedom is estimated using eq (6.20) of </span>
<span class="sd">  von Storch and Zwiers 1999, in which :math:`n_X` and :math:`n_Y` are scaled by</span>
<span class="sd">  Nx_fac and Ny_fac, respectively. This provides a means of taking into account</span>
<span class="sd">  serial correlation in the data (see sections 6.6.7-9), but the number of effective</span>
<span class="sd">  degrees of freedom are not calculated explicitly by this routine. The p-value and </span>
<span class="sd">  confidence interval are computed based on the t-statistic in eq (6.19).&#39;&#39;&#39;</span>

  <span class="kn">from</span> <span class="nn">pygeode.tools</span> <span class="kn">import</span> <span class="n">loopover</span><span class="p">,</span> <span class="n">whichaxis</span><span class="p">,</span> <span class="n">combine_axes</span><span class="p">,</span> <span class="n">shared_axes</span><span class="p">,</span> <span class="n">npnansum</span>
  <span class="kn">from</span> <span class="nn">pygeode.view</span> <span class="kn">import</span> <span class="n">View</span>

  <span class="c1"># Split output request now</span>
  <span class="n">ovars</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="s1">&#39;df&#39;</span><span class="p">,</span> <span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="s1">&#39;ci&#39;</span><span class="p">]</span>
  <span class="n">output</span> <span class="o">=</span> <span class="p">[</span><span class="n">o</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">output</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">ovars</span><span class="p">]</span>
  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No valid outputs are requested from correlation. Possible outputs are </span><span class="si">%s</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">ovars</span><span class="p">))</span>

  <span class="n">srcaxes</span> <span class="o">=</span> <span class="n">combine_axes</span><span class="p">([</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">])</span>
  <span class="n">oiaxes</span><span class="p">,</span> <span class="n">riaxes</span> <span class="o">=</span> <span class="n">shared_axes</span><span class="p">(</span><span class="n">srcaxes</span><span class="p">,</span> <span class="p">[</span><span class="n">X</span><span class="o">.</span><span class="n">axes</span><span class="p">,</span> <span class="n">Y</span><span class="o">.</span><span class="n">axes</span><span class="p">])</span>
  <span class="k">if</span> <span class="n">axes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">ri_new</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">:</span>
      <span class="n">i</span> <span class="o">=</span> <span class="n">whichaxis</span><span class="p">(</span><span class="n">srcaxes</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">riaxes</span><span class="p">:</span> 
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> axis not shared by X (&quot;</span><span class="si">%s</span><span class="s1">&quot;) and Y (&quot;</span><span class="si">%s</span><span class="s1">&quot;)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">Y</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
      <span class="n">ri_new</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="n">oiaxes</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">riaxes</span> <span class="k">if</span> <span class="n">r</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ri_new</span><span class="p">])</span>
    <span class="n">riaxes</span> <span class="o">=</span> <span class="n">ri_new</span>

  <span class="n">oaxes</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">srcaxes</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">riaxes</span><span class="p">]</span>
  <span class="n">oview</span> <span class="o">=</span> <span class="n">View</span><span class="p">(</span><span class="n">oaxes</span><span class="p">)</span> 

  <span class="n">ixaxes</span> <span class="o">=</span> <span class="p">[</span><span class="n">X</span><span class="o">.</span><span class="n">whichaxis</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">axes</span> <span class="k">if</span> <span class="n">X</span><span class="o">.</span><span class="n">hasaxis</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
  <span class="n">iyaxes</span> <span class="o">=</span> <span class="p">[</span><span class="n">Y</span><span class="o">.</span><span class="n">whichaxis</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">axes</span> <span class="k">if</span> <span class="n">Y</span><span class="o">.</span><span class="n">hasaxis</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>

  <span class="n">Nx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">product</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ixaxes</span><span class="p">])</span>
  <span class="n">Ny</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">product</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">iyaxes</span><span class="p">])</span>
  <span class="k">assert</span> <span class="n">Nx</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> has only one element along the reduction axes&#39;</span> <span class="o">%</span> <span class="n">X</span><span class="o">.</span><span class="n">name</span>
  <span class="k">assert</span> <span class="n">Ny</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> has only one element along the reduction axes&#39;</span> <span class="o">%</span> <span class="n">Y</span><span class="o">.</span><span class="n">name</span>

  <span class="k">if</span> <span class="n">pbar</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">pygeode.progress</span> <span class="kn">import</span> <span class="n">PBar</span>
    <span class="n">pbar</span> <span class="o">=</span> <span class="n">PBar</span><span class="p">()</span>

  <span class="c1"># Construct work arrays</span>
  <span class="n">x</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">oview</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>
  <span class="n">y</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">oview</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>
  <span class="n">xx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">oview</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>
  <span class="n">yy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">oview</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>
  <span class="n">Nx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">oview</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>
  <span class="n">Ny</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">oview</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>

  <span class="c1"># Accumulate data</span>
  <span class="k">for</span> <span class="n">outsl</span><span class="p">,</span> <span class="p">(</span><span class="n">xdata</span><span class="p">,)</span> <span class="ow">in</span> <span class="n">loopover</span><span class="p">([</span><span class="n">X</span><span class="p">],</span> <span class="n">oview</span><span class="p">,</span> <span class="n">pbar</span><span class="o">=</span><span class="n">pbar</span><span class="p">):</span>
    <span class="n">xdata</span> <span class="o">=</span> <span class="n">xdata</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
    <span class="n">x</span><span class="p">[</span><span class="n">outsl</span><span class="p">]</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="n">outsl</span><span class="p">],</span>  <span class="n">npnansum</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="n">ixaxes</span><span class="p">)],</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">xx</span><span class="p">[</span><span class="n">outsl</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">([</span><span class="n">xx</span><span class="p">[</span><span class="n">outsl</span><span class="p">],</span> <span class="n">npnansum</span><span class="p">(</span><span class="n">xdata</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">ixaxes</span><span class="p">)],</span> <span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Count of non-NaN data points</span>
    <span class="n">Nx</span><span class="p">[</span><span class="n">outsl</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">([</span><span class="n">Nx</span><span class="p">[</span><span class="n">outsl</span><span class="p">],</span> <span class="n">npnansum</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">xdata</span><span class="p">),</span> <span class="n">ixaxes</span><span class="p">)],</span> <span class="mi">0</span><span class="p">)</span> 

  <span class="k">for</span> <span class="n">outsl</span><span class="p">,</span> <span class="p">(</span><span class="n">ydata</span><span class="p">,)</span> <span class="ow">in</span> <span class="n">loopover</span><span class="p">([</span><span class="n">Y</span><span class="p">],</span> <span class="n">oview</span><span class="p">,</span> <span class="n">pbar</span><span class="o">=</span><span class="n">pbar</span><span class="p">):</span>
    <span class="n">ydata</span> <span class="o">=</span> <span class="n">ydata</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
    <span class="n">y</span><span class="p">[</span><span class="n">outsl</span><span class="p">]</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">([</span><span class="n">y</span><span class="p">[</span><span class="n">outsl</span><span class="p">],</span>  <span class="n">npnansum</span><span class="p">(</span><span class="n">ydata</span><span class="p">,</span> <span class="n">iyaxes</span><span class="p">)],</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">yy</span><span class="p">[</span><span class="n">outsl</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">([</span><span class="n">yy</span><span class="p">[</span><span class="n">outsl</span><span class="p">],</span> <span class="n">npnansum</span><span class="p">(</span><span class="n">ydata</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">iyaxes</span><span class="p">)],</span> <span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Count of non-NaN data points</span>
    <span class="n">Ny</span><span class="p">[</span><span class="n">outsl</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">([</span><span class="n">Ny</span><span class="p">[</span><span class="n">outsl</span><span class="p">],</span> <span class="n">npnansum</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ydata</span><span class="p">),</span> <span class="n">iyaxes</span><span class="p">)],</span> <span class="mi">0</span><span class="p">)</span> 

  <span class="c1"># remove the mean (NOTE: numerically unstable if mean &gt;&gt; stdev)</span>
  <span class="n">imsk</span> <span class="o">=</span> <span class="p">(</span><span class="n">Nx</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">Ny</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
  <span class="n">xx</span><span class="p">[</span><span class="n">imsk</span><span class="p">]</span> <span class="o">-=</span> <span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">x</span><span class="p">)[</span><span class="n">imsk</span><span class="p">]</span> <span class="o">/</span> <span class="n">Nx</span><span class="p">[</span><span class="n">imsk</span><span class="p">]</span>
  <span class="n">xx</span><span class="p">[</span><span class="n">imsk</span><span class="p">]</span> <span class="o">/=</span> <span class="p">(</span><span class="n">Nx</span><span class="p">[</span><span class="n">imsk</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

  <span class="n">x</span><span class="p">[</span><span class="n">imsk</span><span class="p">]</span>  <span class="o">/=</span> <span class="n">Nx</span><span class="p">[</span><span class="n">imsk</span><span class="p">]</span>

  <span class="n">yy</span><span class="p">[</span><span class="n">imsk</span><span class="p">]</span> <span class="o">-=</span> <span class="p">(</span><span class="n">y</span><span class="o">*</span><span class="n">y</span><span class="p">)[</span><span class="n">imsk</span><span class="p">]</span> <span class="o">/</span> <span class="n">Ny</span><span class="p">[</span><span class="n">imsk</span><span class="p">]</span>
  <span class="n">yy</span><span class="p">[</span><span class="n">imsk</span><span class="p">]</span> <span class="o">/=</span> <span class="p">(</span><span class="n">Ny</span><span class="p">[</span><span class="n">imsk</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

  <span class="n">y</span><span class="p">[</span><span class="n">imsk</span><span class="p">]</span>  <span class="o">/=</span> <span class="n">Ny</span><span class="p">[</span><span class="n">imsk</span><span class="p">]</span>

  <span class="c1"># Ensure variances are non-negative</span>
  <span class="n">xx</span><span class="p">[</span><span class="n">xx</span> <span class="o">&lt;=</span> <span class="mf">0.</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
  <span class="n">yy</span><span class="p">[</span><span class="n">yy</span> <span class="o">&lt;=</span> <span class="mf">0.</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>

  <span class="k">if</span> <span class="n">Nx_fac</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">eNx</span> <span class="o">=</span> <span class="n">Nx</span><span class="o">//</span><span class="n">Nx_fac</span>
  <span class="k">else</span><span class="p">:</span> <span class="n">eNx</span> <span class="o">=</span> <span class="n">Nx</span>
  <span class="k">if</span> <span class="n">Ny_fac</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">eNy</span> <span class="o">=</span> <span class="n">Ny</span><span class="o">//</span><span class="n">Ny_fac</span>
  <span class="k">else</span><span class="p">:</span> <span class="n">eNy</span> <span class="o">=</span> <span class="n">Ny</span>

  <span class="n">emsk</span> <span class="o">=</span> <span class="p">(</span><span class="n">eNx</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">eNy</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>

  <span class="c1"># Compute difference</span>
  <span class="n">d</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">y</span>

  <span class="n">den</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">oview</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>
  <span class="n">df</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">oview</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>
  <span class="n">p</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">oview</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>
  <span class="n">ci</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">oview</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>

  <span class="c1"># Convert to variance of the mean of each sample</span>
  <span class="n">xx</span><span class="p">[</span><span class="n">emsk</span><span class="p">]</span> <span class="o">/=</span> <span class="n">eNx</span><span class="p">[</span><span class="n">emsk</span><span class="p">]</span>
  <span class="n">yy</span><span class="p">[</span><span class="n">emsk</span><span class="p">]</span> <span class="o">/=</span> <span class="n">eNy</span><span class="p">[</span><span class="n">emsk</span><span class="p">]</span>

  <span class="n">den</span><span class="p">[</span><span class="n">emsk</span><span class="p">]</span> <span class="o">=</span> <span class="n">xx</span><span class="p">[</span><span class="n">emsk</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="n">eNx</span><span class="p">[</span><span class="n">emsk</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">yy</span><span class="p">[</span><span class="n">emsk</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="n">eNy</span><span class="p">[</span><span class="n">emsk</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
  <span class="n">dmsk</span> <span class="o">=</span> <span class="p">(</span><span class="n">den</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">)</span>

  <span class="n">df</span><span class="p">[</span><span class="n">dmsk</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">xx</span><span class="p">[</span><span class="n">dmsk</span><span class="p">]</span> <span class="o">+</span> <span class="n">yy</span><span class="p">[</span><span class="n">dmsk</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">den</span><span class="p">[</span><span class="n">dmsk</span><span class="p">]</span>

  <span class="n">den</span><span class="p">[</span><span class="n">emsk</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">xx</span><span class="p">[</span><span class="n">emsk</span><span class="p">]</span> <span class="o">+</span> <span class="n">yy</span><span class="p">[</span><span class="n">emsk</span><span class="p">])</span>

  <span class="n">dmsk</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">den</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">)</span>

  <span class="n">p</span><span class="p">[</span><span class="n">dmsk</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">dmsk</span><span class="p">]</span><span class="o">/</span><span class="n">den</span><span class="p">[</span><span class="n">dmsk</span><span class="p">])</span>
  <span class="n">p</span><span class="p">[</span><span class="n">dmsk</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">tdist</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">dmsk</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="n">dmsk</span><span class="p">]))</span>

  <span class="n">ci</span><span class="p">[</span><span class="n">dmsk</span><span class="p">]</span> <span class="o">=</span> <span class="n">tdist</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">alpha</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="n">dmsk</span><span class="p">])</span> <span class="o">*</span> <span class="n">den</span><span class="p">[</span><span class="n">dmsk</span><span class="p">]</span>

  <span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="n">dmsk</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
  <span class="n">p</span> <span class="p">[</span><span class="o">~</span><span class="n">dmsk</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
  <span class="n">ci</span><span class="p">[</span><span class="o">~</span><span class="n">dmsk</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

  <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>

  <span class="c1"># Construct dataset to return</span>
  <span class="n">xn</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="n">X</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="s1">&#39;X&#39;</span>
  <span class="n">yn</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="n">Y</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="s1">&#39;Y&#39;</span>

  <span class="kn">from</span> <span class="nn">pygeode.var</span> <span class="kn">import</span> <span class="n">Var</span>
  <span class="kn">from</span> <span class="nn">pygeode.dataset</span> <span class="kn">import</span> <span class="n">asdataset</span>

  <span class="n">rvs</span> <span class="o">=</span> <span class="p">[]</span>

  <span class="k">if</span> <span class="s1">&#39;d&#39;</span> <span class="ow">in</span> <span class="n">output</span><span class="p">:</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">Var</span><span class="p">(</span><span class="n">oaxes</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="n">d</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>
    <span class="n">d</span><span class="o">.</span><span class="n">atts</span><span class="p">[</span><span class="s1">&#39;longname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Difference (</span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">xn</span><span class="p">,</span> <span class="n">yn</span><span class="p">)</span>
    <span class="n">rvs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

  <span class="k">if</span> <span class="s1">&#39;df&#39;</span> <span class="ow">in</span> <span class="n">output</span><span class="p">:</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">Var</span><span class="p">(</span><span class="n">oaxes</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="n">df</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;df&#39;</span><span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">atts</span><span class="p">[</span><span class="s1">&#39;longname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Degrees of freedom used for t-test&#39;</span>
    <span class="n">rvs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

  <span class="k">if</span> <span class="s1">&#39;p&#39;</span> <span class="ow">in</span> <span class="n">output</span><span class="p">:</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">Var</span><span class="p">(</span><span class="n">oaxes</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="n">p</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;p&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">atts</span><span class="p">[</span><span class="s1">&#39;longname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;p-value for t-test of difference (</span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">xn</span><span class="p">,</span> <span class="n">yn</span><span class="p">)</span>
    <span class="n">rvs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

  <span class="k">if</span> <span class="s1">&#39;ci&#39;</span> <span class="ow">in</span> <span class="n">output</span><span class="p">:</span>
    <span class="n">ci</span> <span class="o">=</span> <span class="n">Var</span><span class="p">(</span><span class="n">oaxes</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="n">ci</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;ci&#39;</span><span class="p">)</span>
    <span class="n">ci</span><span class="o">.</span><span class="n">atts</span><span class="p">[</span><span class="s1">&#39;longname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Confidence Interval (alpha = </span><span class="si">%.2f</span><span class="s1">) of difference (</span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">xn</span><span class="p">,</span> <span class="n">yn</span><span class="p">)</span>
    <span class="n">rvs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ci</span><span class="p">)</span>

  <span class="n">ds</span> <span class="o">=</span> <span class="n">asdataset</span><span class="p">(</span><span class="n">rvs</span><span class="p">)</span>
  <span class="n">ds</span><span class="o">.</span><span class="n">atts</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">alpha</span>
  <span class="n">ds</span><span class="o">.</span><span class="n">atts</span><span class="p">[</span><span class="s1">&#39;Nx_fac&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Nx_fac</span>
  <span class="n">ds</span><span class="o">.</span><span class="n">atts</span><span class="p">[</span><span class="s1">&#39;Ny_fac&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Ny_fac</span>
  <span class="n">ds</span><span class="o">.</span><span class="n">atts</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;t-test of difference (</span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">yn</span><span class="p">,</span> <span class="n">xn</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">ds</span></div>
<span class="c1"># }}}</span>

<div class="viewcode-block" id="paired_difference"><a class="viewcode-back" href="../../stats.html#pygeode.paired_difference">[docs]</a><span class="k">def</span> <span class="nf">paired_difference</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">N_fac</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="s1">&#39;d,p,ci&#39;</span><span class="p">,</span> <span class="n">pbar</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="c1"># {{{</span>
  <span class="sa">r</span><span class="sd">&#39;&#39;&#39;Computes the mean value and statistics of X - Y, assuming that individual elements</span>
<span class="sd">  of X and Y can be directly paired. In contrast to :func:`difference`, X and Y must have the same</span>
<span class="sd">  shape.</span>

<span class="sd">  Parameters</span>
<span class="sd">  ==========</span>
<span class="sd">  X, Y : :class:`Var`</span>
<span class="sd">    Variables to difference. Must share all axes over which the means are being computed.</span>

<span class="sd">  axes : list, optional</span>
<span class="sd">    Axes over which to compute means; if nothing is specified, the mean</span>
<span class="sd">    is computed over all axes common to X and Y.</span>

<span class="sd">  alpha : float</span>
<span class="sd">    Confidence level for which to compute confidence interval.</span>

<span class="sd">  N_fac : integer</span>
<span class="sd">    A factor by which to rescale the estimated number of degrees of freedom of</span>
<span class="sd">    X and Y; the effective number will be given by the number estimated from the</span>
<span class="sd">    dataset divided by ``N_fac``.</span>

<span class="sd">  output : string, optional</span>
<span class="sd">    A string determining which parameters are returned; see list of possible outputs</span>
<span class="sd">    in the Returns section. The specifications must be separated by a comma. Defaults </span>
<span class="sd">    to &#39;d,p,ci&#39;.</span>

<span class="sd">  pbar : progress bar, optional</span>
<span class="sd">    A progress bar object. If nothing is provided, a progress bar will be displayed</span>
<span class="sd">    if the calculation takes sufficiently long.</span>

<span class="sd">  Returns</span>
<span class="sd">  =======</span>
<span class="sd">  results : :class:`Dataset` </span>
<span class="sd">    The returned variables are specified by the ``output`` argument. The names</span>
<span class="sd">    of the variables match the output request string (i.e. if ``ds`` is the</span>
<span class="sd">    returned dataset, the average of the difference can be obtained by</span>
<span class="sd">    ``ds.d``). The following four quantities can be computed:</span>

<span class="sd">    * &#39;d&#39;: The difference in the means, X - Y</span>
<span class="sd">    * &#39;df&#39;: The effective number of degrees of freedom, :math:`df`</span>
<span class="sd">    * &#39;p&#39;: The p-value; see notes.</span>
<span class="sd">    * &#39;ci&#39;: The confidence interval of the difference at the level specified by ``alpha``</span>

<span class="sd">  See Also</span>
<span class="sd">  ========</span>
<span class="sd">  isnonzero</span>
<span class="sd">  difference</span>

<span class="sd">  Notes</span>
<span class="sd">  =====</span>
<span class="sd">  Following section 6.6.6 of von Storch and Zwiers 1999, a one-sample t test is used to test the</span>
<span class="sd">  hypothesis. The number of degrees of freedom is the sample size scaled by N_fac, less one. This</span>
<span class="sd">  provides a means of taking into account serial correlation in the data (see sections 6.6.7-9), but</span>
<span class="sd">  the appropriate number of effective degrees of freedom are not calculated explicitly by this</span>
<span class="sd">  routine. The p-value and confidence interval are computed based on the t-statistic in eq</span>
<span class="sd">  (6.21).&#39;&#39;&#39;</span>

  <span class="kn">from</span> <span class="nn">pygeode.tools</span> <span class="kn">import</span> <span class="n">loopover</span><span class="p">,</span> <span class="n">whichaxis</span><span class="p">,</span> <span class="n">combine_axes</span><span class="p">,</span> <span class="n">shared_axes</span><span class="p">,</span> <span class="n">npnansum</span>
  <span class="kn">from</span> <span class="nn">pygeode.view</span> <span class="kn">import</span> <span class="n">View</span>

  <span class="c1"># Split output request now</span>
  <span class="n">ovars</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="s1">&#39;df&#39;</span><span class="p">,</span> <span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="s1">&#39;ci&#39;</span><span class="p">]</span>
  <span class="n">output</span> <span class="o">=</span> <span class="p">[</span><span class="n">o</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">output</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">ovars</span><span class="p">]</span>
  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No valid outputs are requested from correlation. Possible outputs are </span><span class="si">%s</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">ovars</span><span class="p">))</span>

  <span class="n">srcaxes</span> <span class="o">=</span> <span class="n">combine_axes</span><span class="p">([</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">])</span>
  <span class="n">oiaxes</span><span class="p">,</span> <span class="n">riaxes</span> <span class="o">=</span> <span class="n">shared_axes</span><span class="p">(</span><span class="n">srcaxes</span><span class="p">,</span> <span class="p">[</span><span class="n">X</span><span class="o">.</span><span class="n">axes</span><span class="p">,</span> <span class="n">Y</span><span class="o">.</span><span class="n">axes</span><span class="p">])</span>
  <span class="k">if</span> <span class="n">axes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">ri_new</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">:</span>
      <span class="n">i</span> <span class="o">=</span> <span class="n">whichaxis</span><span class="p">(</span><span class="n">srcaxes</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">riaxes</span><span class="p">:</span> 
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> axis not shared by X (&quot;</span><span class="si">%s</span><span class="s1">&quot;) and Y (&quot;</span><span class="si">%s</span><span class="s1">&quot;)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">Y</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
      <span class="n">ri_new</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="n">oiaxes</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">riaxes</span> <span class="k">if</span> <span class="n">r</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ri_new</span><span class="p">])</span>
    <span class="n">riaxes</span> <span class="o">=</span> <span class="n">ri_new</span>

  <span class="n">oaxes</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">srcaxes</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">riaxes</span><span class="p">]</span>
  <span class="n">oview</span> <span class="o">=</span> <span class="n">View</span><span class="p">(</span><span class="n">oaxes</span><span class="p">)</span> 

  <span class="n">ixaxes</span> <span class="o">=</span> <span class="p">[</span><span class="n">X</span><span class="o">.</span><span class="n">whichaxis</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">axes</span> <span class="k">if</span> <span class="n">X</span><span class="o">.</span><span class="n">hasaxis</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
  <span class="n">Nx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">product</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ixaxes</span><span class="p">])</span>

  <span class="n">iyaxes</span> <span class="o">=</span> <span class="p">[</span><span class="n">Y</span><span class="o">.</span><span class="n">whichaxis</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">axes</span> <span class="k">if</span> <span class="n">Y</span><span class="o">.</span><span class="n">hasaxis</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
  <span class="n">Ny</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">product</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">iyaxes</span><span class="p">])</span>

  <span class="k">assert</span> <span class="n">ixaxes</span> <span class="o">==</span> <span class="n">iyaxes</span> <span class="ow">and</span> <span class="n">Nx</span> <span class="o">==</span> <span class="n">Ny</span><span class="p">,</span> <span class="s1">&#39;For the paired difference test, X and Y must have the same size along the reduction axes.&#39;</span>
  
  <span class="k">if</span> <span class="n">pbar</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">pygeode.progress</span> <span class="kn">import</span> <span class="n">PBar</span>
    <span class="n">pbar</span> <span class="o">=</span> <span class="n">PBar</span><span class="p">()</span>

  <span class="k">assert</span> <span class="n">Nx</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> has only one element along the reduction axes&#39;</span> <span class="o">%</span> <span class="n">X</span><span class="o">.</span><span class="n">name</span>
  <span class="k">assert</span> <span class="n">Ny</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> has only one element along the reduction axes&#39;</span> <span class="o">%</span> <span class="n">Y</span><span class="o">.</span><span class="n">name</span>

  <span class="c1"># Construct work arrays</span>
  <span class="n">d</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">oview</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>
  <span class="n">dd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">oview</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>
  <span class="n">N</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">oview</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>

  <span class="c1"># Accumulate data</span>
  <span class="k">for</span> <span class="n">outsl</span><span class="p">,</span> <span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="n">ydata</span><span class="p">)</span> <span class="ow">in</span> <span class="n">loopover</span><span class="p">([</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">],</span> <span class="n">oview</span><span class="p">,</span> <span class="n">inaxes</span><span class="o">=</span><span class="n">srcaxes</span><span class="p">,</span> <span class="n">pbar</span><span class="o">=</span><span class="n">pbar</span><span class="p">):</span>
    <span class="n">ddata</span> <span class="o">=</span> <span class="n">xdata</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="n">ydata</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
    <span class="n">d</span><span class="p">[</span><span class="n">outsl</span><span class="p">]</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">([</span><span class="n">d</span><span class="p">[</span><span class="n">outsl</span><span class="p">],</span>  <span class="n">npnansum</span><span class="p">(</span><span class="n">ddata</span><span class="p">,</span> <span class="n">ixaxes</span><span class="p">)],</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">dd</span><span class="p">[</span><span class="n">outsl</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">([</span><span class="n">dd</span><span class="p">[</span><span class="n">outsl</span><span class="p">],</span> <span class="n">npnansum</span><span class="p">(</span><span class="n">ddata</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">ixaxes</span><span class="p">)],</span> <span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Count of non-NaN data points</span>
    <span class="n">N</span><span class="p">[</span><span class="n">outsl</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">([</span><span class="n">N</span><span class="p">[</span><span class="n">outsl</span><span class="p">],</span> <span class="n">npnansum</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ddata</span><span class="p">),</span> <span class="n">ixaxes</span><span class="p">)],</span> <span class="mi">0</span><span class="p">)</span> 

  <span class="c1"># remove the mean (NOTE: numerically unstable if mean &gt;&gt; stdev)</span>
  <span class="n">imsk</span> <span class="o">=</span> <span class="p">(</span><span class="n">N</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
  <span class="n">dd</span><span class="p">[</span><span class="n">imsk</span><span class="p">]</span> <span class="o">-=</span> <span class="p">(</span><span class="n">d</span><span class="o">*</span><span class="n">d</span><span class="p">)[</span><span class="n">imsk</span><span class="p">]</span><span class="o">/</span><span class="n">N</span><span class="p">[</span><span class="n">imsk</span><span class="p">]</span>
  <span class="n">dd</span><span class="p">[</span><span class="n">imsk</span><span class="p">]</span> <span class="o">/=</span> <span class="p">(</span><span class="n">N</span><span class="p">[</span><span class="n">imsk</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
  <span class="n">d</span><span class="p">[</span><span class="n">imsk</span><span class="p">]</span>  <span class="o">/=</span> <span class="n">N</span><span class="p">[</span><span class="n">imsk</span><span class="p">]</span>

  <span class="c1"># Ensure variance is non-negative</span>
  <span class="n">dd</span><span class="p">[</span><span class="n">dd</span> <span class="o">&lt;=</span> <span class="mf">0.</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>

  <span class="k">if</span> <span class="n">N_fac</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">eN</span> <span class="o">=</span> <span class="n">N</span><span class="o">//</span><span class="n">N_fac</span>
  <span class="k">else</span><span class="p">:</span> <span class="n">eN</span> <span class="o">=</span> <span class="n">N</span>

  <span class="n">emsk</span> <span class="o">=</span> <span class="p">(</span><span class="n">eN</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>

  <span class="n">den</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">oview</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>
  <span class="n">p</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">oview</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>
  <span class="n">ci</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">oview</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>

  <span class="n">den</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">oview</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>
  <span class="n">den</span><span class="p">[</span><span class="n">emsk</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dd</span><span class="p">[</span><span class="n">emsk</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">eN</span><span class="p">[</span><span class="n">emsk</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
  <span class="n">dmsk</span> <span class="o">=</span> <span class="p">(</span><span class="n">den</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">)</span>

  <span class="n">p</span><span class="p">[</span><span class="n">dmsk</span><span class="p">]</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">dmsk</span><span class="p">]</span><span class="o">/</span><span class="n">den</span><span class="p">[</span><span class="n">dmsk</span><span class="p">])</span>
  <span class="n">p</span><span class="p">[</span><span class="n">dmsk</span><span class="p">]</span>  <span class="o">=</span> <span class="mf">2.</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">tdist</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">dmsk</span><span class="p">],</span> <span class="n">eN</span><span class="p">[</span><span class="n">dmsk</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
  <span class="n">ci</span><span class="p">[</span><span class="n">dmsk</span><span class="p">]</span> <span class="o">=</span> <span class="n">tdist</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">alpha</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">eN</span><span class="p">[</span><span class="n">dmsk</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">den</span><span class="p">[</span><span class="n">dmsk</span><span class="p">]</span>

  <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>

  <span class="c1"># Construct dataset to return</span>
  <span class="n">xn</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="n">X</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="s1">&#39;X&#39;</span>
  <span class="n">yn</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="n">Y</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="s1">&#39;Y&#39;</span>

  <span class="kn">from</span> <span class="nn">pygeode.var</span> <span class="kn">import</span> <span class="n">Var</span>
  <span class="kn">from</span> <span class="nn">pygeode.dataset</span> <span class="kn">import</span> <span class="n">asdataset</span>

  <span class="n">rvs</span> <span class="o">=</span> <span class="p">[]</span>

  <span class="k">if</span> <span class="s1">&#39;d&#39;</span> <span class="ow">in</span> <span class="n">output</span><span class="p">:</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">Var</span><span class="p">(</span><span class="n">oaxes</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="n">d</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>
    <span class="n">d</span><span class="o">.</span><span class="n">atts</span><span class="p">[</span><span class="s1">&#39;longname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Difference (</span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">xn</span><span class="p">,</span> <span class="n">yn</span><span class="p">)</span>
    <span class="n">rvs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

  <span class="k">if</span> <span class="s1">&#39;df&#39;</span> <span class="ow">in</span> <span class="n">output</span><span class="p">:</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">Var</span><span class="p">(</span><span class="n">oaxes</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="n">eN</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;df&#39;</span><span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">atts</span><span class="p">[</span><span class="s1">&#39;longname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Degrees of freedom used for t-test&#39;</span>
    <span class="n">rvs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

  <span class="k">if</span> <span class="s1">&#39;p&#39;</span> <span class="ow">in</span> <span class="n">output</span><span class="p">:</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">Var</span><span class="p">(</span><span class="n">oaxes</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="n">p</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;p&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">atts</span><span class="p">[</span><span class="s1">&#39;longname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;p-value for t-test of paired difference (</span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">xn</span><span class="p">,</span> <span class="n">yn</span><span class="p">)</span>
    <span class="n">rvs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

  <span class="k">if</span> <span class="s1">&#39;ci&#39;</span> <span class="ow">in</span> <span class="n">output</span><span class="p">:</span>
    <span class="n">ci</span> <span class="o">=</span> <span class="n">Var</span><span class="p">(</span><span class="n">oaxes</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="n">ci</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;ci&#39;</span><span class="p">)</span>
    <span class="n">ci</span><span class="o">.</span><span class="n">atts</span><span class="p">[</span><span class="s1">&#39;longname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Confidence Interval (alpha = </span><span class="si">%.2f</span><span class="s1">) of paired difference (</span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">xn</span><span class="p">,</span> <span class="n">yn</span><span class="p">)</span>
    <span class="n">rvs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ci</span><span class="p">)</span>

  <span class="n">ds</span> <span class="o">=</span> <span class="n">asdataset</span><span class="p">(</span><span class="n">rvs</span><span class="p">)</span>
  <span class="n">ds</span><span class="o">.</span><span class="n">atts</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">alpha</span>
  <span class="n">ds</span><span class="o">.</span><span class="n">atts</span><span class="p">[</span><span class="s1">&#39;N_fac&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">N_fac</span>
  <span class="n">ds</span><span class="o">.</span><span class="n">atts</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;t-test of paired difference (</span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">yn</span><span class="p">,</span> <span class="n">xn</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">ds</span></div>
<span class="c1"># }}}</span>

<div class="viewcode-block" id="isnonzero"><a class="viewcode-back" href="../../stats.html#pygeode.isnonzero">[docs]</a><span class="k">def</span> <span class="nf">isnonzero</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">N_fac</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="s1">&#39;m,p&#39;</span><span class="p">,</span> <span class="n">pbar</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="c1"># {{{</span>
  <span class="sa">r</span><span class="sd">&#39;&#39;&#39;Computes the mean value of X and statistics relevant for a test against</span>
<span class="sd">  the hypothesis that it is 0.</span>

<span class="sd">  Parameters</span>
<span class="sd">  ==========</span>
<span class="sd">  X : :class:`Var`</span>
<span class="sd">    Variable to average.</span>

<span class="sd">  axes : list, optional</span>
<span class="sd">    Axes over which to compute the mean; if nothing is specified, the mean is</span>
<span class="sd">    computed over all axes.</span>

<span class="sd">  alpha : float</span>
<span class="sd">    Confidence level for which to compute confidence interval.</span>

<span class="sd">  N_fac : integer</span>
<span class="sd">    A factor by which to rescale the estimated number of degrees of freedom;</span>
<span class="sd">    the effective number will be given by the number estimated from the dataset</span>
<span class="sd">    divided by ``N_fac``.</span>

<span class="sd">  output : string, optional</span>
<span class="sd">    A string determining which parameters are returned; see list of possible outputs</span>
<span class="sd">    in the Returns section. The specifications must be separated by a comma. Defaults </span>
<span class="sd">    to &#39;m,p&#39;.</span>

<span class="sd">  pbar : progress bar, optional</span>
<span class="sd">    A progress bar object. If nothing is provided, a progress bar will be displayed</span>
<span class="sd">    if the calculation takes sufficiently long.</span>

<span class="sd">  Returns</span>
<span class="sd">  =======</span>
<span class="sd">  results : :class:`Dataset` </span>
<span class="sd">    The names of the variables match the output request string (i.e. if ``ds``</span>
<span class="sd">    is the returned dataset, the mean value can be obtained through ``ds.m``).</span>
<span class="sd">    The following quantities can be calculated.</span>

<span class="sd">    * &#39;m&#39;: The mean value of X</span>
<span class="sd">    * &#39;p&#39;: The probability of the computed value if the population mean was zero</span>
<span class="sd">    * &#39;ci&#39;: The confidence interval of the mean at the level specified by alpha</span>

<span class="sd">    If the average is taken over all axes of X resulting in a scalar,</span>
<span class="sd">    the above values are returned as a tuple in the order given. If not, the</span>
<span class="sd">    results are provided as :class:`Var` objects in a dataset. </span>

<span class="sd">  See Also</span>
<span class="sd">  ========</span>
<span class="sd">  difference</span>

<span class="sd">  Notes</span>
<span class="sd">  =====</span>
<span class="sd">  The number of effective degrees of freedom can be scaled as in :meth:`difference`. </span>
<span class="sd">  The p-value and confidence interval are computed for the t-statistic defined in </span>
<span class="sd">  eq (6.61) of von Storch and Zwiers 1999.&#39;&#39;&#39;</span>

  <span class="kn">from</span> <span class="nn">pygeode.tools</span> <span class="kn">import</span> <span class="n">combine_axes</span><span class="p">,</span> <span class="n">whichaxis</span><span class="p">,</span> <span class="n">loopover</span><span class="p">,</span> <span class="n">npsum</span><span class="p">,</span> <span class="n">npnansum</span>
  <span class="kn">from</span> <span class="nn">pygeode.view</span> <span class="kn">import</span> <span class="n">View</span>

  <span class="n">riaxes</span> <span class="o">=</span> <span class="p">[</span><span class="n">X</span><span class="o">.</span><span class="n">whichaxis</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">]</span>
  <span class="n">raxes</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">axes</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">riaxes</span><span class="p">]</span>
  <span class="n">oaxes</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">axes</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">riaxes</span><span class="p">]</span>
  <span class="n">oview</span> <span class="o">=</span> <span class="n">View</span><span class="p">(</span><span class="n">oaxes</span><span class="p">)</span> 

  <span class="n">N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">product</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">riaxes</span><span class="p">])</span>

  <span class="k">if</span> <span class="n">pbar</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">pygeode.progress</span> <span class="kn">import</span> <span class="n">PBar</span>
    <span class="n">pbar</span> <span class="o">=</span> <span class="n">PBar</span><span class="p">()</span>

  <span class="k">assert</span> <span class="n">N</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> has only one element along the reduction axes&#39;</span> <span class="o">%</span> <span class="n">X</span><span class="o">.</span><span class="n">name</span>

  <span class="c1"># Construct work arrays</span>
  <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">oview</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>
  <span class="n">xx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">oview</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>
  <span class="n">Na</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">oview</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>

  <span class="n">x</span><span class="p">[()]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
  <span class="n">xx</span><span class="p">[()]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
  <span class="n">Na</span><span class="p">[()]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

  <span class="c1"># Accumulate data</span>
  <span class="k">for</span> <span class="n">outsl</span><span class="p">,</span> <span class="p">(</span><span class="n">xdata</span><span class="p">,)</span> <span class="ow">in</span> <span class="n">loopover</span><span class="p">([</span><span class="n">X</span><span class="p">],</span> <span class="n">oview</span><span class="p">,</span> <span class="n">pbar</span><span class="o">=</span><span class="n">pbar</span><span class="p">):</span>
    <span class="n">xdata</span> <span class="o">=</span> <span class="n">xdata</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
    <span class="n">x</span><span class="p">[</span><span class="n">outsl</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="n">outsl</span><span class="p">],</span> <span class="n">npnansum</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="n">riaxes</span><span class="p">)],</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">xx</span><span class="p">[</span><span class="n">outsl</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">([</span><span class="n">xx</span><span class="p">[</span><span class="n">outsl</span><span class="p">],</span> <span class="n">npnansum</span><span class="p">(</span><span class="n">xdata</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">riaxes</span><span class="p">)],</span> <span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Sum of weights (kludge to get masking right)</span>
    <span class="n">Na</span><span class="p">[</span><span class="n">outsl</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">([</span><span class="n">Na</span><span class="p">[</span><span class="n">outsl</span><span class="p">],</span> <span class="n">npnansum</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">xdata</span><span class="p">),</span> <span class="n">riaxes</span><span class="p">)],</span> <span class="mi">0</span><span class="p">)</span>

  <span class="n">imsk</span> <span class="o">=</span> <span class="p">(</span><span class="n">Na</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">)</span>

  <span class="c1"># remove the mean (NOTE: numerically unstable if mean &gt;&gt; stdev)</span>
  <span class="n">xx</span><span class="p">[</span><span class="n">imsk</span><span class="p">]</span> <span class="o">-=</span> <span class="n">x</span><span class="p">[</span><span class="n">imsk</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">Na</span><span class="p">[</span><span class="n">imsk</span><span class="p">]</span>
  <span class="n">xx</span><span class="p">[</span><span class="n">imsk</span><span class="p">]</span> <span class="o">=</span> <span class="n">xx</span><span class="p">[</span><span class="n">imsk</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">Na</span><span class="p">[</span><span class="n">imsk</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

  <span class="n">x</span><span class="p">[</span><span class="n">imsk</span><span class="p">]</span> <span class="o">/=</span> <span class="n">Na</span><span class="p">[</span><span class="n">imsk</span><span class="p">]</span>

  <span class="k">if</span> <span class="n">N_fac</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> 
    <span class="n">eN</span> <span class="o">=</span> <span class="n">N</span><span class="o">//</span><span class="n">N_fac</span>
    <span class="n">eNa</span> <span class="o">=</span> <span class="n">Na</span><span class="o">//</span><span class="n">N_fac</span>
  <span class="k">else</span><span class="p">:</span> 
    <span class="n">eN</span> <span class="o">=</span> <span class="n">N</span>
    <span class="n">eNa</span> <span class="o">=</span> <span class="n">Na</span>

  <span class="n">sdom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">oview</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>
  <span class="n">p</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">oview</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>
  <span class="n">t</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">oview</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>
  <span class="n">ci</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">oview</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>

  <span class="n">sdom</span><span class="p">[</span><span class="n">imsk</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">xx</span><span class="p">[</span><span class="n">imsk</span><span class="p">]</span> <span class="o">/</span> <span class="n">eNa</span><span class="p">[</span><span class="n">imsk</span><span class="p">])</span>
  <span class="n">dmsk</span> <span class="o">=</span> <span class="p">(</span><span class="n">sdom</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">)</span>

  <span class="n">t</span><span class="p">[</span><span class="n">dmsk</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">dmsk</span><span class="p">])</span> <span class="o">/</span> <span class="n">sdom</span><span class="p">[</span><span class="n">dmsk</span><span class="p">]</span>
  <span class="n">p</span><span class="p">[</span><span class="n">imsk</span><span class="p">]</span>  <span class="o">=</span> <span class="mf">2.</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">tdist</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">imsk</span><span class="p">],</span> <span class="n">eNa</span><span class="p">[</span><span class="n">imsk</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
  <span class="n">ci</span><span class="p">[</span><span class="n">imsk</span><span class="p">]</span> <span class="o">=</span> <span class="n">tdist</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">alpha</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">eNa</span><span class="p">[</span><span class="n">imsk</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">sdom</span><span class="p">[</span><span class="n">imsk</span><span class="p">]</span>

  <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>

  <span class="n">name</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="n">X</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="s1">&#39;X&#39;</span>

  <span class="kn">from</span> <span class="nn">pygeode.var</span> <span class="kn">import</span> <span class="n">Var</span>
  <span class="kn">from</span> <span class="nn">pygeode.dataset</span> <span class="kn">import</span> <span class="n">asdataset</span>

  <span class="n">rvs</span> <span class="o">=</span> <span class="p">[]</span>

  <span class="k">if</span> <span class="s1">&#39;m&#39;</span> <span class="ow">in</span> <span class="n">output</span><span class="p">:</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">Var</span><span class="p">(</span><span class="n">oaxes</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;m&#39;</span><span class="p">)</span>
    <span class="n">m</span><span class="o">.</span><span class="n">atts</span><span class="p">[</span><span class="s1">&#39;longname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Mean value of </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="p">)</span>
    <span class="n">rvs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

  <span class="k">if</span> <span class="s1">&#39;p&#39;</span> <span class="ow">in</span> <span class="n">output</span><span class="p">:</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">Var</span><span class="p">(</span><span class="n">oaxes</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="n">p</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;p&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">atts</span><span class="p">[</span><span class="s1">&#39;longname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;p-value of test </span><span class="si">%s</span><span class="s1"> is 0&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,)</span>
    <span class="n">rvs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

  <span class="k">if</span> <span class="s1">&#39;ci&#39;</span> <span class="ow">in</span> <span class="n">output</span><span class="p">:</span>
    <span class="n">ci</span> <span class="o">=</span> <span class="n">Var</span><span class="p">(</span><span class="n">oaxes</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="n">ci</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;ci&#39;</span><span class="p">)</span>
    <span class="n">ci</span><span class="o">.</span><span class="n">atts</span><span class="p">[</span><span class="s1">&#39;longname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Confidence intervale of the mean value of </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,)</span>
    <span class="n">rvs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ci</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">asdataset</span><span class="p">(</span><span class="n">rvs</span><span class="p">)</span></div>
<span class="c1"># }}}</span>
</pre></div>

      </div>
      <div class="bottomnav" role="navigation" aria-label="bottom navigation">
      
        <p>
        <a class="uplink" href="../../reference.html">Reference</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../../tutorial.html">Tutorial</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../../gallery/index.html">Gallery</a>
        </p>

      </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2018, Mike Neish, Peter Hitchcock.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.4.
    </div>
  </body>
</html>