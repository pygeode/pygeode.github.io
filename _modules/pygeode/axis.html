
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>pygeode.axis &#8212; PyGeode 1.4.0 documentation</title>
    <link rel="stylesheet" href="../../_static/pygtheme.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/gallery.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
<link href="http://fonts.googleapis.com/css?family=Ubuntu:300,300italic,regular,italic,500,500italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='http://fonts.googleapis.com/css?family=Ubuntu+Mono:400,700' rel='stylesheet' type='text/css'>

  </head><body>
      <div class="header" role="banner"><h1 class="heading"><a href="../../index.html">
          <span>PyGeode 1.4.0 documentation</span></a></h1>
        <h2 class="heading"><span>pygeode.axis</span></h2>
      </div>
      <div class="topnav" role="navigation" aria-label="top navigation">
      
        <p>
        <a class="uplink" href="../../reference.html">Reference</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../../tutorial.html">Tutorial</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../../gallery/index.html">Gallery</a>
        </p>

      </div>
      <div class="content">
        
        
  <h1>Source code for pygeode.axis</h1><div class="highlight"><pre>
<span></span><span class="c1">#TODO: remove the &#39;concat&#39; class method - put the code directly in the static &#39;concat&#39; method.  There are no longer any cases where Axis subclasses need to overload the merging logic.</span>
<span class="c1">#TODO: change the arguments for &#39;concat&#39; from axes to *axes</span>
<span class="c1">#TODO: remove NamedAxis class - mostly redundant</span>
<span class="c1">#TODO: make map_to a light wrapper for common_map, since the latter is a more powerful version of the method</span>

<span class="kn">from</span> <span class="nn">pygeode.var</span> <span class="kn">import</span> <span class="n">Var</span>

<span class="k">try</span><span class="p">:</span>
  <span class="kn">import</span> <span class="nn">pylab</span> <span class="k">as</span> <span class="nn">pyl</span>
  <span class="k">class</span> <span class="nc">AxisFormatter</span><span class="p">(</span><span class="n">pyl</span><span class="o">.</span><span class="n">Formatter</span><span class="p">):</span>
  <span class="c1"># {{{</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">unitstr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
      <span class="k">if</span> <span class="n">fmt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fmt</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">plotatts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;plotfmt&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fmt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">fmt</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">formatstr</span>
      <span class="k">if</span> <span class="n">unitstr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">unitstr</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">plotatts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;plotunits&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">unitstr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">unitstr</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">units</span>

      <span class="bp">self</span><span class="o">.</span><span class="n">fmt</span> <span class="o">=</span> <span class="n">fmt</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">unitstr</span> <span class="o">=</span> <span class="n">unitstr</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">showunits</span> <span class="o">=</span> <span class="n">units</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">pygaxis</span> <span class="o">=</span> <span class="n">axis</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pygaxis</span><span class="o">.</span><span class="n">formatvalue</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fmt</span><span class="p">,</span> <span class="n">unitstr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unitstr</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">showunits</span><span class="p">)</span>
  <span class="c1"># }}}</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
  <span class="kn">from</span> <span class="nn">warnings</span> <span class="kn">import</span> <span class="n">warn</span>
  <span class="n">warn</span> <span class="p">(</span><span class="s2">&quot;Matplotlib not available; plotting functionality will be absent.&quot;</span><span class="p">)</span>

<span class="c1"># Axis parent class</span>
<div class="viewcode-block" id="Axis"><a class="viewcode-back" href="../../axes.html#pygeode.Axis">[docs]</a><span class="k">class</span> <span class="nc">Axis</span><span class="p">(</span><span class="n">Var</span><span class="p">):</span>
<span class="c1"># {{{</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An object that describes a single dimension of a :class:`Var` object.</span>
<span class="sd">    It is a subclass of :class:`Var`, so it can be used anywhere a Var would be</span>
<span class="sd">    used.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    values : numpy.ndarray</span>
<span class="sd">      The coordinate values for each point along the axis.  Should be monotonic.</span>
<span class="sd">    name : string</span>
<span class="sd">      A name used to reference this axis.  Should be unique among the other</span>
<span class="sd">      axes of a variable.</span>
<span class="sd">    atts : dict</span>
<span class="sd">      Any additional metadata to associate with the axis.  The dictionary keys</span>
<span class="sd">      should be strings.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    :doc:`var`</span>

<span class="sd">  &quot;&quot;&quot;</span>

  <span class="c1"># Default dictionaries: these are class defaults and are overwritten by child class defaults</span>

  <span class="c1">#: Auxiliary arrays. These contain additionnal fields beyond the regular value array.</span>
  <span class="n">auxarrays</span> <span class="o">=</span> <span class="p">{}</span>

  <span class="c1">#: Auxiliary attributes. These are preserved during merge/slice/etc operations.</span>
  <span class="n">auxatts</span> <span class="o">=</span> <span class="p">{}</span>

  <span class="c1">#: Format specification for plotting values.</span>
  <span class="n">formatstr</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%g</span><span class="s1">&#39;</span>

  <span class="c1">#: Relative tolerance for identifying two values of this axis as equal</span>
  <span class="n">rtol</span> <span class="o">=</span> <span class="mf">1e-5</span>

  <span class="c1">#: Dictionary of attributes for plotting; see plotting documentation.</span>
  <span class="n">plotatts</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">plotatts</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<div class="viewcode-block" id="Axis.__init__"><a class="viewcode-back" href="../../axis.html#pygeode.Axis.__init__">[docs]</a>  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">atts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plotatts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="c1"># {{{</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a new Axis object with the given values.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    values : numpy.ndarray</span>
<span class="sd">        A one-dimensional coordinate defining the axis grid.</span>
<span class="sd">    name : string (optional)</span>
<span class="sd">        What to call the axis (i.e. for plot titles &amp; when saving to file)</span>
<span class="sd">    atts : dict (optional)</span>
<span class="sd">        Any additional metadata to associate with the axis. The dictionary</span>
<span class="sd">        keys should be strings.</span>
<span class="sd">    plotatts : dict (optional)</span>
<span class="sd">        Parameters that control plotting behaviour; default values are available.</span>
<span class="sd">        The dictionary keys should be strings.</span>
<span class="sd">    rtol : float</span>
<span class="sd">        A relative tolerance used for identifying an element of this axis.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    All subclasses of :class:`Axis` need to call this __init__ method within</span>
<span class="sd">    their own __init__, to properly initialize all attributes.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
    <span class="kn">from</span> <span class="nn">pygeode.var</span> <span class="kn">import</span> <span class="n">Var</span>

    <span class="c1"># If a single integer given, expand to an integer range</span>
    <span class="c1">#TODO: get rid of this?  if you want to use integer indices, then make an appropriate &#39;Index&#39; axis subclass?</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">values</span><span class="p">,</span><span class="nb">int</span><span class="p">):</span>
      <span class="n">values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">values</span><span class="p">))</span>

    <span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>

    <span class="c1"># Read configuration details</span>
    <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">_readaxisconfig</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="c1"># Note: Call init before hasattr (or don&#39;t use hasattr at all in here)</span>
    <span class="c1"># (__getattr__ is overridden to call getaxis, which assumes axes are defined, otherwise __getattr__ is called to find an &#39;axes&#39; property, ....)</span>
    <span class="n">Var</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="p">],</span> <span class="n">values</span><span class="o">=</span><span class="n">values</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">atts</span><span class="o">=</span><span class="n">atts</span><span class="p">,</span> <span class="n">plotatts</span><span class="o">=</span><span class="n">plotatts</span><span class="p">)</span>

    <span class="c1"># Compute size of spacing relative to magnitude for relative tolerances when mapping</span>
    <span class="k">if</span> <span class="n">rtol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">rtol</span> <span class="o">=</span> <span class="mf">1e-5</span>
      <span class="n">rtol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rtol</span>
      <span class="n">inz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">values</span> <span class="o">!=</span> <span class="mf">0.</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">inz</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">vnz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="n">inz</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
        <span class="n">logr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">vnz</span><span class="p">)</span> <span class="o">/</span> <span class="n">vnz</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span> <span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">logr</span><span class="p">)</span> <span class="ow">and</span> <span class="mi">10</span><span class="o">**</span><span class="n">logr</span> <span class="o">&lt;</span> <span class="n">rtol</span><span class="p">:</span> <span class="n">rtol</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="n">logr</span>

    <span class="c1">#: The relative tolerance for identifying an element of this axis.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">rtol</span> <span class="o">=</span> <span class="n">rtol</span>

    <span class="c1"># Add auxilliary arrays after calling Var.__init__ - the weights</span>
    <span class="c1"># array, if present, will be added here, not by the logic in Var.__init___</span>
    <span class="n">auxarrays</span> <span class="o">=</span> <span class="p">{};</span> <span class="n">auxatts</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
      <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span><span class="n">Var</span><span class="p">):</span> <span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
      <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,(</span><span class="nb">list</span><span class="p">,</span><span class="nb">tuple</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">val</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
          <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Auxilliary array </span><span class="si">%s</span><span class="s1"> has the wrong shape.  Expected </span><span class="si">%s</span><span class="s1">, got </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">val</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
        <span class="n">auxarrays</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">auxatts</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

    <span class="c1"># update auxiliary attribute (make copy to not change class defaults)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">auxarrays</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">auxarrays</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">auxarrays</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">auxarrays</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">auxatts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">auxatts</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">auxatts</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">auxatts</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span></div>
<span class="c1"># }}}</span>

  <span class="c1">#</span>
<div class="viewcode-block" id="Axis.isparentof"><a class="viewcode-back" href="../../axis.html#pygeode.Axis.isparentof">[docs]</a>  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">isparentof</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span><span class="n">other</span><span class="p">):</span>
  <span class="c1"># {{{</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determines if an axis object is an instance of a base class (or the same</span>
<span class="sd">    class) of another axis.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ==========</span>
<span class="sd">    other : :class:`Axis` object to compare against this one.</span>

<span class="sd">    Returns</span>
<span class="sd">    =======</span>
<span class="sd">    bool : boolean</span>
<span class="sd">      True if ``other`` is an instance of this object&#39;s class</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span><span class="bp">cls</span><span class="p">)</span></div>
  <span class="c1"># }}}</span>

  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">_readaxisconfig</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">ax</span><span class="p">):</span>
  <span class="c1"># {{{</span>
    <span class="kn">from</span> <span class="nn">pygeode</span> <span class="kn">import</span> <span class="n">_config</span>
    <span class="n">c</span> <span class="o">=</span> <span class="bp">cls</span>
    <span class="n">nm</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="vm">__name__</span>
    <span class="k">while</span> <span class="n">c</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">Axis</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">_config</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s1">&#39;Axes&#39;</span><span class="p">,</span>  <span class="n">nm</span> <span class="o">+</span> <span class="s1">&#39;.name&#39;</span><span class="p">):</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Axes&#39;</span><span class="p">,</span> <span class="n">nm</span> <span class="o">+</span> <span class="s1">&#39;.name&#39;</span><span class="p">))</span>
        <span class="k">break</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">nm</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="vm">__name__</span>

    <span class="k">if</span> <span class="n">c</span> <span class="ow">is</span> <span class="n">Axis</span><span class="p">:</span> <span class="n">ax</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="c1"># Set basic attributes</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;formatstr&#39;</span><span class="p">,</span> <span class="s1">&#39;units&#39;</span><span class="p">]:</span>
      <span class="k">if</span> <span class="n">_config</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s1">&#39;Axes&#39;</span><span class="p">,</span>  <span class="n">nm</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">p</span><span class="p">):</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Axes&#39;</span><span class="p">,</span> <span class="n">nm</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">p</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;rtol&#39;</span><span class="p">]:</span>
      <span class="k">if</span> <span class="n">_config</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s1">&#39;Axes&#39;</span><span class="p">,</span>  <span class="n">nm</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">p</span><span class="p">):</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">_config</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s1">&#39;Axes&#39;</span><span class="p">,</span> <span class="n">nm</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">p</span><span class="p">))</span>

    <span class="c1"># Set plot attributes</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;plottitle&#39;</span><span class="p">,</span> <span class="s1">&#39;plotfmt&#39;</span><span class="p">,</span> <span class="s1">&#39;plotscale&#39;</span><span class="p">]:</span>
      <span class="k">if</span> <span class="n">_config</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s1">&#39;Axes&#39;</span><span class="p">,</span>  <span class="n">nm</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">p</span><span class="p">):</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plotatts</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Axes&#39;</span><span class="p">,</span> <span class="n">nm</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">p</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;plotorder&#39;</span><span class="p">]:</span>
      <span class="k">if</span> <span class="n">_config</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s1">&#39;Axes&#39;</span><span class="p">,</span>  <span class="n">nm</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">p</span><span class="p">):</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plotatts</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">_config</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s1">&#39;Axes&#39;</span><span class="p">,</span> <span class="n">nm</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">p</span><span class="p">))</span>
  <span class="c1"># }}}</span>

  <span class="c1">#TODO: fix inconsistency between Axis and Var, for == and !=</span>
  <span class="c1">#      Vars produce a boolean mask under those operations, Axes return scalar True/False</span>
  <span class="c1"># I.e., &quot;lat == 30&quot; and &quot;(lat*1) == 30&quot; give very different results!</span>
  <span class="k">def</span> <span class="fm">__ne__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span> <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__eq__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
  <span class="k">def</span> <span class="fm">__eq__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
  <span class="c1"># {{{</span>
    <span class="sd">&#39;&#39;&#39;override Var&#39;s ufunc stuff here</span>
<span class="sd">       this is a weak comparison, in that we only require the other</span>
<span class="sd">       axis to be a *subclass* of this one.</span>
<span class="sd">       this allows things like &quot;lat in [time,gausslat,lev]&quot; to evaluate to True</span>
<span class="sd">       If you want a more strict comparison, then check the classes explicitly yourself.&#39;&#39;&#39;</span>

    <span class="c1">#TODO: do some testing to see just how many times this is called, if it will be a bottleneck for large axes</span>

<span class="c1">#    print &#39;&lt;&lt; Axis.__eq__ on&#39;, repr(self), &#39;and&#39;, repr(other), &#39;&gt;&gt;&#39;</span>

    <span class="c1"># exact same object?</span>
    <span class="k">if</span> <span class="bp">self</span> <span class="ow">is</span> <span class="n">other</span><span class="p">:</span> <span class="k">return</span> <span class="kc">True</span>
    <span class="c1"># incomparable?</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span><span class="n">Axis</span><span class="p">):</span>
<span class="c1">#      print &#39;not an axis?&#39;</span>
      <span class="k">return</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">isparentof</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">other</span><span class="o">.</span><span class="n">isparentof</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="c1">#      print &#39;parent issues&#39;</span>
      <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># If they are generic Axis objects, an additional requirement is that they have the same name</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">is</span> <span class="n">Axis</span> <span class="ow">and</span> <span class="n">other</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">is</span> <span class="n">Axis</span><span class="p">:</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># Check if they have the same lengths</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">values</span><span class="p">):</span>
<span class="c1">#      print &#39;false by length&#39;</span>
      <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># Check the values</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">allclose</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">allclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">values</span><span class="p">):</span>
<span class="c1">#      print &#39;values mismatch&#39;</span>
      <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># Check auxiliary attributes</span>
    <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">auxatts</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">!=</span> <span class="nb">set</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">auxatts</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span> <span class="k">return</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">auxatts</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">auxatts</span><span class="p">[</span><span class="n">fname</span><span class="p">]</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">auxatts</span><span class="p">[</span><span class="n">fname</span><span class="p">]:</span> <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># Check any associated arrays</span>
    <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">auxarrays</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">!=</span> <span class="nb">set</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">auxarrays</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
<span class="c1">#      print &#39;false by mismatched set of auxarrays&#39;</span>
      <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># Check values of associated arrays</span>
    <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">auxarrays</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">allclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">auxarrays</span><span class="p">[</span><span class="n">fname</span><span class="p">],</span> <span class="n">other</span><span class="o">.</span><span class="n">auxarrays</span><span class="p">[</span><span class="n">fname</span><span class="p">]):</span>
<span class="c1">#        print &#39;false by mismatched auxarray &quot;%s&quot;:&#39;%fname</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="kc">True</span>

  <span class="c1"># }}}</span>

  <span class="k">def</span> <span class="nf">alleq</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">others</span><span class="p">):</span>
  <span class="c1"># {{{</span>
    <span class="sd">&#39;&#39;&#39; alleq(self, *others) - returns True if self matches with all axes in others.&#39;&#39;&#39;</span>
    <span class="k">for</span> <span class="n">other</span> <span class="ow">in</span> <span class="n">others</span><span class="p">:</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__eq__</span><span class="p">(</span><span class="n">other</span><span class="p">):</span> <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="kc">True</span>
  <span class="c1"># }}}</span>

  <span class="c1">#TODO: include associated arrays when doing the mapping?</span>
<div class="viewcode-block" id="Axis.map_to"><a class="viewcode-back" href="../../axis.html#pygeode.Axis.map_to">[docs]</a>  <span class="k">def</span> <span class="nf">map_to</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
  <span class="c1"># {{{</span>
    <span class="sd">&#39;&#39;&#39;Returns indices of this axis which correspond to the axis ``other``.</span>

<span class="sd">       Parameters</span>
<span class="sd">       ----------</span>
<span class="sd">       other : :class:`Axis`</span>
<span class="sd">         Axis to find mapping to</span>

<span class="sd">       Returns</span>
<span class="sd">       -------</span>
<span class="sd">       mapping : integer array or None</span>

<span class="sd">       Notes</span>
<span class="sd">       -----</span>

<span class="sd">       Returns an ordered indices of the elements of this axis that correspond to those of</span>
<span class="sd">       the axis ``other``, if one exists, otherwise None. This axis must be a</span>
<span class="sd">       parent class of ``other`` or vice versa in order for the mapping to</span>
<span class="sd">       exist. The mapping may include only a subset of this axis object, but</span>
<span class="sd">       must be as long as the other axis, if it is not None. The mapping</span>
<span class="sd">       identifies equivalent elements based on equality up to a tolerance</span>
<span class="sd">       specified by self.rtol.</span>
<span class="sd">       &#39;&#39;&#39;</span>

    <span class="kn">from</span> <span class="nn">pygeode.tools</span> <span class="kn">import</span> <span class="n">map_to</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">isparentof</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">other</span><span class="o">.</span><span class="n">isparentof</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># special case: both axes are identical</span>
    <span class="k">if</span> <span class="bp">self</span> <span class="o">==</span> <span class="n">other</span><span class="p">:</span> <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

    <span class="c1"># Use less conservative tolerance?</span>
    <span class="c1">#rtol = max(self.auxatts.get(&#39;rtol&#39;, 1e-5), other.auxatts.get(&#39;rtol&#39;, 1e-5))</span>

    <span class="k">return</span> <span class="n">map_to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rtol</span><span class="p">)</span></div>
  <span class="c1"># }}}</span>

<div class="viewcode-block" id="Axis.sorted"><a class="viewcode-back" href="../../axis.html#pygeode.Axis.sorted">[docs]</a>  <span class="k">def</span> <span class="nf">sorted</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="c1"># {{{</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sorts the points of the Axis.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    reverse : boolean (optional)</span>
<span class="sd">      If ``True``, sorts in descending order. If ``False``, sorts in ascending order.</span>
<span class="sd">      By default the sign of self.plotorder is used.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    sorted_axis : Axis</span>
<span class="sd">      A sorted version of the input axis.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; from pygeode import Lat</span>
<span class="sd">    &gt;&gt;&gt; x = Lat([30,20,10])</span>
<span class="sd">    &gt;&gt;&gt; print(x)</span>
<span class="sd">    lat &lt;Lat&gt;      :  30 N to 10 N (3 values)</span>
<span class="sd">    &gt;&gt;&gt; y = x.sorted()</span>
<span class="sd">    &gt;&gt;&gt; print(y)</span>
<span class="sd">    lat &lt;Lat&gt;      :  10 N to 30 N (3 values)</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    argsort</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">S</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="n">reverse</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice</span><span class="p">[</span><span class="n">S</span><span class="p">]</span></div>
<span class="c1"># }}}</span>

<div class="viewcode-block" id="Axis.argsort"><a class="viewcode-back" href="../../axis.html#pygeode.Axis.argsort">[docs]</a>  <span class="k">def</span> <span class="nf">argsort</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="c1"># {{{</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Generates a list of indices that would sort the Axis.</span>

<span class="sd">      Parameters</span>
<span class="sd">      ----------</span>
<span class="sd">      reverse : boolean (optional)</span>
<span class="sd">        If ``False``, indices are in ascending order. If ``True``, will produce</span>
<span class="sd">        indices for a *reverse* sort instead. By default, sign of self.plotorder is used.</span>

<span class="sd">      Returns</span>
<span class="sd">      -------</span>
<span class="sd">      indices : list</span>
<span class="sd">        The indices which will produces a sorted version of the Axis.</span>

<span class="sd">      Examples</span>
<span class="sd">      --------</span>
<span class="sd">      &gt;&gt;&gt; from pygeode import Lat</span>
<span class="sd">      &gt;&gt;&gt; x = Lat([20,30,10])</span>
<span class="sd">      &gt;&gt;&gt; print(x)</span>
<span class="sd">      lat &lt;Lat&gt;      :  20 N to 10 N (3 values)</span>
<span class="sd">      &gt;&gt;&gt; indices = x.argsort()</span>
<span class="sd">      &gt;&gt;&gt; print(indices)</span>
<span class="sd">      [2 0 1]</span>
<span class="sd">      &gt;&gt;&gt; print(x.slice[indices])</span>
<span class="sd">      lat &lt;Lat&gt;      :  10 N to 30 N (3 values)</span>


<span class="sd">      See Also</span>
<span class="sd">      --------</span>
<span class="sd">      sorted</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
    <span class="n">S</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="n">step</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">reverse</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plotatts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;plotorder&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">reverse</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span> <span class="n">step</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">return</span> <span class="n">S</span><span class="p">[::</span><span class="n">step</span><span class="p">]</span></div>
<span class="c1"># }}}</span>

  <span class="c1">#TODO: implement and test this (if it&#39;s ever needed?)</span>
  <span class="c1"># (make sure to check auxiliary arrays)</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  def common_map (self, other):</span>
<span class="sd">    &#39;&#39;&#39;return the indices that map common elements from one axis to another&#39;&#39;&#39;</span>
<span class="sd">    from pygeode.tools import common_map</span>
<span class="sd">    assert self.isparentof(other) or other.isparentof(self)</span>
<span class="sd">    return common_map(self.values, other.values)</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="c1"># The length of an axis (equal to the length of the array of values)</span>
  <span class="k">def</span> <span class="fm">__len__</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  # Avoid accidentally iterating over axes</span>
<span class="sd">  # (Would cause a new, 1-element axis to be created for each iteration)</span>
<span class="sd">  def __iter__ (self):</span>
<span class="sd">    raise Exception (&quot;Axes cannot be iterated over&quot;)</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="c1"># Iterating over an axis iterates over the values</span>
  <span class="k">def</span> <span class="fm">__iter__</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

  <span class="c1"># Slice an axis -&gt; construct a new one with the sliced values</span>
  <span class="c1"># (Overridden from Var to preserve our Axis status)</span>
<div class="viewcode-block" id="Axis._getitem_asvar"><a class="viewcode-back" href="../../axis.html#pygeode.Axis._getitem_asvar">[docs]</a>  <span class="k">def</span> <span class="nf">_getitem_asvar</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slices</span><span class="p">):</span>
  <span class="c1"># {{{</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

    <span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">slices</span><span class="p">],</span> <span class="n">ndmin</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Check if we even need to do any slicing</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">values</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span>

    <span class="n">aux</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Keep auxiliary attributes</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">auxatts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
      <span class="n">aux</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

    <span class="c1"># Slice auxiliary arrays</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">auxarrays</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
      <span class="n">aux</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="n">slices</span><span class="p">],</span> <span class="n">ndmin</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">axis</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)(</span><span class="n">values</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">atts</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">atts</span><span class="p">,</span> <span class="o">**</span><span class="n">aux</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">axis</span></div>
  <span class="c1"># }}}</span>

<div class="viewcode-block" id="Axis.str_as_val"><a class="viewcode-back" href="../../axis.html#pygeode.Axis.str_as_val">[docs]</a>  <span class="k">def</span> <span class="nf">str_as_val</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
<span class="c1"># {{{</span>
    <span class="sd">&#39;&#39;&#39;str_as_val(self, key, s) - converts string s to a value corresponding to this axis. Default</span>
<span class="sd">        implementation returns float(s); derived classes can return different conversions depending</span>
<span class="sd">        on whether key corresponds to the axis itself or an auxiliary array.&#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">s</span><span class="p">)</span></div>
<span class="c1"># }}}</span>

  <span class="k">def</span> <span class="nf">get_slice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">ignore_mismatch</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="c1"># {{{</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
    <span class="kn">from</span> <span class="nn">pygeode.view</span> <span class="kn">import</span> <span class="n">simplify</span><span class="p">,</span> <span class="n">expand</span>

    <span class="c1"># boolean flags indicating which axis indices will be used</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="n">keep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="nb">bool</span><span class="p">)</span>
    <span class="n">matched</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
       <span class="c1"># Split off prefix if present</span>
      <span class="k">if</span> <span class="s1">&#39;_&#39;</span> <span class="ow">in</span> <span class="n">k</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_alias</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
        <span class="n">prefix</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">prefix</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">k</span>

      <span class="k">if</span> <span class="s1">&#39;i&#39;</span> <span class="ow">in</span> <span class="n">prefix</span><span class="p">:</span>
        <span class="c1">################### Select by index; key must correspond to this axis</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_alias</span><span class="p">(</span><span class="n">ax</span><span class="p">):</span>
          <span class="k">if</span> <span class="n">ignore_mismatch</span><span class="p">:</span> <span class="k">continue</span>
          <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39; is not associated with this </span><span class="si">%s</span><span class="s2"> axis&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

        <span class="c1"># Build mask</span>
        <span class="n">kp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="s1">&#39;__len__&#39;</span><span class="p">):</span> <span class="c1"># Treat as an index</span>
          <span class="n">kp</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="ow">or</span> <span class="s1">&#39;l&#39;</span> <span class="ow">in</span> <span class="n">prefix</span><span class="p">:</span> <span class="c1"># Treat as integer array</span>
          <span class="n">kp</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="s1">&#39;int&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>         <span class="c1"># Treat as slice</span>
          <span class="n">kp</span><span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>         <span class="c1"># Treat as slice with stride</span>
          <span class="n">kp</span><span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span><span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="k">raise</span> <span class="n">ValueException</span><span class="p">(</span><span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39; is not associated with this </span><span class="si">%s</span><span class="s2"> axis&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="c1">################### Select by value</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_alias</span><span class="p">(</span><span class="n">ax</span><span class="p">):</span>     <span class="c1"># Does key match this axis?</span>
          <span class="n">vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span>
        <span class="k">elif</span> <span class="n">ax</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">auxarrays</span><span class="p">:</span> <span class="c1"># What about an aux. array?</span>
          <span class="n">vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auxarrays</span><span class="p">[</span><span class="n">ax</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="k">if</span> <span class="n">ignore_mismatch</span><span class="p">:</span> <span class="k">continue</span>
          <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39; is not associated with this </span><span class="si">%s</span><span class="s2"> axis&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

        <span class="c1"># Build mask</span>
        <span class="n">kp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span>
        <span class="c1"># Convert string representation if necessary</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span> <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">str_as_val</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="s1">&#39;__len__&#39;</span><span class="p">):</span> <span class="c1"># Single value given</span>
          <span class="k">if</span> <span class="n">vals</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">):</span> <span class="c1"># closest match</span>
            <span class="n">kp</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">v</span><span class="o">-</span><span class="n">vals</span><span class="p">)</span> <span class="p">)]</span> <span class="o">=</span> <span class="kc">True</span>
          <span class="k">else</span><span class="p">:</span>                 <span class="c1"># otherwise require an exact match</span>
            <span class="n">kp</span><span class="p">[</span><span class="n">vals</span> <span class="o">==</span> <span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">elif</span> <span class="s1">&#39;l&#39;</span> <span class="ow">in</span> <span class="n">prefix</span><span class="p">:</span>
          <span class="k">for</span> <span class="n">V</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
            <span class="c1"># Convert string representation if necessary</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span> <span class="n">V</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">str_as_val</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">V</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">vals</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">):</span> <span class="c1"># closest match</span>
              <span class="n">kp</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">V</span><span class="o">-</span><span class="n">vals</span><span class="p">)</span> <span class="p">)]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>                 <span class="c1"># otherwise require an exact match</span>
              <span class="n">kp</span><span class="p">[</span><span class="n">vals</span> <span class="o">==</span> <span class="n">V</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>       <span class="c1"># Select within range</span>
          <span class="c1"># Convert string representations if necessary</span>
          <span class="n">v</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">str_as_val</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">V</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">V</span> <span class="k">for</span> <span class="n">V</span> <span class="ow">in</span> <span class="n">v</span><span class="p">]</span>
          <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">v</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
          <span class="n">kp</span><span class="p">[(</span><span class="n">lower</span> <span class="o">&lt;=</span> <span class="n">vals</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">vals</span> <span class="o">&lt;=</span> <span class="n">upper</span><span class="p">)]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">else</span><span class="p">:</span>                   <span class="c1"># Don&#39;t know what to do with more than 2 values</span>
          <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;A range must be specified&#39;</span><span class="p">)</span>

      <span class="c1"># Use complement of requested set</span>
      <span class="k">if</span> <span class="s1">&#39;n&#39;</span> <span class="ow">in</span> <span class="n">prefix</span><span class="p">:</span> <span class="n">kp</span> <span class="o">=</span> <span class="o">~</span><span class="n">kp</span>

      <span class="c1"># Compute intersection of index sets</span>
      <span class="n">keep</span> <span class="o">&amp;=</span> <span class="n">kp</span>
      <span class="n">matched</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>       <span class="c1"># Mark for removal from slice list</span>

    <span class="c1"># Pop kw arguments that have been handled</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">matched</span><span class="p">:</span>
      <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

    <span class="c1"># Convert boolean mask to integer indices</span>
    <span class="n">sl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="n">keep</span><span class="p">)</span>

    <span class="c1"># Filter through view.simplify() to construct slice objects wherever possible</span>
    <span class="c1"># (otherwise, it&#39;s a generic integer array)</span>
    <span class="k">return</span> <span class="n">simplify</span><span class="p">(</span><span class="n">sl</span><span class="p">)</span>
<span class="c1"># }}}</span>

  <span class="c1"># Keyword/value based slicing of an axis</span>
  <span class="c1"># (Overridden from Var to preserve our Axis status)</span>
<div class="viewcode-block" id="Axis.__call__"><a class="viewcode-back" href="../../axis.html#pygeode.Axis.__call__">[docs]</a>  <span class="k">def</span> <span class="fm">__call__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="c1"># {{{</span>
    <span class="n">sl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_slice</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getitem_asvar</span><span class="p">(</span><span class="n">sl</span><span class="p">)</span></div>
<span class="c1"># }}}</span>

  <span class="c1"># Get an axis attribute</span>
  <span class="c1"># Overloaded from pygeode.Var to allow shortcuts to auxiliary arrays</span>
  <span class="k">def</span> <span class="fm">__getattr__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
<span class="c1"># {{{</span>
    <span class="c1"># Disregard metaclass stuff</span>
    <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;__&#39;</span><span class="p">):</span> <span class="k">raise</span> <span class="ne">AttributeError</span>

<span class="c1">#    print &#39;axis getattr ??&#39;, name</span>
    <span class="kn">from</span> <span class="nn">pygeode.var</span> <span class="kn">import</span> <span class="n">Var</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">auxarrays</span><span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">auxarrays</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">auxatts</span><span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">auxatts</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">Var</span><span class="o">.</span><span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
<span class="c1"># }}}</span>

<div class="viewcode-block" id="Axis.auxasvar"><a class="viewcode-back" href="../../axis.html#pygeode.Axis.auxasvar">[docs]</a>  <span class="k">def</span> <span class="nf">auxasvar</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
<span class="c1"># {{{</span>
    <span class="sd">&#39;&#39;&#39; Returns auxiliary array as a new :class:`Var` object.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ==========</span>
<span class="sd">        name : string</span>
<span class="sd">            Name of auxiliary array to return</span>

<span class="sd">        Returns</span>
<span class="sd">        =======</span>
<span class="sd">        var : :class:`Var`</span>
<span class="sd">            Variable with values of requested auxilliary array</span>

<span class="sd">        See Also</span>
<span class="sd">        ========</span>
<span class="sd">        auxarrays</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="kn">from</span> <span class="nn">pygeode.var</span> <span class="kn">import</span> <span class="n">Var</span>
    <span class="k">return</span> <span class="n">Var</span><span class="p">([</span><span class="bp">self</span><span class="p">],</span> <span class="n">values</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">auxarrays</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span></div>
<span class="c1"># }}}</span>

  <span class="c1"># Pretty printing</span>
  <span class="k">def</span> <span class="fm">__repr__</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="s1">&#39;&lt;&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="s1">&#39;&gt;&#39;</span>

  <span class="k">def</span> <span class="fm">__str__</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>
  <span class="c1"># {{{</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
      <span class="n">first</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">formatvalue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
      <span class="n">last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">formatvalue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span> <span class="n">first</span> <span class="o">=</span> <span class="n">last</span> <span class="o">=</span> <span class="s2">&quot;&lt;empty&gt;&quot;</span>
    <span class="n">num</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span> <span class="n">head</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> <span class="n">head</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
      <span class="n">out</span> <span class="o">=</span> <span class="n">head</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;:  &#39;</span><span class="o">+</span><span class="n">first</span><span class="o">+</span><span class="s1">&#39; to &#39;</span><span class="o">+</span><span class="n">last</span><span class="o">+</span><span class="s1">&#39; (&#39;</span><span class="o">+</span><span class="n">num</span><span class="o">+</span><span class="s1">&#39; values)&#39;</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">out</span> <span class="o">=</span> <span class="n">head</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;:  &#39;</span><span class="o">+</span><span class="n">first</span>

<span class="c1">#    return out+&quot;\n&quot;</span>
    <span class="k">return</span> <span class="n">out</span>
  <span class="c1"># }}}</span>

  <span class="c1"># Rename an axis</span>
<div class="viewcode-block" id="Axis.rename"><a class="viewcode-back" href="../../axis.html#pygeode.Axis.rename">[docs]</a>  <span class="k">def</span> <span class="nf">rename</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
<span class="c1"># {{{</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Assigns a new name to this axis.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    name : string</span>
<span class="sd">      The new name of this axis.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    renamed_axis : Axis</span>
<span class="sd">      An instance of the same axis class with the new name.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">aux</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">auxatts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span> <span class="n">aux</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">auxarrays</span><span class="o">.</span><span class="n">items</span><span class="p">():</span> <span class="n">aux</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

    <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)(</span><span class="n">values</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">atts</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">atts</span><span class="p">,</span> <span class="o">**</span><span class="n">aux</span><span class="p">)</span></div>
<span class="c1"># }}}</span>

  <span class="c1"># Check if a given string is a meaningful alias to the axis</span>
  <span class="c1"># (i.e., if the string matches the name, or the class name, or one of the base class names)</span>
<div class="viewcode-block" id="Axis.class_has_alias"><a class="viewcode-back" href="../../axis.html#pygeode.Axis.class_has_alias">[docs]</a>  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">class_has_alias</span> <span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
  <span class="c1"># {{{</span>
<span class="c1">#    if cls is Axis: return False  # need a uniquely identifiable subclass of Axis</span>
    <span class="c1"># Default string name for the class</span>
    <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span> <span class="k">return</span> <span class="kc">True</span>
    <span class="c1"># A stringified version of the class name (i.e. Time =&gt; &#39;time&#39;)</span>
    <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span> <span class="k">return</span> <span class="kc">True</span>
    <span class="k">for</span> <span class="n">subclass</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">:</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">subclass</span><span class="p">,</span><span class="n">Axis</span><span class="p">):</span> <span class="k">continue</span>  <span class="c1"># only iterate over Axis subclasses</span>
      <span class="k">if</span> <span class="n">subclass</span><span class="o">.</span><span class="n">class_has_alias</span><span class="p">(</span><span class="n">name</span><span class="p">):</span> <span class="k">return</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="kc">False</span></div>
  <span class="c1"># }}}</span>

  <span class="c1"># Now, a function which can work on instances of a class</span>
  <span class="c1"># Extends the above to also check the name given to the particular instance</span>
  <span class="c1"># (which can depend on the source of the data loaded at runtime)</span>
  <span class="k">def</span> <span class="nf">has_alias</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
  <span class="c1"># {{{</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span> <span class="k">return</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_has_alias</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
  <span class="c1"># }}}</span>

  <span class="c1"># Concatenate multiple axes together</span>
  <span class="c1"># Use numpy arrays</span>
  <span class="c1"># Assume the segments are pre-sorted</span>
  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">concat</span> <span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">axes</span><span class="p">):</span>
  <span class="c1"># {{{</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">concatenate</span>
    <span class="kn">from</span> <span class="nn">pygeode.tools</span> <span class="kn">import</span> <span class="n">common_dict</span>
    <span class="c1"># Must all be same type of axis</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">:</span> <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="bp">cls</span><span class="p">),</span> <span class="s1">&#39;axes must be the same type&#39;</span>

    <span class="n">values</span> <span class="o">=</span> <span class="n">concatenate</span><span class="p">([</span><span class="n">a</span><span class="o">.</span><span class="n">values</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">])</span>

    <span class="c1"># Get common attributes</span>
    <span class="n">atts</span> <span class="o">=</span> <span class="n">common_dict</span><span class="p">([</span><span class="n">a</span><span class="o">.</span><span class="n">atts</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">])</span>

    <span class="n">aux</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Check that all pieces have the same auxiliary attributes, and propogate them to the output.</span>
    <span class="n">auxkeys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">auxatts</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
      <span class="n">auxkeys</span> <span class="o">=</span> <span class="n">auxkeys</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">auxatts</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">auxkeys</span><span class="p">:</span>
      <span class="n">vals</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">auxatts</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">]</span>
      <span class="n">v1</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="c1">#      assert all(v == v1 for v in vals), &quot;inconsistent &#39;%s&#39; attribute&quot;%k</span>
      <span class="c1"># Only use consistent aux atts</span>
      <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">v</span> <span class="o">==</span> <span class="n">v1</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vals</span><span class="p">):</span>
        <span class="n">aux</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">auxatts</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>


    <span class="c1"># Find and concatenate auxilliary arrays common to all axes being concatenated</span>
    <span class="n">auxkeys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">auxarrays</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>      <span class="c1"># set.intersection takes multiple arguments only in python 2.6 and later..</span>
      <span class="n">auxkeys</span> <span class="o">=</span> <span class="n">auxkeys</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">auxarrays</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>

    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">auxkeys</span><span class="p">:</span>
      <span class="n">aux</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">concatenate</span><span class="p">([</span><span class="n">a</span><span class="o">.</span><span class="n">auxarrays</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">])</span>

    <span class="n">name</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>  <span class="c1">#TODO: check all names?</span>

    <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">atts</span><span class="o">=</span><span class="n">atts</span><span class="p">,</span> <span class="o">**</span><span class="n">aux</span><span class="p">)</span>
  <span class="c1"># }}}</span>

  <span class="c1"># Replace the values of an axis</span>
  <span class="c1"># (any auxiliary arrays from the old axis are ignored)</span>
  <span class="k">def</span> <span class="nf">withnewvalues</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
  <span class="c1"># {{{</span>
    <span class="c1"># Assume any auxiliary scalars are the same for the new axis</span>
    <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)(</span><span class="n">values</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">atts</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">atts</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">auxatts</span><span class="p">)</span></div>
  <span class="c1"># }}}</span>
<span class="c1"># }}}</span>


<span class="c1"># Useful axis subclasses</span>

<span class="c1"># Named axis</span>
<div class="viewcode-block" id="NamedAxis"><a class="viewcode-back" href="../../namedaxis.html#pygeode.NamedAxis">[docs]</a><span class="k">class</span> <span class="nc">NamedAxis</span> <span class="p">(</span><span class="n">Axis</span><span class="p">):</span>
<span class="c1"># {{{</span>
  <span class="sd">&#39;&#39;&#39;Generic axis object identified by its name.&#39;&#39;&#39;</span>

<div class="viewcode-block" id="NamedAxis.__init__"><a class="viewcode-back" href="../../namedaxis.html#pygeode.NamedAxis.__init__">[docs]</a>  <span class="k">def</span> <span class="fm">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
  <span class="c1"># {{{</span>
    <span class="n">Axis</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span></div>
  <span class="c1"># }}}</span>

  <span class="k">def</span> <span class="fm">__eq__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
  <span class="c1"># {{{</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">NamedAxis</span><span class="p">:</span> <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># Check the names</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="k">return</span> <span class="kc">False</span>
    <span class="c1"># If the names match, check the values</span>
    <span class="k">return</span> <span class="n">Axis</span><span class="o">.</span><span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">other</span><span class="p">)</span>
  <span class="c1"># }}}</span>

  <span class="k">def</span> <span class="fm">__repr__</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="s2">&quot;&lt;</span><span class="si">%s</span><span class="s2"> &#39;</span><span class="si">%s</span><span class="s2">&#39;&gt;&quot;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

  <span class="c1"># Need more restrictions on mapping for named axes</span>
  <span class="c1"># (not only do both axes need to be a NamedAxis, but they need to have the same name)</span>
  <span class="c1"># (The name is the only way to uniquely identify them)</span>
<div class="viewcode-block" id="NamedAxis.map_to"><a class="viewcode-back" href="../../namedaxis.html#pygeode.NamedAxis.map_to">[docs]</a>  <span class="k">def</span> <span class="nf">map_to</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">NamedAxis</span><span class="p">):</span> <span class="k">return</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">Axis</span><span class="o">.</span><span class="n">map_to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span></div></div>
<span class="c1"># }}}</span>

<span class="c1"># Dummy axis (values are just placeholders).</span>
<span class="c1"># Useful when there is no intrinsic coordinate system for a dimension.</span>
<span class="c1"># Example could be a dimension in a netCDF file that has no variable</span>
<span class="c1"># associated with it.</span>
<span class="k">class</span> <span class="nc">DummyAxis</span> <span class="p">(</span><span class="n">NamedAxis</span><span class="p">):</span> <span class="k">pass</span>

<div class="viewcode-block" id="XAxis"><a class="viewcode-back" href="../../horizontalaxes.html#pygeode.XAxis">[docs]</a><span class="k">class</span> <span class="nc">XAxis</span> <span class="p">(</span><span class="n">Axis</span><span class="p">):</span>
  <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;xaxis&#39;</span></div>

<div class="viewcode-block" id="YAxis"><a class="viewcode-back" href="../../horizontalaxes.html#pygeode.YAxis">[docs]</a><span class="k">class</span> <span class="nc">YAxis</span> <span class="p">(</span><span class="n">Axis</span><span class="p">):</span>
  <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;yaxis&#39;</span></div>

<div class="viewcode-block" id="Lon"><a class="viewcode-back" href="../../horizontalaxes.html#pygeode.Lon">[docs]</a><span class="k">class</span> <span class="nc">Lon</span> <span class="p">(</span><span class="n">XAxis</span><span class="p">):</span>
<span class="c1"># {{{</span>
  <span class="sd">&#39;&#39;&#39; Longitude axis. &#39;&#39;&#39;</span>
  <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;lon&#39;</span>
  <span class="c1">#name = _config.get(&#39;Axes&#39;, &#39;Lon.name&#39;)</span>
  <span class="n">formatstr</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%.3g</span><span class="s1"> E&lt;360&#39;</span>

  <span class="n">plotatts</span> <span class="o">=</span> <span class="n">XAxis</span><span class="o">.</span><span class="n">plotatts</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
  <span class="n">plotatts</span><span class="p">[</span><span class="s1">&#39;plottitle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
  <span class="n">plotatts</span><span class="p">[</span><span class="s1">&#39;plotfmt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%.3g</span><span class="s1"> E&#39;</span>

<div class="viewcode-block" id="Lon.formatvalue"><a class="viewcode-back" href="../../horizontalaxes.html#pygeode.Lon.formatvalue">[docs]</a>  <span class="k">def</span> <span class="nf">formatvalue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">unitstr</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="c1"># {{{</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Returns formatted string representation of longitude ``value``.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    value : float or int</span>
<span class="sd">      Value to format.</span>
<span class="sd">    fmt : string (optional)</span>
<span class="sd">      Format specification; see Notes. If the default ``None`` is specified,</span>
<span class="sd">      ``self.formatstr`` is used.</span>
<span class="sd">    units : boolean (optional)</span>
<span class="sd">      If ``True``, will include the units in the string returned.</span>
<span class="sd">      Default is ``False``.</span>
<span class="sd">    unitstr : string (optional)</span>
<span class="sd">      String to use for the units; default is ``self.units``.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Formatted representation of the latitude. See notes.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    If fmt is includes the character &#39;E&#39;, the hemisphere (&#39;E&#39; or &#39;W&#39;) is</span>
<span class="sd">    appended to the string. The value is wrapped to lie between 0 and 360., and</span>
<span class="sd">    the eastern hemisphere is defined as values less than 180. Optionally, the</span>
<span class="sd">    boundary between the hemispheres can be specified by adding, for example,</span>
<span class="sd">    &#39;&lt;360&#39; after the &#39;E&#39;; in this case all values less than 360 would have &#39;E&#39;</span>
<span class="sd">    appended. Otherwise the behaviour is like :func:`Var.formatvalue`.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; from pygeode.tutorial import t1</span>
<span class="sd">    &gt;&gt;&gt; print(t1.lon.formatvalue(270))</span>
<span class="sd">    270 E</span>
<span class="sd">    &gt;&gt;&gt; print(t1.lon.formatvalue(-20.346, &#39;%.4gE&#39;))</span>
<span class="sd">    20.35W</span>
<span class="sd">    &gt;&gt;&gt; print(t1.lon.formatvalue(-192.4, &#39;%.3g&#39;))</span>
<span class="sd">    -192</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">fmt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">fmt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">formatstr</span>
    <span class="k">if</span> <span class="s1">&#39;E&#39;</span> <span class="ow">in</span> <span class="n">fmt</span><span class="p">:</span>
      <span class="n">fmt</span><span class="p">,</span> <span class="n">orig</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;E&#39;</span><span class="p">)</span>
      <span class="k">try</span><span class="p">:</span> <span class="n">orig</span> <span class="o">=</span> <span class="mf">360.</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="n">orig</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
      <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span> <span class="n">orig</span> <span class="o">=</span> <span class="mf">180.</span>

      <span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="o">+</span> <span class="n">orig</span><span class="p">)</span> <span class="o">%</span> <span class="mf">360.</span> <span class="o">-</span> <span class="n">orig</span>
      <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span> <span class="n">strval</span> <span class="o">=</span> <span class="n">fmt</span> <span class="o">%</span> <span class="n">v</span> <span class="o">+</span> <span class="s1">&#39;E&#39;</span>
      <span class="k">elif</span> <span class="n">v</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">strval</span> <span class="o">=</span> <span class="n">fmt</span> <span class="o">%</span> <span class="o">-</span><span class="n">v</span> <span class="o">+</span> <span class="s1">&#39;W&#39;</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">strval</span> <span class="o">=</span> <span class="n">fmt</span> <span class="o">%</span> <span class="n">value</span>

    <span class="k">if</span> <span class="n">units</span><span class="p">:</span>
      <span class="n">strval</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span>

    <span class="k">return</span> <span class="n">strval</span></div>
<span class="c1"># }}}</span>

<div class="viewcode-block" id="Lon.locator"><a class="viewcode-back" href="../../horizontalaxes.html#pygeode.Lon.locator">[docs]</a>  <span class="k">def</span> <span class="nf">locator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
  <span class="c1"># {{{</span>
    <span class="kn">import</span> <span class="nn">pylab</span> <span class="k">as</span> <span class="nn">pyl</span>
    <span class="k">return</span> <span class="n">pyl</span><span class="o">.</span><span class="n">MaxNLocator</span><span class="p">(</span><span class="n">nbins</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">10</span><span class="p">])</span></div></div>
  <span class="c1"># }}}</span>
<span class="c1"># }}}</span>

<div class="viewcode-block" id="regularlon"><a class="viewcode-back" href="../../horizontalaxes.html#pygeode.regularlon">[docs]</a><span class="k">def</span> <span class="nf">regularlon</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">repeat_origin</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="c1"># {{{</span>
  <span class="sd">&#39;&#39;&#39;Constructs a regularly spaced :class:`Lon` axis with n longitudes. The</span>
<span class="sd">  values range from origin to origin + 360. If repeat_origin is set to True,</span>
<span class="sd">  the final point is equal to origin + 360. &#39;&#39;&#39;</span>
  <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
  <span class="n">vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mi">360</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="n">repeat_origin</span><span class="p">)[::</span><span class="n">order</span><span class="p">]</span> <span class="o">+</span> <span class="n">origin</span>

  <span class="k">return</span> <span class="n">Lon</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span></div>
<span class="c1"># }}}</span>

<div class="viewcode-block" id="rotatelon"><a class="viewcode-back" href="../../horizontalaxes.html#pygeode.rotatelon">[docs]</a><span class="k">def</span> <span class="nf">rotatelon</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">duplicate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="c1"># {{{</span>
	<span class="sd">&#39;&#39;&#39; Rotates longitude axis to start at a new origin.</span>

<span class="sd">	Parameters</span>
<span class="sd">	----------</span>
<span class="sd">  v : :class:`Var`</span>
<span class="sd">    Variable with :class:`Lon` axis to modify</span>
<span class="sd">  origin: float</span>
<span class="sd">    New origin for longitude axis</span>
<span class="sd">  duplicate: boolean; optional</span>
<span class="sd">    If true, duplicates the origin value at the end of the axis (can be useful</span>
<span class="sd">    for plotting).  Default is ``False``.</span>

<span class="sd">  Returns</span>
<span class="sd">  -------</span>
<span class="sd">  vn : :class:`Var`</span>
<span class="sd">    Variable with modified longitude axis</span>

<span class="sd">  Examples</span>
<span class="sd">  ========</span>
<span class="sd">  &gt;&gt;&gt; import pygeode as pyg; from pygeode.tutorial import t1</span>
<span class="sd">  &gt;&gt;&gt; print(t1.Temp.lon)</span>
<span class="sd">  lon &lt;Lon&gt;      :  0 E to 354 E (60 values)</span>
<span class="sd">  &gt;&gt;&gt; print(pyg.rotatelon(t1.Temp, -180))</span>
<span class="sd">  &lt;Var &#39;Temp&#39;&gt;:</span>
<span class="sd">    Units: K  Shape:  (lat,lon)  (31,60)</span>
<span class="sd">    Axes:</span>
<span class="sd">      lat &lt;Lat&gt;      :  90 S to 90 N (31 values)</span>
<span class="sd">      lon &lt;Lon&gt;      :  180 E to 174 E (60 values)</span>
<span class="sd">    Attributes:</span>
<span class="sd">      {}</span>
<span class="sd">    Type:  SortedVar (dtype=&quot;float64&quot;)</span>
<span class="sd">  &gt;&gt;&gt; print(pyg.rotatelon(t1.Temp, 0, duplicate=True).lon[:])</span>
<span class="sd">  [  0.   6.  12.  18.  24.  30.  36.  42.  48.  54.  60.  66.  72.  78.</span>
<span class="sd">    84.  90.  96. 102. 108. 114. 120. 126. 132. 138. 144. 150. 156. 162.</span>
<span class="sd">   168. 174. 180. 186. 192. 198. 204. 210. 216. 222. 228. 234. 240. 246.</span>
<span class="sd">   252. 258. 264. 270. 276. 282. 288. 294. 300. 306. 312. 318. 324. 330.</span>
<span class="sd">   336. 342. 348. 354. 360.]</span>
<span class="sd">	&#39;&#39;&#39;</span>
	<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">concatenate</span>

	<span class="k">if</span> <span class="ow">not</span> <span class="n">v</span><span class="o">.</span><span class="n">hasaxis</span><span class="p">(</span><span class="s1">&#39;lon&#39;</span><span class="p">):</span> <span class="k">return</span> <span class="n">v</span>

	<span class="n">lons</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">lon</span><span class="p">[:]</span>
	<span class="n">o</span> <span class="o">=</span> <span class="n">origin</span> <span class="o">%</span> <span class="mi">360</span>
	<span class="n">off</span> <span class="o">=</span> <span class="n">o</span> <span class="o">-</span> <span class="n">origin</span>
	<span class="n">lp</span> <span class="o">=</span> <span class="n">Lon</span><span class="p">(</span><span class="n">values</span><span class="o">=</span><span class="p">(</span><span class="n">lons</span> <span class="o">-</span> <span class="n">o</span><span class="p">)</span> <span class="o">%</span> <span class="mi">360</span> <span class="o">+</span> <span class="n">o</span> <span class="o">-</span> <span class="n">off</span><span class="p">)</span>
	<span class="n">v0</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">replace_axes</span><span class="p">(</span><span class="n">lon</span><span class="o">=</span><span class="n">lp</span><span class="p">)</span><span class="o">.</span><span class="n">sorted</span><span class="p">(</span><span class="s1">&#39;lon&#39;</span><span class="p">)</span>

	<span class="k">if</span> <span class="n">duplicate</span><span class="p">:</span>
		<span class="n">l360</span> <span class="o">=</span> <span class="n">Lon</span><span class="p">(</span><span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">origin</span> <span class="o">+</span> <span class="mi">360</span><span class="p">])</span>
		<span class="n">v0</span> <span class="o">=</span> <span class="n">concatenate</span><span class="p">([</span><span class="n">v0</span><span class="p">,</span> <span class="n">v0</span><span class="p">(</span><span class="n">lon</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">replace_axes</span><span class="p">(</span><span class="n">lon</span> <span class="o">=</span> <span class="n">l360</span><span class="p">)])</span>

	<span class="k">return</span> <span class="n">v0</span></div>
<span class="c1"># }}}</span>


<div class="viewcode-block" id="Lat"><a class="viewcode-back" href="../../horizontalaxes.html#pygeode.Lat">[docs]</a><span class="k">class</span> <span class="nc">Lat</span> <span class="p">(</span><span class="n">YAxis</span><span class="p">):</span>
<span class="c1"># {{{</span>
  <span class="sd">&#39;&#39;&#39; Latitude axis. &#39;&#39;&#39;</span>
  <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;lat&#39;</span>
  <span class="n">formatstr</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%.2g</span><span class="s1"> N&#39;</span>
  <span class="n">plotatts</span> <span class="o">=</span> <span class="n">YAxis</span><span class="o">.</span><span class="n">plotatts</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
  <span class="n">plotatts</span><span class="p">[</span><span class="s1">&#39;plottitle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

  <span class="c1"># Make sure we get some weights</span>
<div class="viewcode-block" id="Lat.__init__"><a class="viewcode-back" href="../../horizontalaxes.html#pygeode.Lat.__init__">[docs]</a>  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
  <span class="c1"># {{{</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">cos</span><span class="p">,</span> <span class="n">asarray</span><span class="p">,</span> <span class="n">pi</span>
    <span class="c1"># Input weights are only along latitude, not area weight</span>
    <span class="c1"># Output weights are area weights</span>
    <span class="c1"># If no input weights given, assume uniform</span>
    <span class="c1">#TODO: handle non-uniform latitudes?</span>
    <span class="k">if</span> <span class="n">weights</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">weights</span> <span class="o">=</span> <span class="n">cos</span><span class="p">(</span><span class="n">asarray</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">*</span> <span class="n">pi</span> <span class="o">/</span> <span class="mf">180.</span><span class="p">)</span>

    <span class="n">Axis</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
  <span class="c1"># }}}</span>

<div class="viewcode-block" id="Lat.formatvalue"><a class="viewcode-back" href="../../horizontalaxes.html#pygeode.Lat.formatvalue">[docs]</a>  <span class="k">def</span> <span class="nf">formatvalue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">unitstr</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="c1"># {{{</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Returns formatted string representation of latitude ``value``.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    value : float or int</span>
<span class="sd">      Value to format.</span>
<span class="sd">    fmt : string (optional)</span>
<span class="sd">      Format specification; see Notes. If the default ``None`` is specified,</span>
<span class="sd">      ``self.formatstr`` is used.</span>
<span class="sd">    units : boolean (optional)</span>
<span class="sd">      If ``True``, will include the units in the string returned.</span>
<span class="sd">      Default is ``False``.</span>
<span class="sd">    unitstr : string (optional)</span>
<span class="sd">      String to use for the units; default is ``self.units``.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Formatted representation of the latitude. See notes.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    If the last character of fmt is &#39;N&#39;, then the absolute value of ``value``</span>
<span class="sd">    is formatted using the fmt[:-1] as the format specification, and the hemisphere is</span>
<span class="sd">    added, using &#39;N&#39; for values greater than 0 and &#39;S&#39; for values less than 0. The value</span>
<span class="sd">    0 is formatted as &#39;EQ&#39;. Otherwise the behaviour is like :func:`Var.formatvalue`.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; from pygeode.tutorial import t1</span>
<span class="sd">    &gt;&gt;&gt; print(t1.lat.formatvalue(0))</span>
<span class="sd">    EQ</span>
<span class="sd">    &gt;&gt;&gt; print(t1.lat.formatvalue(-43.61, &#39;%.3gN&#39;))</span>
<span class="sd">    43.6S</span>
<span class="sd">    &gt;&gt;&gt; print(t1.lat.formatvalue(-43.61, &#39;%.3g&#39;))</span>
<span class="sd">    -43.6</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="n">fmt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">fmt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">formatstr</span>
    <span class="k">if</span> <span class="n">fmt</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;N&#39;</span><span class="p">:</span>
      <span class="n">fmt</span> <span class="o">=</span> <span class="n">fmt</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
      <span class="k">if</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">strval</span> <span class="o">=</span> <span class="n">fmt</span> <span class="o">%</span> <span class="n">value</span> <span class="o">+</span> <span class="s1">&#39;N&#39;</span>
      <span class="k">elif</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">strval</span> <span class="o">=</span> <span class="n">fmt</span> <span class="o">%</span> <span class="o">-</span><span class="n">value</span> <span class="o">+</span> <span class="s1">&#39;S&#39;</span>
      <span class="k">else</span><span class="p">:</span> <span class="n">strval</span> <span class="o">=</span> <span class="s1">&#39;EQ&#39;</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">strval</span> <span class="o">=</span> <span class="n">fmt</span> <span class="o">%</span> <span class="n">value</span>

    <span class="k">if</span> <span class="n">units</span><span class="p">:</span>
      <span class="n">strval</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span>

    <span class="k">return</span> <span class="n">strval</span></div>
<span class="c1"># }}}</span>

<div class="viewcode-block" id="Lat.locator"><a class="viewcode-back" href="../../horizontalaxes.html#pygeode.Lat.locator">[docs]</a>  <span class="k">def</span> <span class="nf">locator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
  <span class="c1"># {{{</span>
    <span class="kn">import</span> <span class="nn">pylab</span> <span class="k">as</span> <span class="nn">pyl</span>
    <span class="k">return</span> <span class="n">pyl</span><span class="o">.</span><span class="n">MaxNLocator</span><span class="p">(</span><span class="n">nbins</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">])</span></div></div>
  <span class="c1"># }}}</span>
<span class="c1"># }}}</span>

<div class="viewcode-block" id="gausslat"><a class="viewcode-back" href="../../horizontalaxes.html#pygeode.gausslat">[docs]</a><span class="k">def</span> <span class="nf">gausslat</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">axis_dict</span><span class="o">=</span><span class="p">{}):</span>
<span class="c1"># {{{</span>
  <span class="sd">&#39;&#39;&#39;Constructs a Gaussian :class:`Lat` axis with n latitudes.&#39;&#39;&#39;</span>
  <span class="kn">from</span> <span class="nn">pygeode.quadrulepy</span> <span class="kn">import</span> <span class="n">legendre_compute</span>
  <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
  <span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">pi</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">order</span><span class="p">)</span> <span class="ow">in</span> <span class="n">axis_dict</span><span class="p">:</span> <span class="k">return</span> <span class="n">axis_dict</span><span class="p">[(</span><span class="n">n</span><span class="p">,</span><span class="n">order</span><span class="p">)]</span>
  <span class="n">x</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">legendre_compute</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
  <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">/</span> <span class="n">pi</span> <span class="o">*</span> <span class="mi">180</span>

  <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[::</span><span class="n">order</span><span class="p">]</span>
  <span class="n">w</span> <span class="o">=</span> <span class="n">w</span><span class="p">[::</span><span class="n">order</span><span class="p">]</span>

  <span class="n">axis</span> <span class="o">=</span> <span class="n">Lat</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>
  <span class="n">axis_dict</span><span class="p">[(</span><span class="n">n</span><span class="p">,</span><span class="n">order</span><span class="p">)]</span> <span class="o">=</span> <span class="n">axis</span>
  <span class="k">return</span> <span class="n">axis</span></div>
<span class="c1"># }}}</span>

<div class="viewcode-block" id="regularlat"><a class="viewcode-back" href="../../horizontalaxes.html#pygeode.regularlat">[docs]</a><span class="k">def</span> <span class="nf">regularlat</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inc_poles</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="c1"># {{{</span>
  <span class="sd">&#39;&#39;&#39;Constructs a regularly spaced :class:`Lat` axis with n latitudes.</span>
<span class="sd">  If inc_poles is set to True, the grid includes the poles. &#39;&#39;&#39;</span>
  <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
  <span class="k">if</span> <span class="n">inc_poles</span><span class="p">:</span> <span class="n">vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="n">n</span><span class="p">)[::</span><span class="n">order</span><span class="p">]</span>
  <span class="k">else</span><span class="p">:</span> <span class="n">vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="n">n</span><span class="o">+</span><span class="mi">2</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">][::</span><span class="n">order</span><span class="p">]</span>

  <span class="k">return</span> <span class="n">Lat</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span></div>
<span class="c1"># }}}</span>

<span class="c1"># Spectral axes</span>
<span class="c1"># Note: XAxis/YAxis is used by cccma code to put these in the proper order (XAxis is fastest-increasing)</span>
<span class="k">class</span> <span class="nc">SpectralM</span><span class="p">(</span><span class="n">YAxis</span><span class="p">):</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;m&#39;</span>
<span class="k">class</span> <span class="nc">SpectralN</span><span class="p">(</span><span class="n">XAxis</span><span class="p">):</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;n&#39;</span>

<span class="c1"># Vertical axes</span>
<div class="viewcode-block" id="ZAxis"><a class="viewcode-back" href="../../verticalaxes.html#pygeode.ZAxis">[docs]</a><span class="k">class</span> <span class="nc">ZAxis</span> <span class="p">(</span><span class="n">Axis</span><span class="p">):</span>
<span class="c1"># {{{</span>
  <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;lev&#39;</span>
  <span class="n">formatstr</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%3g</span><span class="s1">&#39;</span></div>
<span class="c1"># }}}</span>

<span class="c1"># Geometric height</span>
<span class="c1">#TODO: weights</span>
<span class="c1">#TODO: attributes</span>
<div class="viewcode-block" id="Height"><a class="viewcode-back" href="../../verticalaxes.html#pygeode.Height">[docs]</a><span class="k">class</span> <span class="nc">Height</span><span class="p">(</span><span class="n">ZAxis</span><span class="p">):</span>
<span class="c1"># {{{</span>
  <span class="sd">&#39;&#39;&#39; Geometric height axis. &#39;&#39;&#39;</span>
  <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;z&#39;</span> <span class="c1"># default name</span>
  <span class="n">formatstr</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">&#39;</span>
  <span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;m&#39;</span>
  <span class="n">plotatts</span> <span class="o">=</span> <span class="n">ZAxis</span><span class="o">.</span><span class="n">plotatts</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
  <span class="n">plotatts</span><span class="p">[</span><span class="s1">&#39;plotname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Height&#39;</span> <span class="c1"># name displayed in plots (axis label)</span></div>
<span class="c1"># }}}</span>

<span class="c1"># Model hybrid levels</span>
<span class="c1">#TODO: weights!</span>
<div class="viewcode-block" id="Hybrid"><a class="viewcode-back" href="../../verticalaxes.html#pygeode.Hybrid">[docs]</a><span class="k">class</span> <span class="nc">Hybrid</span> <span class="p">(</span><span class="n">ZAxis</span><span class="p">):</span>
<span class="c1"># {{{</span>
  <span class="sd">&#39;&#39;&#39; Hybridized vertical coordinate axis. &#39;&#39;&#39;</span>
  <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;eta&#39;</span>  <span class="c1">#TODO: rename this to &#39;hybrid&#39;?  (keep &#39;eta&#39; for now, for compatibility with existing code)</span>
  <span class="n">formatstr</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%g</span><span class="s1">&#39;</span>
  <span class="n">plotatts</span> <span class="o">=</span> <span class="n">ZAxis</span><span class="o">.</span><span class="n">plotatts</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
  <span class="n">plotatts</span><span class="p">[</span><span class="s1">&#39;plotorder&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
  <span class="n">plotatts</span><span class="p">[</span><span class="s1">&#39;plotscale&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;log&#39;</span>

<div class="viewcode-block" id="Hybrid.__init__"><a class="viewcode-back" href="../../verticalaxes.html#pygeode.Hybrid.__init__">[docs]</a>  <span class="k">def</span> <span class="fm">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
  <span class="c1"># {{{</span>
    <span class="c1"># Just pass all the stuff to the superclass</span>
    <span class="c1"># (All we do here is enforce the existence of &#39;A&#39; and &#39;B&#39; associated arrays</span>
    <span class="n">ZAxis</span><span class="o">.</span><span class="fm">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">A</span><span class="o">=</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="o">=</span><span class="n">B</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
  <span class="c1"># }}}</span>

  <span class="k">def</span> <span class="fm">__eq__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
  <span class="c1"># {{{</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ZAxis</span><span class="o">.</span><span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span> <span class="k">return</span> <span class="kc">False</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">allclose</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">allclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">A</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">A</span><span class="p">):</span> <span class="k">return</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">allclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">B</span><span class="p">):</span> <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="kc">True</span>
  <span class="c1"># }}}</span>

<div class="viewcode-block" id="Hybrid.locator"><a class="viewcode-back" href="../../verticalaxes.html#pygeode.Hybrid.locator">[docs]</a>  <span class="k">def</span> <span class="nf">locator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">pylab</span> <span class="k">as</span> <span class="nn">pyl</span><span class="o">,</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
    <span class="n">ndecs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">ndecs</span> <span class="o">&lt;</span> <span class="mf">1.2</span><span class="p">:</span> <span class="k">return</span> <span class="n">pyl</span><span class="o">.</span><span class="n">LogLocator</span><span class="p">(</span><span class="n">subs</span><span class="o">=</span><span class="p">[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">2.</span><span class="p">,</span> <span class="mf">4.</span><span class="p">,</span> <span class="mf">7.</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">ndecs</span> <span class="o">&lt;</span> <span class="mf">3.</span><span class="p">:</span> <span class="k">return</span> <span class="n">pyl</span><span class="o">.</span><span class="n">LogLocator</span><span class="p">(</span><span class="n">subs</span><span class="o">=</span><span class="p">[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">3.</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="n">pyl</span><span class="o">.</span><span class="n">LogLocator</span><span class="p">()</span></div></div>
<span class="c1"># }}}</span>

<div class="viewcode-block" id="Pres"><a class="viewcode-back" href="../../verticalaxes.html#pygeode.Pres">[docs]</a><span class="k">class</span> <span class="nc">Pres</span> <span class="p">(</span><span class="n">ZAxis</span><span class="p">):</span>
<span class="c1"># {{{</span>
  <span class="sd">&#39;&#39;&#39; Pressure height axis. &#39;&#39;&#39;</span>
  <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;pres&#39;</span>
  <span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;hPa&#39;</span>
  <span class="n">formatstr</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%.2g</span><span class="s1">&lt;100&#39;</span>
  <span class="n">plotatts</span> <span class="o">=</span> <span class="n">ZAxis</span><span class="o">.</span><span class="n">plotatts</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
  <span class="n">plotatts</span><span class="p">[</span><span class="s1">&#39;plotname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Pressure&#39;</span>
  <span class="n">plotatts</span><span class="p">[</span><span class="s1">&#39;plotscale&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;log&#39;</span>
  <span class="n">plotatts</span><span class="p">[</span><span class="s1">&#39;plotorder&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

<div class="viewcode-block" id="Pres.logPAxis"><a class="viewcode-back" href="../../verticalaxes.html#pygeode.Pres.logPAxis">[docs]</a>  <span class="k">def</span> <span class="nf">logPAxis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p0</span><span class="o">=</span><span class="mf">1000.</span><span class="p">,</span> <span class="n">H</span><span class="o">=</span><span class="mf">7.1</span><span class="p">):</span>
<span class="c1"># {{{</span>
    <span class="sd">&#39;&#39;&#39;logPAxis(p0, H) - returns a pygeode axis with log pressure heights</span>
<span class="sd">          corresponding to this axis. By default p0 = 1000 hPa and H = 7.1 (km).&#39;&#39;&#39;</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">ZAxis</span><span class="p">(</span><span class="n">H</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">p0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
    <span class="n">z</span><span class="o">.</span><span class="n">plotatts</span><span class="p">[</span><span class="s1">&#39;plotname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Log-p Height&#39;</span>
    <span class="k">return</span> <span class="n">z</span></div>
<span class="c1"># }}}</span>

<div class="viewcode-block" id="Pres.locator"><a class="viewcode-back" href="../../verticalaxes.html#pygeode.Pres.locator">[docs]</a>  <span class="k">def</span> <span class="nf">locator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="c1"># {{{</span>
    <span class="kn">import</span> <span class="nn">pylab</span> <span class="k">as</span> <span class="nn">pyl</span><span class="o">,</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
    <span class="n">numdecs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">numdecs</span> <span class="o">&lt;</span> <span class="mf">1.2</span><span class="p">:</span> <span class="n">subs</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">2.</span><span class="p">,</span> <span class="mf">4.</span><span class="p">,</span> <span class="mf">7.</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">numdecs</span> <span class="o">&lt;</span> <span class="mf">3.</span><span class="p">:</span> <span class="n">subs</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">3.</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span> <span class="n">subs</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">pyl</span><span class="o">.</span><span class="n">LogLocator</span><span class="p">(</span><span class="n">subs</span> <span class="o">=</span> <span class="n">subs</span><span class="p">,</span> <span class="n">numdecs</span> <span class="o">=</span> <span class="n">numdecs</span><span class="p">)</span></div>
<span class="c1"># }}}</span>

<div class="viewcode-block" id="Pres.formatvalue"><a class="viewcode-back" href="../../verticalaxes.html#pygeode.Pres.formatvalue">[docs]</a>  <span class="k">def</span> <span class="nf">formatvalue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">unitstr</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="c1"># {{{</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Returns formatted string representation of pressure ``value``.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    value : float or int</span>
<span class="sd">      Value to format.</span>
<span class="sd">    fmt : string (optional)</span>
<span class="sd">      Format specification; see Notes. If the default ``None`` is specified,</span>
<span class="sd">      ``self.formatstr`` is used.</span>
<span class="sd">    units : boolean (optional)</span>
<span class="sd">      If ``True``, will include the units in the string returned.</span>
<span class="sd">      Default is ``True``.</span>
<span class="sd">    unitstr : string (optional)</span>
<span class="sd">      String to use for the units; default is ``self.units``.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Formatted representation of the pressure. See notes.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    If ``fmt`` includes the character &#39;&lt;&#39;, it is interpreted as &#39;fmt&lt;break&#39;,</span>
<span class="sd">    such that values less than float(break) are formatted using the format</span>
<span class="sd">    string fmt, while those greater than float(break) are formatted as integers.</span>
<span class="sd">    Otherwise the behaviour is like :func:`Var.formatvalue`.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; from pygeode.tutorial import t2</span>
<span class="sd">    &gt;&gt;&gt; print(t2.pres.formatvalue(1000))</span>
<span class="sd">    1000 hPa</span>
<span class="sd">    &gt;&gt;&gt; print(t2.pres.formatvalue(1.52))</span>
<span class="sd">    1.5 hPa</span>
<span class="sd">    &gt;&gt;&gt; print(t2.pres.formatvalue(20, &#39;%.1g&#39;))</span>
<span class="sd">    2e+01 hPa</span>
<span class="sd">    &gt;&gt;&gt; print(t2.pres.formatvalue(20, &#39;%.1g&lt;10&#39;))</span>
<span class="sd">    20 hPa</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="n">fmt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">fmt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">formatstr</span>
    <span class="k">if</span> <span class="s1">&#39;&lt;&#39;</span> <span class="ow">in</span> <span class="n">fmt</span><span class="p">:</span>
      <span class="n">lfmt</span><span class="p">,</span> <span class="n">brk</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&lt;&#39;</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">value</span> <span class="o">&gt;=</span> <span class="nb">float</span><span class="p">(</span><span class="n">brk</span><span class="p">):</span> <span class="n">strval</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">value</span>
      <span class="k">else</span><span class="p">:</span> <span class="n">strval</span> <span class="o">=</span> <span class="n">lfmt</span> <span class="o">%</span> <span class="n">value</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">strval</span> <span class="o">=</span> <span class="n">fmt</span> <span class="o">%</span> <span class="n">value</span>

    <span class="k">if</span> <span class="n">units</span><span class="p">:</span>
      <span class="n">strval</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span>

    <span class="k">return</span> <span class="n">strval</span></div></div>
<span class="c1"># }}}</span>
<span class="c1"># }}}</span>

<div class="viewcode-block" id="TAxis"><a class="viewcode-back" href="../../timeaxes.html#pygeode.TAxis">[docs]</a><span class="k">class</span> <span class="nc">TAxis</span><span class="p">(</span><span class="n">Axis</span><span class="p">):</span> <span class="k">pass</span></div>
<span class="c1"># NOTE: Time axis is in pygeode.timeaxis</span>
<span class="c1"># It&#39;s a fairly heavyweight class, worthy of its own module.</span>
<span class="c1"># Importing it here would create a circular reference that would bugger things up</span>


<span class="k">class</span> <span class="nc">Freq</span><span class="p">(</span><span class="n">Axis</span><span class="p">):</span>
<span class="c1"># {{{</span>
  <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;freq&#39;</span>
<span class="c1">#  plotscale = &#39;log&#39;</span>
  <span class="k">def</span> <span class="fm">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">inv_units</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">inv_units</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">inv_units</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">plotatts</span><span class="p">[</span><span class="s1">&#39;plottitle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Frequency (per </span><span class="si">%s</span><span class="s1">)&#39;</span><span class="o">%</span><span class="n">inv_units</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;inv_units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">inv_units</span>
    <span class="n">Axis</span><span class="o">.</span><span class="fm">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="c1"># }}}</span>

<span class="c1"># Indexing arrays (represent discrete items, such as EOF number, ensemble number, etc.)</span>
<span class="k">class</span> <span class="nc">Index</span><span class="p">(</span><span class="n">Axis</span><span class="p">):</span>
<span class="c1"># {{{</span>
  <span class="k">def</span> <span class="fm">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">values</span> <span class="o">=</span> <span class="n">n</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="s1">&#39;__len__&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
    <span class="n">Axis</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="c1"># }}}</span>

<span class="c1"># Coefficient number (when returning a set of coefficients, such as for a polynomial fit)</span>
<span class="k">class</span> <span class="nc">Coef</span><span class="p">(</span><span class="n">Index</span><span class="p">):</span> <span class="k">pass</span>

<div class="viewcode-block" id="NonCoordinateAxis"><a class="viewcode-back" href="../../namedaxis.html#pygeode.NonCoordinateAxis">[docs]</a><span class="k">class</span> <span class="nc">NonCoordinateAxis</span><span class="p">(</span><span class="n">Axis</span><span class="p">):</span>
<span class="c1"># {{{</span>
  <span class="sd">&#39;&#39;&#39;Non-coordinate axis (disables nearest-neighbour value matching, etc.)&#39;&#39;&#39;</span>
  <span class="c1"># Refresh the coordinate values (should always be monotonically increasing integers).</span>
<div class="viewcode-block" id="NonCoordinateAxis.__init__"><a class="viewcode-back" href="../../namedaxis.html#pygeode.NonCoordinateAxis.__init__">[docs]</a>  <span class="k">def</span> <span class="fm">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="c1"># {{{</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
    <span class="n">lengths</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">kw</span><span class="p">)</span> <span class="k">for</span> <span class="n">kw</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kw</span><span class="p">,(</span><span class="nb">list</span><span class="p">,</span><span class="nb">tuple</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">))]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lengths</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unable to determine a length for the non-coordinate axis.&quot;</span><span class="p">)</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">lengths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;values&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
    <span class="n">Axis</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="c1"># Remember original name</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span></div>
<span class="c1"># }}}</span>

  <span class="c1"># Modify test for equality to look for an exact match</span>
  <span class="c1">#TODO: Make the default Axis.__eq__ logic do this, and move the &quot;close&quot;</span>
  <span class="c1"># matching to a subclass of Axis.</span>
<div class="viewcode-block" id="NonCoordinateAxis.__eq__"><a class="viewcode-back" href="../../namedaxis.html#pygeode.NonCoordinateAxis.__eq__">[docs]</a>  <span class="k">def</span> <span class="fm">__eq__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
<span class="c1"># {{{</span>
    <span class="c1"># For simplicity, expect them to be the same type of axis.</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">type</span><span class="p">(</span><span class="n">other</span><span class="p">):</span> <span class="k">return</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">auxarrays</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">!=</span> <span class="nb">set</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">auxarrays</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span> <span class="k">return</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">auxarrays</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
      <span class="k">if</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">auxarrays</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="o">!=</span> <span class="nb">list</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">auxarrays</span><span class="p">[</span><span class="n">k</span><span class="p">]):</span> <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="kc">True</span></div>
<span class="c1"># }}}</span>

  <span class="c1"># How to map string values to dummy indices</span>
<div class="viewcode-block" id="NonCoordinateAxis.str_as_val"><a class="viewcode-back" href="../../namedaxis.html#pygeode.NonCoordinateAxis.str_as_val">[docs]</a>  <span class="k">def</span> <span class="nf">str_as_val</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
<span class="c1"># {{{</span>
    <span class="c1"># Special case: referencing an aux array with the same name as the axis.</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">auxarrays</span><span class="p">:</span>
      <span class="n">values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">auxarrays</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">])</span>
      <span class="k">if</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">values</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="c1"># Otherwise, return an invalid index (no match)</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span></div>
<span class="c1"># }}}</span>

  <span class="c1"># Modify formatvalue to convert dummy indices to the appropriate values</span>
<div class="viewcode-block" id="NonCoordinateAxis.formatvalue"><a class="viewcode-back" href="../../namedaxis.html#pygeode.NonCoordinateAxis.formatvalue">[docs]</a>  <span class="k">def</span> <span class="nf">formatvalue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">unitstr</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="c1"># {{{</span>
    <span class="c1"># Check if the value is in range.</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">))):</span>
      <span class="k">return</span> <span class="s2">&quot;?</span><span class="si">%s</span><span class="s2">?&quot;</span><span class="o">%</span><span class="n">value</span>
    <span class="c1"># Check if we have a special aux array with the same name as the axis.</span>
    <span class="c1"># In this case, use those values as the string.</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">auxarrays</span><span class="p">:</span>
      <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">auxarrays</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">][</span><span class="n">value</span><span class="p">])</span>
    <span class="c1"># Otherwise, return all the key/value pairs for all aux arrays.</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span><span class="o">+</span><span class="s2">&quot;=&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">array</span><span class="p">[</span><span class="n">value</span><span class="p">])</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span><span class="n">array</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">auxarrays</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
    <span class="n">out</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
    <span class="k">return</span> <span class="s2">&quot;(&quot;</span><span class="o">+</span><span class="n">out</span><span class="o">+</span><span class="s2">&quot;)&quot;</span></div>
<span class="c1"># }}}</span>

  <span class="c1"># Modify map_to do use exact matching.</span>
  <span class="c1"># (Avoids use of tools.map_to, which assumes the values are numerical)</span>
  <span class="c1">#TODO: Make this the default for Axis (don&#39;t assume we have numerical values?)</span>
<div class="viewcode-block" id="NonCoordinateAxis.map_to"><a class="viewcode-back" href="../../namedaxis.html#pygeode.NonCoordinateAxis.map_to">[docs]</a>  <span class="k">def</span> <span class="nf">map_to</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
<span class="c1"># {{{</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
    <span class="c1"># Only allow mapping non-coordinate axes if they&#39;re the exact same type.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)):</span> <span class="k">return</span> <span class="kc">None</span>
    <span class="c1"># Get keys to use for comparing aux arrays</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">auxarrays</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">auxarrays</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
    <span class="n">values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">auxarrays</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">]))</span>
    <span class="n">other_values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">other</span><span class="o">.</span><span class="n">auxarrays</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">]))</span>
    <span class="c1">#TODO: Speed this up? (move this to tools.c?)</span>
    <span class="n">values_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">other_values</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">v</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">values_set</span><span class="p">:</span> <span class="k">continue</span>
      <span class="n">indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">indices</span></div></div>
<span class="c1"># }}}</span>
<span class="c1"># }}}</span>

<span class="k">class</span> <span class="nc">Station</span><span class="p">(</span><span class="n">NonCoordinateAxis</span><span class="p">):</span>
<span class="c1"># {{{</span>
  <span class="sd">&#39;&#39;&#39;Station axis (for timeseries data at fixed station locations)&#39;&#39;&#39;</span>
  <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;station&quot;</span>
<span class="c1"># }}}</span>

<span class="c1"># Concatenate a bunch of axes together.</span>
<span class="c1"># Find a common parent class for all of them, and call that class&#39;s concat function.</span>
<span class="k">def</span> <span class="nf">concat</span> <span class="p">(</span><span class="n">axes</span><span class="p">):</span>
<span class="c1"># {{{</span>
  <span class="n">axes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">axes</span><span class="p">)</span> <span class="c1"># in case we&#39;re given a set, generator, etc.</span>
  <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;nothing to concatenate!&#39;</span>
  <span class="c1"># Degenerate case: only 1 axis provided</span>
  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="k">return</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

  <span class="bp">cls</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
  <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">:</span>
    <span class="n">cls2</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">cls2</span><span class="p">):</span> <span class="bp">cls</span> <span class="o">=</span> <span class="n">cls2</span>
    <span class="k">assert</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">cls2</span><span class="p">,</span> <span class="bp">cls</span><span class="p">),</span> <span class="s2">&quot;can&#39;t concatenate incompatible axes&quot;</span>
  <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">axes</span><span class="p">)</span>
<span class="c1"># }}}</span>


<span class="c1"># List of axes provided in this module (for easy importing)</span>
<span class="n">standard_axes</span> <span class="o">=</span> <span class="p">[</span><span class="n">Axis</span><span class="p">,</span> <span class="n">NamedAxis</span><span class="p">,</span> <span class="n">XAxis</span><span class="p">,</span> <span class="n">YAxis</span><span class="p">,</span> <span class="n">ZAxis</span><span class="p">,</span> <span class="n">TAxis</span><span class="p">,</span> <span class="n">Lon</span><span class="p">,</span> <span class="n">NonCoordinateAxis</span><span class="p">,</span> <span class="n">regularlon</span><span class="p">,</span> <span class="n">rotatelon</span><span class="p">,</span> <span class="n">Lat</span><span class="p">,</span> <span class="n">gausslat</span><span class="p">,</span> <span class="n">regularlat</span><span class="p">,</span> <span class="n">Pres</span><span class="p">,</span> <span class="n">Hybrid</span><span class="p">,</span> <span class="n">Height</span><span class="p">,</span> <span class="n">SpectralM</span><span class="p">,</span> <span class="n">SpectralN</span><span class="p">,</span> <span class="n">Freq</span><span class="p">,</span> <span class="n">Index</span><span class="p">]</span>
</pre></div>

      </div>
      <div class="bottomnav" role="navigation" aria-label="bottom navigation">
      
        <p>
        <a class="uplink" href="../../reference.html">Reference</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../../tutorial.html">Tutorial</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../../gallery/index.html">Gallery</a>
        </p>

      </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2018, Mike Neish, Peter Hitchcock.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.4.
    </div>
  </body>
</html>